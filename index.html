<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker - Sistema de Alto Rendimiento</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Tu configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAI6H-s2ntsWX9bEKk-0quMvSnhfI5S-Hs",
            authDomain: "tracker-83386.firebaseapp.com",
            projectId: "tracker-83386",
            storageBucket: "tracker-83386.firebasestorage.app",
            messagingSenderId: "101647535499",
            appId: "1:101647535499:web:86af6f84e232deb7a3338e",
            measurementId: "G-KJ1MS3ZXKG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Habilitar persistencia offline
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Persistencia fallida: m√∫ltiples pesta√±as abiertas');
            } else if (err.code == 'unimplemented') {
                console.log('Persistencia no soportada en este navegador');
            }
        });
        
        // Exponer db globalmente para el resto del c√≥digo
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseOnSnapshot = onSnapshot;
        
        console.log('‚úÖ Firebase inicializado correctamente');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Playfair+Display:wght@700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0A1628;
            --bg-secondary: #152238;
            --bg-tertiary: #1E2F45;
            --bg-card: #1A2332;
            --border-color: #2D3E54;
            --border-light: #374151;
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --text-ghost: #475569;
            --accent-blue: #3B82F6;
            --accent-blue-dark: #2563EB;
            --accent-blue-hover: #1D4ED8;
            --accent-cyan: #06B6D4;
            --accent-green: #10B981;
            --accent-yellow: #FBBF24;
            --accent-red: #EF4444;
            --accent-purple: #8B5CF6;
            --sidebar-bg: #0F172A;
            --sidebar-hover: rgba(59, 130, 246, 0.1);
            --sidebar-active: rgba(59, 130, 246, 0.15);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }
        
        .header {
            background: var(--bg-card);
            padding: 20px 40px;
            box-shadow: 0 1px 0 var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text h1 {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            color: var(--text-primary);
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: 800;
        }
        
        .logo-text p {
            font-size: 11px;
            color: var(--accent-cyan);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .sync-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sync-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .sync-btn.syncing {
            animation: pulse 1.5s infinite;
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }
        
        .connection-status.online {
            color: var(--accent-green);
        }
        
        .connection-status.offline {
            color: var(--accent-yellow);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .nav-tab {
            padding: 12px 24px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nav-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }
        
        .nav-tab:hover:not(.active) {
            background: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .content {
            padding: 32px 40px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            color: var(--text-primary);
            text-transform: capitalize;
            letter-spacing: 0px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        .btn {
            padding: 14px 28px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:hover {
            background: var(--accent-blue-dark);
            border-color: var(--accent-blue-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 11px;
        }
        
        .training-day-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .training-day-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }
        
        .training-day-card h3 {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .training-day-card p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .training-day-badge {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .delete-day-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .training-day-card:hover .delete-day-btn {
            opacity: 1;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .student-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .student-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }
        
        .student-name {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .student-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .student-goal {
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 700;
            margin-top: 12px;
        }
        
        .block {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .block-title {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--text-primary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .block-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .block-type-movilidad .block-icon { background: #FEF3C7; }
        .block-type-core .block-icon { background: #FED7AA; }
        .block-type-fuerza-inferior .block-icon { background: #DBEAFE; }
        .block-type-fuerza-superior .block-icon { background: #F3E8FF; }
        
        .exercise {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .exercise-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .exercise-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .exercise-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .exercise-input-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .exercise-input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .exercise-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            color: var(--text-primary);
            text-transform: uppercase;
            margin-bottom: 24px;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            padding: 24px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .loading.active {
            display: block;
        }
        
        .config-banner {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #FCD34D;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .config-banner.configured {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-color: #6EE7B7;
        }
        
        .config-icon {
            font-size: 32px;
        }
        
        .config-text h3 {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .config-text p {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        
        .month-comparison {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .month-box {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        
        .month-box.current {
            background: var(--accent-blue);
            color: white;
        }
        
        .month-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .month-value {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
        }
        
        .attendance-section {
            margin-bottom: 32px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .attendance-title {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            text-transform: uppercase;
        }
        
        .goal-progress-bar {
            width: 100%;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            transition: width 0.3s;
        }
        
        .progress-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .progress-table th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .progress-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        @media (max-width: 768px) {
            .app-container { padding: 0; }
            .header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
            .logo-section { flex: 1 1 100%; justify-content: center; }
            .nav-tabs { flex: 1 1 100%; justify-content: center; flex-wrap: wrap; gap: 4px; padding: 4px; }
            .nav-tab { font-size: 11px; padding: 8px 12px; flex: 1; min-width: 80px; }
            .main-content { padding: 16px; }
            .students-grid { grid-template-columns: 1fr !important; gap: 12px; }
            .student-card { padding: 16px; }
            .student-name { font-size: 18px; }
            .metrics-grid { grid-template-columns: 1fr 1fr !important; gap: 12px; }
            .metric-card { padding: 16px; }
            .metric-value { font-size: 24px; }
            .training-days-grid { grid-template-columns: 1fr !important; }
            .form-input, .form-select { font-size: 16px; }
            .modal-content { width: 95%; max-width: 95%; margin: 20px auto; max-height: 90vh; overflow-y: auto; padding: 20px; }
            button, .btn { min-height: 44px; font-size: 14px; }
            .progress-table { font-size: 12px; display: block; overflow-x: auto; }
            .progress-table th, .progress-table td { padding: 8px 4px; white-space: nowrap; }
            .month-comparison { display: none; }
            .card { padding: 16px; margin-bottom: 16px; }
            .attendance-section { padding: 12px; }
            .config-banner { font-size: 12px; padding: 12px; flex-direction: column; text-align: center; }
            #searchStudent { width: 100%; max-width: 100% !important; }
            .training-day-card { min-height: auto; padding: 16px; }
            .block { margin-bottom: 16px; padding: 16px; }
            .block-header { padding: 0; flex-wrap: wrap; gap: 8px; }
            .exercise-inputs { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
            .exercise-input { font-size: 16px; min-height: 44px; }
        }
        
        @media (hover: none) and (pointer: coarse) {
            button, .btn { min-height: 48px; padding: 12px 20px; }
            .student-card { min-height: 100px; }
            .nav-tab { min-height: 48px; }
        }
        
        .gamification-card {
            background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue));
            border-radius: 16px;
            padding: 32px;
            color: white;
            margin-bottom: 24px;
            border: none;
        }
        
        .level-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .level-badge-large {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 800;
            backdrop-filter: blur(10px);
        }
        
        .xp-info {
            flex: 1;
            margin-left: 24px;
        }
        
        .xp-value {
            font-size: 32px;
            font-weight: 800;
        }
        
        .xp-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .xp-progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .xp-progress-fill {
            background: var(--accent-cyan);
            height: 100%;
            transition: width 0.3s;
        }
        
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .badge-item {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .badge-icon-large {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .badge-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .text-center { text-align: center; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon" id="appLogo"></div>
                <div class="logo-text">
                    <h1>TRACKER</h1>
                    <p>Precision Engineered</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="connection-status" id="connectionStatus">
                    <span id="statusDot">‚ö™</span>
                    <span id="statusText">Conectando...</span>
                </div>
                <button class="sync-btn" id="syncBtn" onclick="forceSyncAll()">
                    üîÑ Sincronizar
                </button>
                <nav class="nav-tabs" id="mainNav">
                    <button class="nav-tab active" onclick="switchView('alumnos', this)">
                        üë• ATLETAS
                    </button>
                    <button class="nav-tab" onclick="switchView('dashboard', this)">
                        üìä M√âTRICAS
                    </button>
                    <button class="nav-tab" onclick="switchView('plan', this)">
                        üìã PLAN
                    </button>
                    <button class="nav-tab" onclick="switchView('config', this)">
                        ‚öôÔ∏è CONFIG
                    </button>
                </nav>
            </div>
        </div>

        <div class="loading" id="loading">Cargando...</div>

        <!-- VIEW: ALUMNOS -->
        <div id="view-alumnos" class="view active content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Atletas</h2>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="searchStudent" class="form-input" placeholder="üîç Buscar atleta..." 
                               style="max-width: 300px; margin: 0;" onkeyup="filterStudents()" />
                        <button class="btn btn-secondary btn-sm" type="button" id="btnOpenImportCSV">üì• Importar Completo (CSV)</button>
                        <button class="btn btn-primary" onclick="openModal('addStudent')">
                            ‚ûï Nuevo Atleta
                        </button>
                    </div>
                </div>
                <div id="studentsContainer" class="students-grid"></div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìä M√âTRICAS DE <span id="dashboardStudentName" style="color: var(--accent-blue);">-</span>
                    </h2>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê Mes Anterior</button>
                        <span id="currentMonthDisplay" style="font-size: 14px; font-weight: 700; color: var(--text-secondary); min-width: 150px; text-align: center;">-</span>
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Mes Siguiente ‚Üí</button>
                    </div>
                </div>

                <div id="dashboardContent">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        Seleccion√° un atleta para ver sus m√©tricas
                    </p>
                </div>
            </div>
        </div>

        <!-- VIEW: PLAN -->
        <div id="view-plan" class="view content">
            <div class="card" id="planDaysCard">
                <div class="card-header">
                    <h2 class="card-title">üìã Plan de <span id="currentStudentName">-</span></h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="openModal('importPlan')">
                            üì• Importar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportAllDays()">
                            üì§ Exportar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="switchView('alumnos', document.querySelector('[onclick*=\'alumnos\']'))">‚Üê Volver</button>
                    </div>
                </div>
                
                <div id="trainingDaysList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addTrainingDay')">
                    ‚ûï Agregar D√≠a de Entrenamiento
                </button>
            </div>

            <div class="card" id="currentDayView" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        üèãÔ∏è <span id="currentDayTitle">-</span>
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="closeDayView()">‚Üê Volver a D√≠as</button>
                        <button class="btn btn-primary btn-sm" onclick="saveSession()">üíæ Guardar Sesi√≥n</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 32px; display: grid; grid-template-columns: 1fr 180px; gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">üìÖ Fecha Sesi√≥n</label>
                        <input type="date" id="sessionDate" class="form-input" />
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">‚öñÔ∏è Peso Corporal (kg)</label>
                        <input type="number" id="bodyWeight" class="form-input" placeholder="75" step="0.1" />
                    </div>
                </div>

                <div id="blocksContainer"></div>

                <button class="btn btn-secondary" onclick="openModal('addBlock')" style="margin-top: 24px;">
                    ‚ûï Agregar Bloque
                </button>
            </div>
        </div>

        <!-- VIEW: CONFIG -->
        <div id="view-config" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Configuraci√≥n</h2>
                </div>

                <div id="configBanner" class="config-banner configured">
                    <div class="config-icon">‚úÖ</div>
                    <div class="config-text">
                        <h3>Conectado a Firebase</h3>
                        <p>Los datos se sincronizan autom√°ticamente en tiempo real</p>
                    </div>
                </div>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">üì± Sincronizaci√≥n</h4>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        ‚úÖ La app est√° conectada a Firebase<br>
                        ‚úÖ Los datos se guardan autom√°ticamente<br>
                        ‚úÖ Funciona offline y sincroniza cuando hay conexi√≥n<br>
                        ‚úÖ Accesible desde cualquier dispositivo
                    </p>
                </div>

                <button class="btn btn-secondary" onclick="forceSyncAll()" style="margin-bottom: 12px;">
                    üîÑ Sincronizar Ahora (Forzar)
                </button>

                <button class="btn btn-secondary" onclick="clearLocalData()" style="background: var(--danger); color: white; border-color: var(--danger);">
                    üóëÔ∏è Borrar Datos Locales (Cuidado)
                </button>

                <hr style="margin: 40px 0; border: none; border-top: 2px solid var(--border-color);">

                <h3 style="font-family: 'Inter'; font-size: 16px; margin-bottom: 20px; text-transform: uppercase;">üé® Personalizaci√≥n</h3>

                <div class="form-group">
                    <label class="form-label">Logo Personalizado</label>
                    <input type="file" id="logoUpload" class="form-input" accept="image/*" onchange="handleLogoUpload(event)" />
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        Recomendado: PNG con fondo transparente, 200x200px
                    </div>
                </div>

                <div id="logoPreview" style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                    <img id="logoPreviewImg" style="max-width: 100px; height: auto; display: block; margin-bottom: 12px;" />
                    <button class="btn btn-secondary btn-sm" onclick="removeLogo()">üóëÔ∏è Eliminar Logo</button>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="modal-addStudent" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Atleta</h3>
                <form onsubmit="addStudent(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="studentName" class="form-input" required />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" id="studentAge" class="form-input" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="studentWeight" class="form-input" required step="0.1" min="1" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <input type="text" id="studentGoal" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clases Mensuales</label>
                        <input type="number" id="studentClasses" class="form-input" required min="1" />
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear Atleta</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudent')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-editStudent" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚úèÔ∏è Editar Atleta</h3>
                <form id="editStudentForm" onsubmit="updateStudent(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="editStudentName" class="form-input" required />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" id="editStudentAge" class="form-input" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="editStudentWeight" class="form-input" required step="0.1" min="1" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <input type="text" id="editStudentGoal" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clases Mensuales</label>
                        <input type="number" id="editStudentClasses" class="form-input" required min="1" />
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            üí° Pod√©s cambiar este n√∫mero cada mes seg√∫n la cantidad de clases que va a hacer
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Guardar Cambios</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editStudent')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addTrainingDay" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo D√≠a de Entrenamiento</h3>
                <form onsubmit="addTrainingDay(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del D√≠a</label>
                        <input type="text" id="dayName" class="form-input" placeholder="ej: D√≠a A - Tren Superior" required />
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            Ejemplos: "D√≠a A", "D√≠a 1 - Tren Superior", "Lunes - Push"
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear D√≠a</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addTrainingDay')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addBlock" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Bloque</h3>
                <form onsubmit="addBlock(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Bloque</label>
                        <input type="text" id="blockName" class="form-input" placeholder="ej: Calentamiento" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Bloque</label>
                        <select id="blockType" class="form-input" required>
                            <option value="movilidad">Movilidad</option>
                            <option value="core">Core</option>
                            <option value="fuerza-inferior">Fuerza - Tren Inferior</option>
                            <option value="fuerza-superior">Fuerza - Tren Superior</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Bloque</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBlock')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addExercise" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Ejercicio</h3>
                <form onsubmit="addExercise(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Ejercicio</label>
                        <input type="text" id="exerciseName" class="form-input" placeholder="Press de banca" required list="exercisesList" />
                        <datalist id="exercisesList"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Series</label>
                            <input type="number" id="exerciseSeries" class="form-input" placeholder="3" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Repeticiones</label>
                            <input type="text" id="exerciseReps" class="form-input" placeholder="10" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="exerciseIsPrincipal" />
                            <span style="font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Marcar como principal (tracking de PR)</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Ejercicio</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addExercise')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-importComplete" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h3 class="modal-title">üì• Importaci√≥n Completa - Alumnos + D√≠as + Planes</h3>
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">üìã Formato Requerido</h4>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                        Tu archivo CSV debe tener estas columnas:
                    </p>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 10px; overflow-x: auto; color: var(--text-primary);">
                        <strong>Alumno,Edad,Peso,Objetivo,Clases,Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importCompleteFile" class="form-input" accept=".csv" onchange="handleCompleteImport(event)" />
                </div>

                <div id="completeImportPreview" style="display: none; margin-top: 20px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">Vista Previa</h4>
                    <div style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                        <div id="completeImportPreviewBody" style="font-size: 13px;"></div>
                    </div>
                    <p id="completeImportCount" style="font-size: 13px; font-weight: 700; color: var(--accent-blue); margin-top: 12px;"></p>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processCompleteImport()" id="btnImportComplete" disabled>
                        ‚úì Importar Todo
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importComplete')">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modal-importPlan" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <h3 class="modal-title">üì• Importar D√≠as + Planes</h3>
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px; overflow-x: auto; color: var(--text-primary);">
                        <strong>Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importPlanFile" class="form-input" accept=".csv" onchange="handlePlanImport(event)" />
                </div>

                <div id="planImportPreview" style="display: none; margin-top: 20px;">
                    <div id="planImportPreviewBody"></div>
                    <p id="planImportCount" style="font-size: 13px; font-weight: 700; color: var(--accent-blue); margin-top: 12px;"></p>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processPlanImport()" id="btnImportPlan" disabled>
                        ‚úì Importar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importPlan')">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modal-newGoal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <h3 class="modal-title">üéØ Nuevo Objetivo SMART</h3>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Objetivo</label>
                  <select id="goalType" class="form-input" onchange="document.getElementById('exerciseField').style.display = this.value === 'strength' ? 'block' : 'none'">
                        <option value="volume">üìà Aumentar Volumen Mensual (toneladas)</option>
                        <option value="strength">üí™ Aumentar Fuerza en Ejercicio (kg)</option>
                        <option value="attendance">üìÖ Mejorar Asistencia (clases/mes)</option>
                        <option value="prs">üèÜ Romper Records Personales</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n del Objetivo *</label>
                    <input type="text" id="goalDesc" class="form-input" placeholder="Ej: Aumentar de 60 a 70 toneladas mensuales" />
                </div>
                
               <div id="exerciseField" class="form-group" style="display: block;">
                    <label class="form-label">Ejercicio Espec√≠fico</label>
                    <input type="text" id="goalExercise" class="form-input" placeholder="Ej: Sentadilla (opcional)" list="exercisesList" />
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Valor Objetivo *</label>
                        <input type="number" id="goalTarget" class="form-input" placeholder="70" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha L√≠mite *</label>
                        <input type="date" id="goalDeadline" class="form-input" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recompensa (opcional)</label>
                    <input type="text" id="goalReward" class="form-input" placeholder="Ej: Batido gratis, Descuento 10%, Remera" />
                </div>
                
                <div style="background: var(--bg-tertiary); border: 2px solid var(--accent-green); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <strong style="color: var(--accent-blue);">üí° Tips SMART:</strong><br>
                    <ul style="margin-top: 8px; font-size: 13px; color: var(--text-secondary); padding-left: 20px;">
                        <li><strong>Espec√≠fico:</strong> Defin√≠ claramente qu√©</li>
                        <li><strong>Medible:</strong> N√∫meros concretos</li>
                        <li><strong>Alcanzable:</strong> Realista</li>
                        <li><strong>Relevante:</strong> Alineado al objetivo</li>
                        <li><strong>Tiempo:</strong> Fecha l√≠mite</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="saveGoal()" class="btn btn-primary" style="flex: 1;">‚úÖ Crear Objetivo</button>
                    <button onclick="closeModal('newGoal')" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modal-editSession" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h3 class="modal-title">‚úèÔ∏è Editar Sesi√≥n</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div>
                        <label class="form-label">üìÖ Fecha</label>
                        <input type="date" id="editSessionDate" class="form-input" />
                    </div>
                    <div>
                        <label class="form-label">üèãÔ∏è D√≠a</label>
                        <input type="text" id="editSessionDay" class="form-input" readonly />
                    </div>
                    <div>
                        <label class="form-label">‚öñÔ∏è Peso Corporal (kg)</label>
                        <input type="number" id="editSessionBodyWeight" class="form-input" step="0.1" />
                    </div>
                </div>

                <div id="editSessionBlocks" style="max-height: 400px; overflow-y: auto;"></div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveEditedSession()">üíæ Guardar Cambios</button>
                    <button class="btn btn-secondary" onclick="closeModal('editSession')">Cancelar</button>
                    <button class="btn btn-secondary" onclick="deleteEditedSession()" style="background: var(--danger); color: white;">üóëÔ∏è Eliminar Sesi√≥n</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION & INITIALIZATION
        // ============================================
        
        let db = null;
        let studentsCollection = null;
        let unsubscribeStudents = null;
        let isOnline = navigator.onLine;
        let pendingChanges = false;
        
        // Esperar a que Firebase se inicialice
        window.addEventListener('load', async () => {
            // Esperar un momento para que el m√≥dulo de Firebase se cargue
            setTimeout(() => {
                if (window.firebaseDB) {
                    initializeFirebase();
                } else {
                    console.error('Firebase no se carg√≥ correctamente');
                    showNotification('‚ùå Error cargando Firebase', 'error');
                    loadFromLocalStorageFallback();
                }
            }, 1000);
        });
        
      function initializeFirebase() {
    try {
        db = window.firebaseDB;
        studentsCollection = window.firebaseCollection(db, 'students');
        
        console.log('‚úÖ Firebase Firestore inicializado');
        
        // Escuchar cambios en tiempo real
        setupRealtimeListener();
        
        // Detectar estado de conexi√≥n
        setupConnectionListener();
        
        // Cargar datos iniciales
        loadFromFirebase();
        
        updateConnectionStatus(true, 'Conectado');
        
        // üßπ EJECUTAR LIMPIEZA DESPU√âS DE CARGAR
        setTimeout(() => {
            cleanAllDuplicatesAndGarbage();
        }, 3000);
        
    } catch (error) {
        console.error('‚ùå Error inicializando Firebase:', error);
        showNotification('‚ùå Error de conexi√≥n', 'error');
        loadFromLocalStorageFallback();
    }
}
        
        function setupRealtimeListener() {
    if (!studentsCollection) return;
    
    unsubscribeStudents = window.firebaseOnSnapshot(studentsCollection, (snapshot) => {
        console.log('üîÑ Datos actualizados en tiempo real');
        
        const firebaseStudents = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            // ‚úÖ IGNORAR BASURA Y ELIMINADOS
            if (data && data.id && data.name && !data._deleted) {
                firebaseStudents.push(data);
            }
        });
        
        // ‚úÖ NO FUSIONAR - REEMPLAZAR DIRECTO SI VIENE DE FIREBASE
        if (firebaseStudents.length > 0) {
            // Eliminar duplicados por nombre
            const uniqueMap = new Map();
            
            firebaseStudents.forEach(s => {
                const nameLower = s.name.toLowerCase().trim();
                
                if (!uniqueMap.has(nameLower)) {
                    uniqueMap.set(nameLower, s);
                } else {
                    // Ya existe, mantener el que tenga m√°s sesiones
                    const existing = uniqueMap.get(nameLower);
                    if ((s.sessions || []).length > (existing.sessions || []).length) {
                        uniqueMap.set(nameLower, s);
                    }
                }
            });
            
            students = Array.from(uniqueMap.values());
            
            // Guardar en localStorage
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            
            // Actualizar UI
            renderStudents();
            
            if (currentStudent) {
                const updated = students.find(s => s.id === currentStudent.id);
                if (updated) {
                    currentStudent = updated;
                    if (document.getElementById('view-dashboard').classList.contains('active')) {
                        renderDashboard();
                    }
                }
            }
            
            console.log('‚úÖ Sincronizado:', students.length, 'atletas √∫nicos');
        }
        
    }, (error) => {
        console.error('‚ùå Error en listener:', error);
        updateConnectionStatus(false, 'Error de sincronizaci√≥n');
    });
}
        
        function setupConnectionListener() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus(true, 'Conectado');
                showNotification('üü¢ Conexi√≥n restaurada', 'success');
                
                // Sincronizar cambios pendientes
                if (pendingChanges) {
                    saveToFirebase();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus(false, 'Sin conexi√≥n');
                showNotification('üü° Modo offline', 'warning');
            });
        }
        
        function updateConnectionStatus(online, text) {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            if (online) {
                statusEl.className = 'connection-status online';
                dotEl.textContent = 'üü¢';
            } else {
                statusEl.className = 'connection-status offline';
                dotEl.textContent = 'üü°';
            }
            textEl.textContent = text;
        }
        
        // ============================================
        // DATA MANAGEMENT (FIREBASE + LOCALSTORAGE)
        // ============================================
        
        let students = [];
        let exerciseDatabase = JSON.parse(localStorage.getItem('gymTracker_exercises')) || [];
        let currentStudent = null;
        let currentDay = null;
        let currentBlockForExercise = null;
        let editingExercise = null;
        let currentMonth = new Date();
        let customLogo = localStorage.getItem('gymTracker_customLogo') || null;
        let currentEditingSessionIndex = null;

        async function loadFromFirebase() {
            showLoading(true);
            
            try {
                // Intentar cargar de Firebase
                const snapshot = await window.firebaseGetDocs(studentsCollection);
                const firebaseStudents = [];
                
                snapshot.forEach((doc) => {
                    firebaseStudents.push(doc.data());
                });
                
                // Cargar locales
                const localData = localStorage.getItem('gymTracker_students');
                const localStudents = localData ? JSON.parse(localData) : [];
                
                // Fusionar
                if (firebaseStudents.length > 0 || localStudents.length > 0) {
                    students = mergeStudentsData(firebaseStudents, localStudents);
                    
                    // Guardar en localStorage
                    localStorage.setItem('gymTracker_students', JSON.stringify(students));
                    
                    renderStudents();
                    console.log('‚úÖ Cargados', students.length, 'atletas desde Firebase');
                } else {
                    console.log('‚ÑπÔ∏è No hay datos en Firebase ni localStorage');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando de Firebase:', error);
                loadFromLocalStorageFallback();
            }
            
            showLoading(false);
        }

        async function saveToFirebase() {
    if (!db || !isOnline) {
        console.log('üíæ Solo local (offline o Firebase no listo)');
        pendingChanges = true;
        return false;
    }
    
    try {
        // ‚úÖ GUARDAR CON VALIDACI√ìN DE DUPLICADOS
        for (const student of students) {
            // Validar que es un estudiante v√°lido
            if (!student || !student.id || !student.name || student.name.trim() === '') {
                console.log('‚ö†Ô∏è Skipping invalid student:', student);
                continue;
            }
            
            const studentRef = window.firebaseDoc(db, 'students', student.id.toString());
            
            // ‚úÖ USAR MERGE en vez de sobrescribir
            await window.firebaseSetDoc(studentRef, student, { merge: true });
        }
        
        console.log('‚úÖ Guardado en Firebase:', students.length, 'atletas');
        pendingChanges = false;
        return true;
        
    } catch (error) {
        console.error('‚ùå Error guardando en Firebase:', error);
        pendingChanges = true;
        return false;
    }
}
        async function manualSync() {
            const btn = document.getElementById('syncBtn');
            btn.classList.add('syncing');
            btn.textContent = 'üîÑ Sincronizando...';
            
            showNotification('üîÑ Sincronizando...', 'info');
            
            try {
                await saveToFirebase();
                await loadFromFirebase();
                showNotification('‚úÖ Sincronizaci√≥n completada', 'success');
            } catch (error) {
                showNotification('‚ùå Error de sincronizaci√≥n', 'error');
            }
            
            setTimeout(() => {
                btn.classList.remove('syncing');
                btn.textContent = 'üîÑ Sincronizar';
            }, 2000);
        }

        async function forceSyncAll() {
            if (!confirm('¬øForzar sincronizaci√≥n completa?')) return;
            
            showLoading(true);
            
            // Actualizar m√©tricas
            students.forEach(student => updateStudentMetrics(student));
            
            // Guardar en localStorage
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            
            // Guardar en Firebase
            await saveToFirebase();
            
            showLoading(false);
            showNotification('‚úÖ Sincronizaci√≥n forzada completada', 'success');
        }

        function loadFromLocalStorageFallback() {
            console.log('üìÇ Cargando desde localStorage...');
            
            try {
                const data = localStorage.getItem('gymTracker_students');
                
                if (!data) {
                    students = [];
                    renderStudents();
                    return;
                }
                
                students = JSON.parse(data);
                renderStudents();
                console.log('‚úÖ Cargados', students.length, 'atletas desde localStorage');
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                students = [];
                renderStudents();
            }
        }

       function mergeStudentsData(firebaseStudents, localStudents) {
    const mergedMap = new Map();
    const seenNames = new Map(); // ‚Üê DETECTAR DUPLICADOS POR NOMBRE
    
    // ‚úÖ SOLO AGREGAR ESTUDIANTES V√ÅLIDOS DE FIREBASE
    firebaseStudents.forEach(s => {
        if (!s || !s.id || !s.name || s.name.trim() === '' || 
            s.name.includes('no se modificaron') ||
            s.name.toLowerCase().includes('undefined') ||
            s.name.toLowerCase().includes('null') ||
            s._deleted) {
            return; // Skip basura
        }
        
        const nameLower = s.name.toLowerCase().trim();
        
        // ‚úÖ DETECTAR DUPLICADOS POR NOMBRE
        if (seenNames.has(nameLower)) {
            // Ya existe uno con este nombre, mantener el que tenga M√ÅS sesiones
            const existing = seenNames.get(nameLower);
            const existingSessionsCount = (existing.sessions || []).length;
            const currentSessionsCount = (s.sessions || []).length;
            
            if (currentSessionsCount > existingSessionsCount) {
                // Este tiene m√°s datos, reemplazar
                mergedMap.delete(existing.id);
                mergedMap.set(s.id, {...s});
                seenNames.set(nameLower, s);
                console.log('üîÑ Reemplazado duplicado:', s.name, `(${currentSessionsCount} vs ${existingSessionsCount} sesiones)`);
            } else {
                console.log('‚è≠Ô∏è Ignorado duplicado:', s.name, `(menos sesiones: ${currentSessionsCount} vs ${existingSessionsCount})`);
            }
        } else {
            // Primera vez que vemos este nombre
            mergedMap.set(s.id, {...s});
            seenNames.set(nameLower, s);
        }
    });
    
    // ‚úÖ FUSIONAR CON LOCALES V√ÅLIDOS (solo si NO existen en Firebase)
    localStudents.forEach(local => {
        if (!local || !local.id || !local.name || local.name.trim() === '' ||
            local.name.includes('no se modificaron') ||
            local.name.toLowerCase().includes('undefined')) {
            return; // Skip basura
        }
        
        const nameLower = local.name.toLowerCase().trim();
        
        // Si ya existe en Firebase por NOMBRE, fusionar sesiones
        if (seenNames.has(nameLower)) {
            const existing = seenNames.get(nameLower);
            
            // Fusionar sesiones
            const sessionMap = new Map();
            (existing.sessions || []).forEach(s => {
                const key = `${s.timestamp}_${s.date}`;
                sessionMap.set(key, s);
            });
            (local.sessions || []).forEach(s => {
                const key = `${s.timestamp}_${s.date}`;
                if (!sessionMap.has(key)) sessionMap.set(key, s);
            });
            
            // Fusionar objetivos
            const goalMap = new Map();
            (existing.goals || []).forEach(g => goalMap.set(g.id, g));
            (local.goals || []).forEach(g => {
                if (!goalMap.has(g.id)) goalMap.set(g.id, g);
            });
            
            // Actualizar el existente con datos fusionados
            existing.sessions = Array.from(sessionMap.values())
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            existing.goals = Array.from(goalMap.values());
            existing.totalXP = Math.max(existing.totalXP || 0, local.totalXP || 0);
            existing.level = Math.max(existing.level || 1, local.level || 1);
            existing.badges = [...new Set([...(existing.badges || []), ...(local.badges || [])])];
            
            mergedMap.set(existing.id, existing);
            
        } else {
            // No existe en Firebase, agregar desde local
            mergedMap.set(local.id, {...local});
            seenNames.set(nameLower, local);
        }
    });
    
    return Array.from(mergedMap.values());
}
          
        // ============================================
        // UI FUNCTIONS (sin cambios principales)
        // ============================================
        
        function initialize() {
            loadLogo();
            updateMonthDisplay();
            document.getElementById('sessionDate').valueAsDate = new Date();
            
            // Bot√≥n importar
            setTimeout(() => {
                const btn = document.getElementById('btnOpenImportCSV');
                if (btn) {
                    btn.addEventListener('click', () => {
                        document.getElementById('modal-importComplete').classList.add('active');
                    });
                }
            }, 100);
        }
        
        initialize();
function cleanDuplicateStudents() {
    const seen = new Set();
    const cleaned = [];
    
    students.forEach(s => {
        if (s && s.id && !seen.has(s.id)) {
            seen.add(s.id);
            cleaned.push(s);
        }
    });
    
    if (cleaned.length !== students.length) {
        console.log(`üßπ Limpiados ${students.length - cleaned.length} duplicados`);
        students = cleaned;
        saveData();
    }
}

// Llamar despu√©s de cargar
initialize();
setTimeout(cleanDuplicateStudents, 2000); // Ejecutar 2 segundos despu√©s
        function loadLogo() {
            const logoContainer = document.getElementById('appLogo');
            
            if (customLogo) {
                logoContainer.innerHTML = `<img src="${customLogo}" alt="Logo" style="width: 64px; height: 64px; object-fit: contain;" />`;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPreviewImg').src = customLogo;
            } else {
                logoContainer.innerHTML = `
                    <div style="width: 64px; height: 64px; background: var(--accent-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'Inter'; font-size: 32px; color: white; letter-spacing: -2px;">T</div>
                `;
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor seleccion√° una imagen v√°lida');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                customLogo = e.target.result;
                localStorage.setItem('gymTracker_customLogo', customLogo);
                loadLogo();
                showNotification('‚úÖ Logo actualizado!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (confirm('¬øEliminar logo personalizado?')) {
                customLogo = null;
                localStorage.removeItem('gymTracker_customLogo');
                document.getElementById('logoPreview').style.display = 'none';
                document.getElementById('logoUpload').value = '';
                loadLogo();
                showNotification('‚úÖ Logo eliminado', 'success');
            }
        }

        function clearLocalData() {
            if (!confirm('‚ö†Ô∏è ¬øBORRAR TODOS LOS DATOS LOCALES?\n\nEsto no afecta Firebase, solo borra el cach√© local.')) return;
            
            localStorage.removeItem('gymTracker_students');
            localStorage.removeItem('gymTracker_exercises');
            localStorage.removeItem('gymTracker_customLogo');
            
            showNotification('üóëÔ∏è Datos locales borrados', 'info');
            setTimeout(() => location.reload(), 1500);
        }

        function updateMonthDisplay() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('currentMonthDisplay').textContent = 
                `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            updateMonthDisplay();
            if (currentStudent) renderDashboard();
        }

        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading active' : 'loading';
        }

        function switchView(viewName, clickedTab) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            if (!clickedTab) {
                clickedTab = document.querySelector(`.nav-tab[onclick*="'${viewName}'"]`);
            }
            if (clickedTab) clickedTab.classList.add('active');

            if (viewName === 'dashboard' && currentStudent) renderDashboard();
        }

        function openModal(modalName) {
            document.getElementById(`modal-${modalName}`).classList.add('active');
        }

        function closeModal(modalName) {
            document.getElementById(`modal-${modalName}`).classList.remove('active');
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const cards = document.querySelectorAll('.student-card');
            
            cards.forEach(card => {
                const studentName = card.querySelector('.student-name').textContent.toLowerCase();
                card.style.display = studentName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.app-notification');
            if (existing) existing.remove();
            
            const notif = document.createElement('div');
            notif.className = 'app-notification';
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                animation: slideInNotif 0.3s ease;
                font-family: 'Inter', sans-serif;
                ${type === 'success' ? 'background: linear-gradient(135deg, #10B981, #059669);' : 
                  type === 'error' ? 'background: linear-gradient(135deg, #EF4444, #DC2626);' : 
                  type === 'warning' ? 'background: linear-gradient(135deg, #F59E0B, #D97706);' : 
                  'background: linear-gradient(135deg, #3B82F6, #2563EB);'}
            `;
            notif.textContent = message;
            
            if (!document.querySelector('#notif-styles')) {
                const style = document.createElement('style');
                style.id = 'notif-styles';
                style.textContent = `
                    @keyframes slideInNotif {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutNotif {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(400px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOutNotif 0.3s ease forwards';
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

      function addStudent(e) {
    e.preventDefault();
    
    const newName = document.getElementById('studentName').value.trim();
    
    // ‚úÖ VERIFICAR SI YA EXISTE
    const exists = students.find(s => s.name.toLowerCase().trim() === newName.toLowerCase());
    if (exists) {
        alert('‚ö†Ô∏è Ya existe un atleta con ese nombre');
        return;
    }
    
    const student = {
        id: Date.now(),
        name: newName,
        age: parseInt(document.getElementById('studentAge').value),
        weight: parseFloat(document.getElementById('studentWeight').value),
        goal: document.getElementById('studentGoal').value,
        monthlyClasses: parseInt(document.getElementById('studentClasses').value),
        trainingDays: [],
        sessions: [],
        attendance: {},
        createdAt: new Date().toISOString(),
        totalXP: 0,
        level: 1,
        badges: [],
        goals: []
    };

    students.push(student);
    saveData();
    renderStudents();
    closeModal('addStudent');
    e.target.reset();
    
    showNotification(`‚úÖ ${student.name} agregado`, 'success');
}

        function renderStudents() {
            const container = document.getElementById('studentsContainer');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No hay atletas. Agreg√° uno nuevo o import√° desde CSV.</p>';
                return;
            }

            container.innerHTML = students.map(student => {
                const daysCount = student.trainingDays ? student.trainingDays.length : 0;
                const sessionsCount = student.sessions ? student.sessions.length : 0;
                
                return `
                    <div class="student-card" onclick="selectStudent(${student.id})" style="position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editStudent(${student.id})" style="padding: 6px 10px; background: var(--accent-blue); color: white; border: none;">‚úèÔ∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); deleteStudent(${student.id})" style="padding: 6px 10px; background: var(--danger); color: white; border: none;">üóëÔ∏è</button>
                        </div>
                        <div class="student-name">${student.name}</div>
                        <div class="student-info">üìÖ ${student.age} a√±os ‚Ä¢ ‚öñÔ∏è ${student.weight}kg</div>
                        <div class="student-info">üéØ ${student.monthlyClasses} clases/mes</div>
                        <div class="student-info">üèãÔ∏è ${daysCount} d√≠a${daysCount !== 1 ? 's' : ''} de entrenamiento</div>
                        <div class="student-info">üìä ${sessionsCount} sesiones guardadas</div>
                        <div class="student-goal">${student.goal}</div>
                    </div>
                `;
            }).join('');
        }

        function selectStudent(studentId) {
            currentStudent = students.find(s => s.id === studentId);
            currentDay = null;
            
            document.getElementById('currentStudentName').textContent = currentStudent.name;
            document.getElementById('bodyWeight').value = currentStudent.weight;
            
            switchView('plan', document.querySelector('[onclick*="plan"]'));
            renderTrainingDays();
        }

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentAge').value = student.age;
            document.getElementById('editStudentWeight').value = student.weight;
            document.getElementById('editStudentGoal').value = student.goal;
            document.getElementById('editStudentClasses').value = student.monthlyClasses;
            
            document.getElementById('editStudentForm').dataset.studentId = studentId;
            
            openModal('editStudent');
        }

        function updateStudent(e) {
            e.preventDefault();
            
            const studentId = parseInt(document.getElementById('editStudentForm').dataset.studentId);
            const studentIndex = students.findIndex(s => s.id === studentId);
            
            if (studentIndex === -1) return;
            
            students[studentIndex].name = document.getElementById('editStudentName').value;
            students[studentIndex].age = parseInt(document.getElementById('editStudentAge').value);
            students[studentIndex].weight = parseFloat(document.getElementById('editStudentWeight').value);
            students[studentIndex].goal = document.getElementById('editStudentGoal').value;
            students[studentIndex].monthlyClasses = parseInt(document.getElementById('editStudentClasses').value);
            
            if (currentStudent && currentStudent.id === studentId) {
                currentStudent = students[studentIndex];
                document.getElementById('currentStudentName').textContent = currentStudent.name;
                document.getElementById('bodyWeight').value = currentStudent.weight;
            }
            
            saveData();
            renderStudents();
            closeModal('editStudent');
            
            showNotification('‚úÖ Datos actualizados', 'success');
        }

        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            if (!confirm('¬øEliminar a ' + student.name + '?')) return;
            
            students = students.filter(s => s.id !== studentId);
            
            if (currentStudent && currentStudent.id === studentId) {
                currentStudent = null;
                currentDay = null;
            }
            
            saveData();
            renderStudents();
            
            showNotification(`üóëÔ∏è ${student.name} eliminado`, 'success');
        }

        // TRAINING DAYS
        function addTrainingDay(e) {
            e.preventDefault();
            
            if (!currentStudent) {
                alert('Primero seleccion√° un atleta');
                return;
            }

            const day = {
                id: Date.now(),
                name: document.getElementById('dayName').value,
                blocks: []
            };

            if (!currentStudent.trainingDays) currentStudent.trainingDays = [];
            currentStudent.trainingDays.push(day);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            renderTrainingDays();
            closeModal('addTrainingDay');
            e.target.reset();
        }

        function renderTrainingDays() {
            const container = document.getElementById('trainingDaysList');
            
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1/-1;">No hay d√≠as de entrenamiento. Agreg√° uno nuevo o import√° un plan.</p>';
                document.getElementById('planDaysCard').style.display = 'block';
                document.getElementById('currentDayView').style.display = 'none';
                return;
            }

            container.innerHTML = currentStudent.trainingDays.map(day => {
                const blocksCount = day.blocks ? day.blocks.length : 0;
                const exercisesCount = day.blocks ? day.blocks.reduce((sum, b) => sum + (b.exercises ? b.exercises.length : 0), 0) : 0;
                
                return `
                    <div class="training-day-card" onclick="selectTrainingDay(${day.id})" style="position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editTrainingDay(${day.id})" style="padding: 6px 10px; font-size: 11px;">‚úèÔ∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); duplicateTrainingDay(${day.id})" style="padding: 6px 10px; font-size: 11px; background: var(--success); color: white; border: none;">üìã</button>
                            <button class="delete-day-btn" onclick="event.stopPropagation(); deleteTrainingDay(${day.id})">üóëÔ∏è</button>
                        </div>
                        <h3>${day.name}</h3>
                        <p>${blocksCount} bloque${blocksCount !== 1 ? 's' : ''} ‚Ä¢ ${exercisesCount} ejercicios</p>
                        <span class="training-day-badge">Click para entrenar</span>
                    </div>
                `;
            }).join('');

            document.getElementById('planDaysCard').style.display = 'block';
            document.getElementById('currentDayView').style.display = 'none';
        }

        function selectTrainingDay(dayId) {
            currentDay = currentStudent.trainingDays.find(d => d.id === dayId);
            if (!currentDay) return;

            document.getElementById('currentDayTitle').textContent = currentDay.name;
            document.getElementById('planDaysCard').style.display = 'none';
            document.getElementById('currentDayView').style.display = 'block';
            
            loadTrainingDay();
        }

        function closeDayView() {
            currentDay = null;
            renderTrainingDays();
        }

        function deleteTrainingDay(dayId) {
            if (!confirm('¬øEliminar este d√≠a?')) return;

            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === dayId);
            if (dayIndex !== -1) {
                currentStudent.trainingDays.splice(dayIndex, 1);
                
                const studentIndex = students.findIndex(s => s.id === currentStudent.id);
                if (studentIndex !== -1) students[studentIndex] = currentStudent;

                saveData();
                renderTrainingDays();
            }
        }

        function duplicateTrainingDay(dayId) {
            const originalDay = currentStudent.trainingDays.find(d => d.id === dayId);
            if (!originalDay) return;
            
            const newDayName = prompt('Nombre del nuevo d√≠a:', originalDay.name + ' (copia)');
            if (!newDayName) return;
            
            const newDay = {
                id: Date.now(),
                name: newDayName,
                blocks: JSON.parse(JSON.stringify(originalDay.blocks))
            };
            
            currentStudent.trainingDays.push(newDay);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            saveData();
            renderTrainingDays();
            
            showNotification(`‚úÖ "${newDayName}" creado`, 'success');
        }

        function editTrainingDay(dayId) {
            const day = currentStudent.trainingDays.find(d => d.id === dayId);
            if (!day) return;
            
            const newName = prompt('Nuevo nombre:', day.name);
            if (!newName || newName === day.name) return;
            
            day.name = newName;
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            saveData();
            renderTrainingDays();
        }

        function loadTrainingDay() {
            if (!currentDay) return;

            const container = document.getElementById('blocksContainer');
            
            if (!currentDay.blocks || currentDay.blocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No hay bloques. Agreg√° uno nuevo.</p>';
                return;
            }

            const iconMap = {
                'movilidad': 'üì±',
                'core': 'üü°',
                'fuerza-inferior': 'üîµ',
                'fuerza-superior': 'üü£'
            };

            container.innerHTML = currentDay.blocks.map((block, blockIndex) => {
                const exercises = block.exercises.map((ex, exIndex) => `
                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-name">
                                ${ex.isPrincipal ? '‚≠ê ' : ''}${ex.name}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="editExercise(${blockIndex}, ${exIndex})" style="padding: 4px 8px;">‚úèÔ∏è</button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteExercise(${blockIndex}, ${exIndex})" style="padding: 4px 8px;">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="exercise-inputs">
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Series</label>
                                <input type="number" class="exercise-input" value="${ex.series || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'series', this.value)" min="1" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Reps</label>
                                <input type="text" class="exercise-input" value="${ex.reps || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'reps', this.value)" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Peso (kg)</label>
                                <input type="number" class="exercise-input" value="${ex.weight || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'weight', this.value)" step="0.5" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">RPE (1-10)</label>
                                <input type="number" class="exercise-input" value="${ex.rpe || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'rpe', this.value)" min="1" max="10" step="0.5" />
                            </div>
                        </div>
                        ${ex.isPrincipal ? `
                            <div style="margin-top: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--accent-blue);">
                                    <input type="checkbox" ${ex.isPR ? 'checked' : ''} 
                                           onchange="updateExercise(${blockIndex}, ${exIndex}, 'isPR', this.checked)" />
                                    üèÜ R√©cord Personal
                                </label>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                return `
                    <div class="block block-type-${block.type}">
                        <div class="block-header">
                            <div class="block-title">
                                <div class="block-icon">${iconMap[block.type] || 'üìã'}</div>
                                ${block.name}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="currentBlockForExercise = ${blockIndex}; editingExercise = null; document.querySelector('#modal-addExercise .modal-title').textContent = '‚ûï Nuevo Ejercicio'; openModal('addExercise')">
                                    ‚ûï Ejercicio
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="editBlock(${blockIndex})">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteBlock(${blockIndex})">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        ${exercises}
                    </div>
                `;
            }).join('');
        }

        // BLOCKS & EXERCISES
        function addBlock(e) {
            e.preventDefault();
            
            if (!currentDay) {
                alert('Primero seleccion√° un d√≠a');
                return;
            }

            const block = {
                name: document.getElementById('blockName').value,
                type: document.getElementById('blockType').value,
                exercises: []
            };

            if (!currentDay.blocks) currentDay.blocks = [];
            currentDay.blocks.push(block);
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            loadTrainingDay();
            closeModal('addBlock');
            e.target.reset();
        }

        function deleteBlock(blockIndex) {
            if (!confirm('¬øEliminar este bloque?')) return;
            currentDay.blocks.splice(blockIndex, 1);
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            loadTrainingDay();
        }

        function editBlock(blockIndex) {
            if (!currentDay || !currentDay.blocks[blockIndex]) return;
            
            const block = currentDay.blocks[blockIndex];
            const newName = prompt('Nuevo nombre:', block.name);
            if (!newName) return;
            
            block.name = newName;
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            loadTrainingDay();
        }

        function addExercise(e) {
            e.preventDefault();
            
            if (currentBlockForExercise === null) {
                alert('Error: no hay bloque seleccionado');
                return;
            }

            const exercise = {
                name: document.getElementById('exerciseName').value,
                series: parseInt(document.getElementById('exerciseSeries').value),
                reps: document.getElementById('exerciseReps').value,
                isPrincipal: document.getElementById('exerciseIsPrincipal').checked,
                weight: null,
                rpe: null,
                isPR: false
            };

            if (editingExercise !== null) {
                currentDay.blocks[editingExercise.blockIndex].exercises[editingExercise.exIndex] = exercise;
                editingExercise = null;
                document.querySelector('#modal-addExercise .modal-title').textContent = '‚ûï Nuevo Ejercicio';
            } else {
                if (!exerciseDatabase.includes(exercise.name)) {
                    exerciseDatabase.push(exercise.name);
                    localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
                    updateExercisesList();
                }

                currentDay.blocks[currentBlockForExercise].exercises.push(exercise);
            }
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            loadTrainingDay();
            closeModal('addExercise');
            e.target.reset();
            currentBlockForExercise = null;
        }

        function editExercise(blockIndex, exIndex) {
            if (!currentDay || !currentDay.blocks[blockIndex]) return;
            
            const exercise = currentDay.blocks[blockIndex].exercises[exIndex];
            
            currentBlockForExercise = blockIndex;
            editingExercise = { blockIndex: blockIndex, exIndex: exIndex };
            
            document.getElementById('exerciseName').value = exercise.name;
            document.getElementById('exerciseSeries').value = exercise.series;
            document.getElementById('exerciseReps').value = exercise.reps;
            document.getElementById('exerciseIsPrincipal').checked = exercise.isPrincipal;
            
            document.querySelector('#modal-addExercise .modal-title').textContent = '‚úèÔ∏è Editar Ejercicio';
            
            openModal('addExercise');
        }

        function updateExercise(blockIndex, exIndex, field, value) {
            if (field === 'isPR') {
                currentDay.blocks[blockIndex].exercises[exIndex][field] = value;
            } else {
                const numValue = parseFloat(value);
                currentDay.blocks[blockIndex].exercises[exIndex][field] = isNaN(numValue) ? value : numValue;
            }

            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
        }

        function deleteExercise(blockIndex, exIndex) {
            if (!confirm('¬øEliminar este ejercicio?')) return;
            currentDay.blocks[blockIndex].exercises.splice(exIndex, 1);
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) currentStudent.trainingDays[dayIndex] = currentDay;

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;

            saveData();
            loadTrainingDay();
        }

        function updateExercisesList() {
            const datalist = document.getElementById('exercisesList');
            datalist.innerHTML = exerciseDatabase.map(ex => `<option value="${ex}">`).join('');
        }

        // SAVE DATA (Local + Firebase)
        async function saveData() {
            // Siempre guardar en localStorage primero
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            
            // Intentar guardar en Firebase
            if (db && isOnline) {
                try {
                    await saveToFirebase();
                } catch (error) {
                    console.log('Firebase no disponible, guardado solo local');
                    pendingChanges = true;
                }
            } else {
                pendingChanges = true;
            }
        }

        // SESSION MANAGEMENT
        async function saveSession() {
            if (!currentStudent || !currentDay) {
                alert('Seleccion√° un atleta y un d√≠a');
                return;
            }

            const date = document.getElementById('sessionDate').value;
            const bodyWeight = parseFloat(document.getElementById('bodyWeight').value);
            
            if (!date) {
                alert('Ingres√° la fecha');
                return;
            }

            let totalVolume = 0;
            let totalRPE = 0;
            let rpeCount = 0;
            let prsCount = 0;

            const sessionBlocks = JSON.parse(JSON.stringify(currentDay.blocks));
            
            sessionBlocks.forEach(block => {
                block.exercises.forEach(ex => {
                    if (ex.weight && ex.series && ex.reps) {
                        const reps = parseFloat(ex.reps) || 0;
                        totalVolume += ex.weight * ex.series * reps;
                    }
                    if (ex.rpe) {
                        totalRPE += parseFloat(ex.rpe);
                        rpeCount++;
                    }
                    if (ex.isPR) prsCount++;
                });
            });

            const avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : 0;

            const session = {
                date: date,
                dayId: currentDay.id,
                dayName: currentDay.name,
                bodyWeight: bodyWeight,
                blocks: sessionBlocks,
                volume: Math.round(totalVolume),
                avgRPE: parseFloat(avgRPE),
                prs: prsCount,
                timestamp: new Date().toISOString()
            };

            if (!currentStudent.sessions) currentStudent.sessions = [];
            currentStudent.sessions.push(session);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            updateStudentMetrics(currentStudent);
            
            await saveData();
            
            showNotification(`‚úÖ Sesi√≥n guardada! Volumen: ${session.volume}kg`, 'success');
            
            // Reset PR flags
            currentDay.blocks.forEach(block => {
                block.exercises.forEach(ex => ex.isPR = false);
            });
            loadTrainingDay();
            
            renderStudents();
        }

        function updateStudentMetrics(s) {
            if (!s || !s.sessions) return;
            
            if (!s.totalXP) s.totalXP = 0;
            if (!s.level) s.level = 1;
            if (!s.badges) s.badges = [];
            if (!s.goals) s.goals = [];
            
            s.totalXP = s.sessions.reduce((sum, sess) => sum + Math.floor((sess.volume || 0) / 100), 0);
            s.level = Math.min(Math.floor(s.totalXP / 100), 100);
            
            checkBadges(s);
            if (s.goals) updateGoals(s);
        }

        function checkBadges(s) {
            if (!s.badges) s.badges = [];
            const vol = s.sessions.reduce((sum, sess) => sum + (sess.volume || 0), 0);
            const prs = s.sessions.reduce((sum, sess) => sum + (sess.prs || 0), 0);
            const str = calculateStreak(s.sessions || []);
            
            if (str >= 7 && !s.badges.includes('streak_7')) s.badges.push('streak_7');
            if (vol >= 100000 && !s.badges.includes('vol_100k')) s.badges.push('vol_100k');
            if (prs >= 10 && !s.badges.includes('pr_10')) s.badges.push('pr_10');
            if (s.level >= 10 && !s.badges.includes('lvl_10')) s.badges.push('lvl_10');
            if (s.level >= 50 && !s.badges.includes('lvl_50')) s.badges.push('lvl_50');
            if (s.level >= 100 && !s.badges.includes('lvl_100')) s.badges.push('lvl_100');
        }

      function updateGoals(s) {
    if (!s.goals) s.goals = [];
    const now = new Date();
    
    s.goals.forEach(g => {
        // ‚ùå NO TOCAR si ya est√° completado o fallado
        if (g.status === 'completed' || g.status === 'failed') return;
        
        if (now > new Date(g.deadline)) { 
            g.status = 'failed'; 
            return; 
        }
        
        let curr = 0;
        
        if (g.type === 'volume') {
            const ms = new Date(now.getFullYear(), now.getMonth(), 1);
            curr = Math.floor(s.sessions.filter(sess => new Date(sess.date) >= ms)
                .reduce((sum, sess) => sum + (sess.volume || 0), 0) / 1000);
            
        } else if (g.type === 'strength') {
            s.sessions.forEach(sess => {
                if (sess.blocks) sess.blocks.forEach(b => {
                    if (b.exercises) b.exercises.forEach(e => {
                        if ((!g.exerciseName || e.name.toLowerCase().includes(g.exerciseName.toLowerCase())) && e.weight > curr) {
                            curr = e.weight;
                        }
                    });
                });
            });
            
        } else if (g.type === 'attendance') {
            const ms = new Date(now.getFullYear(), now.getMonth(), 1);
            curr = s.sessions.filter(sess => new Date(sess.date) >= ms).length;
            
        } else if (g.type === 'prs') {
            const start = new Date(g.startDate || g.deadline);
            curr = s.sessions.filter(sess => new Date(sess.date) >= start)
                .reduce((sum, sess) => sum + (sess.prs || 0), 0);
        }
        
        g.currentValue = curr;
        g.progress = Math.min((curr / g.targetValue) * 100, 100);
        
        // ‚úÖ MARCAR COMO COMPLETADO (pero NO eliminar)
        if (g.progress >= 100 && g.status !== 'completed') {
            g.status = 'completed';
            g.completedAt = new Date().toISOString(); // ‚Üê Fecha de logro
            setTimeout(() => {
                alert('üèÜ ¬°OBJETIVO CUMPLIDO!\n\n' + s.name + ' complet√≥:\n' + g.description + '\n\nüéÅ Recompensa: ' + (g.reward || 'Sin recompensa'));
            }, 1500);
        }
    });
}
                

        function saveGoal() {
            if (!currentStudent) return;
            if (!currentStudent.goals) currentStudent.goals = [];
            
            const active = currentStudent.goals.filter(g => g.status === 'in_progress');
            if (active.length >= 5) { alert('‚ö†Ô∏è M√°ximo 5 objetivos activos'); return; }
            
            const type = document.getElementById('goalType').value;
            const desc = document.getElementById('goalDesc').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const deadline = document.getElementById('goalDeadline').value;
            const reward = document.getElementById('goalReward').value;
            
            if (!desc || !target || !deadline) {
                alert('Complet√° descripci√≥n, valor objetivo y fecha l√≠mite');
                return;
            }
            
            const g = {
                id: Date.now(),
                type: type,
                description: desc,
                targetValue: target,
                currentValue: 0,
                deadline: deadline,
                startDate: new Date().toISOString(),
                reward: reward,
                status: 'in_progress',
                progress: 0,
                unit: type === 'volume' ? 'ton' : type === 'strength' ? 'kg' : type === 'attendance' ? 'clases' : 'PRs',
                alert50: false,
                alert75: false
            };
            
         const exerciseValue = document.getElementById('goalExercise').value;

if (exerciseValue) {
    g.exerciseName = exerciseValue;
}

            
            currentStudent.goals.push(g);
            updateGoals(currentStudent);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            saveData();
            closeModal('newGoal');
            renderDashboard();
            showNotification('‚úÖ Objetivo creado', 'success');
        }

        function deleteGoal(goalId) {
            if (!confirm('¬øEliminar objetivo?')) return;
            currentStudent.goals = currentStudent.goals.filter(g => g.id !== goalId);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            saveData();
            renderDashboard();
        }

        // DASHBOARD
        function renderDashboard() {
            if (!currentStudent) {
                document.getElementById('dashboardContent').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Seleccion√° un atleta</p>';
                return;
            }

            document.getElementById('dashboardStudentName').textContent = currentStudent.name;

            const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            const monthSessions = currentStudent.sessions ? currentStudent.sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= monthStart && sessionDate <= monthEnd;
            }) : [];

            const attendedClasses = monthSessions.length;
            const attendancePercentage = currentStudent.monthlyClasses > 0 ? 
                Math.round((attendedClasses / currentStudent.monthlyClasses) * 100) : 0;

            if (monthSessions.length === 0) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="attendance-section">
                        <div class="attendance-header">
                            <div class="attendance-title">üìÖ Progreso de Asistencia</div>
                            <div class="classes-info">${attendedClasses} / ${currentStudent.monthlyClasses} clases</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;">Sesiones Completadas</span>
                                <span style="font-family: 'Inter'; font-size: 24px; color: var(--accent-blue);">${attendancePercentage}%</span>
                            </div>
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${Math.min(attendancePercentage, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 24px;">
                        <p style="text-align: center; color: var(--text-secondary); padding: 40px;">No hay sesiones este mes</p>
                    </div>
                `;
                return;
            }

            const currentMonthVolume = monthSessions.reduce((sum, s) => sum + (s.volume || 0), 0);
            const totalPRs = monthSessions.reduce((sum, s) => sum + (s.prs || 0), 0);
            const avgRPE = monthSessions.length > 0 ? 
                (monthSessions.reduce((sum, s) => sum + (s.avgRPE || 0), 0) / monthSessions.length).toFixed(1) : 0;

            const dayStats = {};
            monthSessions.forEach(s => {
                if (s.dayName) dayStats[s.dayName] = (dayStats[s.dayName] || 0) + 1;
            });

            const metrics = calcMetrics(currentStudent);
            const volumeInTons = (currentMonthVolume / 1000).toFixed(1);
            const totalVolumeInTons = (metrics.totalVolume / 1000).toFixed(1);
            
            let html = `
                <div class="gamification-card">
                    <h3 style="color: white; margin-bottom: 16px;">üéÆ Progreso del Atleta</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">Nivel</div>
                            <div style="font-size: 48px; font-weight: bold;">${currentStudent.level || 1}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; opacity: 0.9;">XP Total</div>
                            <div style="font-size: 28px; font-weight: bold;">${(currentStudent.totalXP || 0).toLocaleString()}</div>
                        </div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                        <div style="background: var(--accent-cyan); height: 100%; width: ${((currentStudent.totalXP || 0) % 100)}%;"></div>
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">${100 - ((currentStudent.totalXP || 0) % 100)} XP hasta nivel ${(currentStudent.level || 1) < 100 ? (currentStudent.level || 1) + 1 : 'MAX'}</div>
                </div>
                
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="color: var(--text-primary);">üèÜ Insignias (${(currentStudent.badges || []).length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px;">
                        ${(currentStudent.badges || []).length > 0 ? (currentStudent.badges).map(b => {
                            const info = getBadgeInfo(b);
                            return `<div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center; min-width: 100px; border: 2px solid var(--border-color);">
                                <div style="font-size: 40px; margin-bottom: 8px;">${info.icon}</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">${info.name}</div>
                            </div>`;
                        }).join('') : '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">Sin insignias a√∫n</p>'}
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 16px;">üìä Indicadores Clave</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
                        <div style="background: linear-gradient(135deg, #86efac, #22c55e); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Volumen Total</div>
                            <div style="font-size: 28px; font-weight: bold;">${totalVolumeInTons} ton</div>
                            <div style="font-size: 14px; margin-top: 4px; opacity: 0.9;">${metrics.totalVolume.toLocaleString()} kg</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1e3a8a, #1e40af); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Series Efectivas</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.effectiveSets}/${metrics.totalSets}</div>
                            <div style="font-size: 13px; margin-top: 4px;">${metrics.effectivePercent}% RPE‚â•7</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #78716c, #57534e); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Tonelaje Mensual</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.monthlyTonnage} ton</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Records Totales</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.totalPRs} üèÜ</div>
                        </div>
                        <div style="background: linear-gradient(135deg, ${metrics.daysSincePR < 0 ? '#999, #777' : metrics.daysSincePR < 30 ? '#22c55e, #16a34a' : '#f59e0b, #d97706'}); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">√öltimo PR</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.daysSincePR < 0 ? 'Sin PRs' : metrics.daysSincePR + ' d√≠as'}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Frecuencia PRs</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.prFrequency}</div>
                            <div style="font-size: 13px; margin-top: 4px;">PRs/mes</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ec4899, #db2777); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Racha</div>
                            <div style="font-size: 28px; font-weight: bold;">${metrics.streak} üî•</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Puntos XP</div>
                            <div style="font-size: 28px; font-weight: bold;">${currentStudent.totalXP || 0}</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--text-primary);">üéØ Objetivos SMART</h3>
                        <button onclick="openModal('newGoal')" class="btn btn-primary btn-sm">‚ûï Nuevo Objetivo</button>
                    </div>
                    ${(() => {
    const active = (currentStudent.goals || []).filter(g => g.status === 'in_progress');
    const completed = (currentStudent.goals || []).filter(g => g.status === 'completed');
    
    let html = '';
    
    // OBJETIVOS ACTIVOS
    if (active.length > 0) {
        html += '<h4 style="color: var(--accent-blue); margin-bottom: 12px;">üéØ Objetivos Activos</h4>';
        html += active.map(g => {
            const days = Math.ceil((new Date(g.deadline) - new Date()) / 86400000);
            const progressColor = g.progress >= 75 ? '#22c55e' : g.progress >= 50 ? '#f59e0b' : '#3b82f6';
            return `
                <div style="border: 2px solid var(--border-color); padding: 20px; border-radius: 12px; margin-bottom: 16px; background: var(--bg-secondary);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: bold; color: var(--accent-blue);">${g.description}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                ${g.type === 'volume' ? 'üìà Volumen' : g.type === 'strength' ? 'üí™ Fuerza' : g.type === 'attendance' ? 'üìÖ Asistencia' : 'üèÜ PRs'}${g.exerciseName ? ' ¬∑ üéØ ' + g.exerciseName : ''}
                            </div>
                        </div>
                        <button onclick="deleteGoal(${g.id})" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                    <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-size: 28px; font-weight: bold; color: var(--accent-blue);">${g.currentValue}</span>
                            <span style="font-size: 16px; color: var(--text-secondary);">/ ${g.targetValue} ${g.unit}</span>
                        </div>
                        <div style="background: var(--border-color); height: 12px; border-radius: 6px; overflow: hidden;">
                            <div style="background: ${progressColor}; height: 100%; width: ${g.progress}%;"></div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px; text-align: right;">${Math.round(g.progress)}%</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-secondary);">
                        <div>üìÖ ${days > 0 ? days + ' d√≠as restantes' : '‚ùå Venci√≥'}</div>
                        ${g.reward ? '<div style="color: var(--success); font-weight: 700;">üéÅ ' + g.reward + '</div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // OBJETIVOS COMPLETADOS
    if (completed.length > 0) {
        html += '<h4 style="color: var(--success); margin-top: 24px; margin-bottom: 12px;">‚úÖ Objetivos Completados</h4>';
        html += completed.map(g => {
            const completedDate = g.completedAt ? new Date(g.completedAt).toLocaleDateString('es-AR') : 'Fecha desconocida';
            return `
                <div style="border: 2px solid var(--success); padding: 20px; border-radius: 12px; margin-bottom: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: bold; color: var(--success);">‚úÖ ${g.description}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                Completado el ${completedDate} ¬∑ Logr√≥ ${g.targetValue} ${g.unit}
                            </div>
                        </div>
                        <button onclick="deleteGoal(${g.id})" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                    ${g.reward ? `
                        <div style="background: var(--success); color: white; padding: 12px; border-radius: 8px; font-weight: 700; text-align: center;">
                            üéÅ RECOMPENSA: ${g.reward}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }
    
    if (active.length === 0 && completed.length === 0) {
        html = '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">No hay objetivos. ¬°Cre√° uno!</p>';
    }
    
    return html;
})()}
                </div>
                
                <div class="attendance-section">
                    <div class="attendance-header">
                        <div class="attendance-title">üìÖ Progreso de Asistencia</div>
                        <div class="classes-info">${attendedClasses} / ${currentStudent.monthlyClasses} clases</div>
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;">Sesiones Completadas</span>
                            <span style="font-family: 'Inter'; font-size: 24px; color: var(--accent-blue);">${attendancePercentage}%</span>
                        </div>
                        <div class="goal-progress-bar">
                            <div class="goal-progress-fill" style="width: ${Math.min(attendancePercentage, 100)}%"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 12px;">
                            ${Object.entries(dayStats).map(([day, count]) => `${day}: ${count} sesi√≥n${count > 1 ? 'es' : ''}`).join(' ‚Ä¢ ')}
                        </div>
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%); color: white; margin-bottom: 24px;">
                    <h3 style="font-family: 'Inter'; font-size: 18px; margin-bottom: 20px; text-transform: uppercase;">
                        üí¨ Resumen Semanal
                    </h3>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; line-height: 1.8; font-size: 14px;">
                        ${generateWeeklySummary(monthSessions, currentStudent)}
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Volumen Este Mes</div>
                        <div class="metric-value">${currentMonthVolume.toLocaleString()}</div>
                        <div class="metric-detail">kg (${volumeInTons} ton)</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Records Rotos</div>
                        <div class="metric-value">${totalPRs}</div>
                        <div class="metric-detail">PRs este mes</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">RPE Promedio</div>
                        <div class="metric-value">${avgRPE}</div>
                        <div class="metric-detail">${avgRPE < 7 ? 'Suave' : avgRPE < 8.5 ? '√ìptimo' : 'Intenso'}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Consistencia</div>
                        <div class="metric-value">${attendancePercentage}%</div>
                        <div class="metric-detail">${attendancePercentage >= 90 ? 'Excelente' : attendancePercentage >= 75 ? 'Bueno' : 'Mejorable'}</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-family: 'Inter'; font-size: 18px; margin-bottom: 20px; text-transform: uppercase; color: var(--text-primary);">üìã Historial de Sesiones</h3>
                    <div style="overflow-x: auto;">
                        <table class="progress-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>D√≠a</th>
                                    <th>Volumen</th>
                                    <th>RPE</th>
                                    <th>PRs</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${[...monthSessions].reverse().map((s, idx) => {
                                    const dateObj = new Date(s.date + 'T12:00:00');
                                    const formattedDate = dateObj.toLocaleDateString('es-AR', { 
                                        day: '2-digit', 
                                        month: '2-digit'
                                    });
                                    
                                    return `
                                        <tr>
                                            <td>${formattedDate}</td>
                                            <td><strong>${s.dayName || 'Plan'}</strong></td>
                                            <td>${(s.volume || 0).toLocaleString()} kg</td>
                                            <td>${(s.avgRPE || 0)}</td>
                                            <td>${(s.prs || 0) > 0 ? 'üèÜ ' + s.prs : '-'}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm" onclick="editSession(${idx})" style="padding: 4px 8px;">‚úèÔ∏è Editar</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('dashboardContent').innerHTML = html;
        }

        // AUXILIARY FUNCTIONS
        function calcMetrics(student) {
            if (!student || !student.sessions || student.sessions.length === 0) {
                return {
                    totalSets: 0, effectiveSets: 0, effectivePercent: 0,
                    monthlyTonnage: '0.0', daysSincePR: -1, prFrequency: '0.0',
                    totalVolume: 0, totalPRs: 0, streak: 0
                };
            }
            
            let totalSets = 0, effectiveSets = 0;
            student.sessions.forEach(sess => {
                if (sess.blocks) {
                    sess.blocks.forEach(b => {
                        if (b.exercises) {
                            b.exercises.forEach(e => {
                                totalSets += (e.series || 0);
                                if ((e.rpe || 0) >= 7) effectiveSets += (e.series || 0);
                            });
                        }
                    });
                }
            });
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthVol = student.sessions.filter(sess => new Date(sess.date) >= monthStart)
                .reduce((sum, sess) => sum + (sess.volume || 0), 0);
            
            let lastPR = null;
            student.sessions.forEach(sess => {
                if ((sess.prs || 0) > 0) {
                    if (!lastPR || new Date(sess.date) > new Date(lastPR)) {
                        lastPR = sess.date;
                    }
                }
            });
            const daysSincePR = lastPR ? Math.floor((now - new Date(lastPR)) / 86400000) : -1;
            
            const totalPRs = student.sessions.reduce((sum, sess) => sum + (sess.prs || 0), 0);
            const firstDate = student.sessions.length > 0 ? new Date(student.sessions[0].date) : now;
            const months = Math.max(0.5, (now - firstDate) / 2592000000);
            const totalVol = student.sessions.reduce((sum, sess) => sum + (sess.volume || 0), 0);
            
            return {
                totalSets: totalSets,
                effectiveSets: effectiveSets,
                effectivePercent: totalSets > 0 ? Math.round((effectiveSets / totalSets) * 100) : 0,
                monthlyTonnage: (monthVol / 1000).toFixed(1),
                daysSincePR: daysSincePR,
                prFrequency: (totalPRs / months).toFixed(1),
                totalVolume: totalVol,
                totalPRs: totalPRs,
                streak: calculateStreak(student.sessions || [])
            };
        }

        function getBadgeInfo(id) {
            const badges = {
                'streak_7': { name: '7 d√≠as', icon: 'üî•' },
                'vol_100k': { name: '100 ton', icon: 'üí™' },
                'pr_10': { name: '10 PRs', icon: 'üèÜ' },
                'lvl_10': { name: 'Nivel 10', icon: '‚≠ê' },
                'lvl_50': { name: 'Nivel 50', icon: '‚≠ê‚≠ê‚≠ê' },
                'lvl_100': { name: 'MAX', icon: 'üëë' }
            };
            return badges[id] || { name: id, icon: 'üéñÔ∏è' };
        }

        function calculateStreak(sessions) {
            if (!sessions || sessions.length === 0) return 0;
            
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 0;
            let lastDate = new Date();
            
            for (let i = 0; i < sortedSessions.length; i++) {
                const sessionDate = new Date(sortedSessions[i].date);
                const diffDays = Math.floor((lastDate - sessionDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 3) {
                    streak++;
                    lastDate = sessionDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function generateWeeklySummary(sessions, student) {
            if (!sessions || sessions.length === 0) {
                return '<p style="opacity: 0.8;">No hay sesiones registradas.</p>';
            }

            const today = new Date();
            const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            const weekSessions = sessions.filter(s => new Date(s.date) >= weekAgo);

            if (weekSessions.length === 0) {
                return '<p style="opacity: 0.8;">No hay sesiones en los √∫ltimos 7 d√≠as.</p>';
            }

            const weekVolume = weekSessions.reduce((sum, s) => sum + (s.volume || 0), 0);
            const weekPRs = weekSessions.reduce((sum, s) => sum + (s.prs || 0), 0);
            
            let summary = '<div style="line-height: 2;">';
            summary += `<div>‚úì <strong>${weekSessions.length} sesiones</strong> esta semana</div>`;
            summary += `<div>üì¶ <strong>${(weekVolume/1000).toFixed(1)} toneladas</strong> movidas</div>`;
            
            if (weekPRs > 0) {
                summary += `<div>üèÜ <strong>${weekPRs} r√©cord${weekPRs > 1 ? 's' : ''}</strong> - ¬°Excelente!</div>`;
            }
            
            summary += '</div>';
            return summary;
        }

        // IMPORT/EXPORT (CSV)
        let importedCompleteData = [];

        function handleCompleteImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCompleteData(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCompleteData(text) {
            importedCompleteData = [];
            const lines = text.split('\n').filter(line => line.trim());
            const startIndex = lines[0].toLowerCase().includes('alumno') ? 1 : 0;
            
            const studentsMap = {};
            
            for (let i = startIndex; i < lines.length; i++) {
                const parts = parseCSVLine(lines[i]);
                
                if (parts.length >= 12) {
                    const studentName = parts[0];
                    const age = parseInt(parts[1]) || 25;
                    const weight = parseFloat(parts[2]) || 70;
                    const goal = parts[3];
                    const monthlyClasses = parseInt(parts[4]) || 12;
                    const dayName = parts[5];
                    const blockName = parts[6];
                    const blockType = parts[7];
                    const exerciseName = parts[8];
                    const series = parseInt(parts[9]) || 3;
                    const reps = parts[10];
                    const isPrincipal = parts[11].toUpperCase() === 'SI';
                    
                    if (!studentsMap[studentName]) {
                        studentsMap[studentName] = {
                            name: studentName,
                            age: age,
                            weight: weight,
                            goal: goal,
                            monthlyClasses: monthlyClasses,
                            days: {}
                        };
                    }
                    
                    const student = studentsMap[studentName];
                    
                    if (!student.days[dayName]) {
                        student.days[dayName] = { name: dayName, blocks: {} };
                    }
                    
                    const day = student.days[dayName];
                    
                    if (!day.blocks[blockName]) {
                        day.blocks[blockName] = { name: blockName, type: blockType, exercises: [] };
                    }
                    
                    day.blocks[blockName].exercises.push({
                        name: exerciseName,
                        series: series,
                        reps: reps,
                        isPrincipal: isPrincipal,
                        weight: null,
                        rpe: null,
                        isPR: false
                    });
                }
            }
            
            importedCompleteData = Object.values(studentsMap).map((student, idx) => ({
                ...student,
                trainingDays: Object.values(student.days).map((day, dIdx) => ({
                    id: Date.now() + idx * 1000 + dIdx,
                    name: day.name,
                    blocks: Object.values(day.blocks)
                })),
                days: undefined
            }));
            
            if (importedCompleteData.length > 0) {
                showCompleteImportPreview();
                document.getElementById('btnImportComplete').disabled = false;
            } else {
                alert('‚ùå No se pudieron leer datos');
            }
        }

        function showCompleteImportPreview() {
            document.getElementById('completeImportPreview').style.display = 'block';
            
            let totalStudents = importedCompleteData.length;
            let totalDays = 0, totalBlocks = 0, totalExercises = 0;
            
            importedCompleteData.forEach(student => {
                totalDays += student.trainingDays.length;
                student.trainingDays.forEach(day => {
                    totalBlocks += day.blocks.length;
                    day.blocks.forEach(block => totalExercises += block.exercises.length);
                });
            });
            
            document.getElementById('completeImportCount').textContent = 
                `${totalStudents} alumno${totalStudents > 1 ? 's' : ''}, ${totalDays} d√≠as, ${totalBlocks} bloques, ${totalExercises} ejercicios`;
            
            const container = document.getElementById('completeImportPreviewBody');
            container.innerHTML = importedCompleteData.map(student => `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <h4 style="font-family: 'Inter'; font-size: 16px; margin-bottom: 8px; color: var(--text-primary);">${student.name}</h4>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                        ${student.age} a√±os ¬∑ ${student.weight}kg ¬∑ ${student.monthlyClasses} clases/mes<br>
                        üéØ ${student.goal}
                    </p>
                </div>
            `).join('');
        }

        async function processCompleteImport() {
            if (importedCompleteData.length === 0) return;
            
            let imported = 0;
            importedCompleteData.forEach(data => {
                const student = {
                    id: Date.now() + imported,
                    name: data.name,
                    age: data.age,
                    weight: data.weight,
                    goal: data.goal,
                    monthlyClasses: data.monthlyClasses,
                    trainingDays: data.trainingDays,
                    sessions: [],
                    attendance: {},
                    createdAt: new Date().toISOString(),
                    totalXP: 0,
                    level: 1,
                    badges: [],
                    goals: []
                };
                
                student.trainingDays.forEach(day => {
                    day.blocks.forEach(block => {
                        block.exercises.forEach(ex => {
                            if (!exerciseDatabase.includes(ex.name)) {
                                exerciseDatabase.push(ex.name);
                            }
                        });
                    });
                });
                
                students.push(student);
                imported++;
            });
            
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            
            await saveData();
            renderStudents();
            closeModal('importComplete');
            
            importedCompleteData = [];
            document.getElementById('importCompleteFile').value = '';
            document.getElementById('completeImportPreview').style.display = 'none';
            document.getElementById('btnImportComplete').disabled = true;
            
            showNotification(`‚úÖ ${imported} alumno${imported > 1 ? 's' : ''} importados`, 'success');
        }

        // Import Plan (for current student)
        let importedPlanData = [];

        function handlePlanImport(event) {
            if (!currentStudent) {
                alert('Primero seleccion√° un atleta');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parsePlanData(e.target.result);
            };
            reader.readAsText(file);
        }

        function parsePlanData(text) {
            importedPlanData = [];
            const lines = text.split('\n').filter(line => line.trim());
            const startIndex = lines[0].toLowerCase().includes('dia') ? 1 : 0;
            
            const daysMap = {};
            
            for (let i = startIndex; i < lines.length; i++) {
                const parts = parseCSVLine(lines[i]);
                
                if (parts.length >= 7) {
                    const dayName = parts[0];
                    const blockName = parts[1];
                    const blockType = parts[2];
                    const exerciseName = parts[3];
                    const series = parseInt(parts[4]) || 3;
                    const reps = parts[5];
                    const isPrincipal = parts[6].toUpperCase() === 'SI';
                    
                    if (!daysMap[dayName]) {
                        daysMap[dayName] = { name: dayName, blocks: {} };
                    }
                    
                    const day = daysMap[dayName];
                    
                    if (!day.blocks[blockName]) {
                        day.blocks[blockName] = { name: blockName, type: blockType, exercises: [] };
                    }
                    
                    day.blocks[blockName].exercises.push({
                        name: exerciseName,
                        series: series,
                        reps: reps,
                        isPrincipal: isPrincipal,
                        weight: null,
                        rpe: null,
                        isPR: false
                    });
                }
            }
            
            importedPlanData = Object.values(daysMap).map((day, idx) => ({
                id: Date.now() + idx,
                name: day.name,
                blocks: Object.values(day.blocks)
            }));
            
            if (importedPlanData.length > 0) {
                showPlanImportPreview();
                document.getElementById('btnImportPlan').disabled = false;
            } else {
                alert('‚ùå No se pudieron leer datos');
            }
        }

        function showPlanImportPreview() {
            document.getElementById('planImportPreview').style.display = 'block';
            
            let totalBlocks = 0, totalExercises = 0;
            
            importedPlanData.forEach(day => {
                totalBlocks += day.blocks.length;
                day.blocks.forEach(block => totalExercises += block.exercises.length);
            });
            
            document.getElementById('planImportCount').textContent = 
                `${importedPlanData.length} d√≠a${importedPlanData.length > 1 ? 's' : ''}, ${totalBlocks} bloques, ${totalExercises} ejercicios`;
            
            const container = document.getElementById('planImportPreviewBody');
            container.innerHTML = importedPlanData.map(day => `
                <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; margin-bottom: 8px; color: var(--text-primary);">${day.name}</h4>
                </div>
            `).join('');
        }

        async function processPlanImport() {
            if (!currentStudent || importedPlanData.length === 0) return;
            
            if (!confirm('¬øImportar estos d√≠as?')) return;
            
            if (!currentStudent.trainingDays) currentStudent.trainingDays = [];

            importedPlanData.forEach(day => {
                currentStudent.trainingDays.push(day);
                
                day.blocks.forEach(block => {
                    block.exercises.forEach(ex => {
                        if (!exerciseDatabase.includes(ex.name)) {
                            exerciseDatabase.push(ex.name);
                        }
                    });
                });
            });
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            
            await saveData();
            renderTrainingDays();
            closeModal('importPlan');
            
            importedPlanData = [];
            document.getElementById('importPlanFile').value = '';
            document.getElementById('planImportPreview').style.display = 'none';
            document.getElementById('btnImportPlan').disabled = true;
            
            showNotification('‚úÖ Plan importado', 'success');
        }

        function exportAllDays() {
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) {
                alert('No hay d√≠as para exportar');
                return;
            }

            let csvContent = "Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal\n";
            
            currentStudent.trainingDays.forEach(day => {
                day.blocks.forEach(block => {
                    block.exercises.forEach(ex => {
                        csvContent += [
                            day.name,
                            block.name,
                            block.type,
                            ex.name,
                            ex.series || '',
                            ex.reps || '',
                            ex.isPrincipal ? 'SI' : 'NO'
                        ].join(',') + '\n';
                    });
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `plan_${currentStudent.name.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Edit Session
        function editSession(sessionIndex) {
            if (!currentStudent || !currentStudent.sessions) return;
            
            const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            const monthSessions = currentStudent.sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= monthStart && sessionDate <= monthEnd;
            });
            
            const reversedIndex = monthSessions.length - 1 - sessionIndex;
            const session = monthSessions[reversedIndex];
            
            if (!session) return;
            
            currentEditingSessionIndex = currentStudent.sessions.findIndex(s => 
                s.date === session.date && s.dayName === session.dayName && s.timestamp === session.timestamp
            );
            
            if (currentEditingSessionIndex === -1) return;
            
            document.getElementById('editSessionDate').value = session.date;
            document.getElementById('editSessionDay').value = session.dayName || '-';
            document.getElementById('editSessionBodyWeight').value = session.bodyWeight || currentStudent.weight;
            
            renderEditSessionBlocks(session);
            openModal('editSession');
        }

        function renderEditSessionBlocks(session) {
            const container = document.getElementById('editSessionBlocks');
            
            if (!session.blocks || session.blocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Sin ejercicios</p>';
                return;
            }
            
            const iconMap = {
                'movilidad': 'üì±',
                'core': 'üü°',
                'fuerza-inferior': 'üîµ',
                'fuerza-superior': 'üü£'
            };
            
            container.innerHTML = session.blocks.map((block, blockIdx) => `
                <div class="block block-type-${block.type}" style="margin-bottom: 16px;">
                    <div class="block-header">
                        <div class="block-title">
                            <div class="block-icon">${iconMap[block.type] || 'üìã'}</div>
                            ${block.name}
                        </div>
                    </div>
                    ${block.exercises.map((ex, exIdx) => `
                        <div class="exercise">
                            <div class="exercise-header">
                                <div class="exercise-name">
                                    ${ex.isPrincipal ? '‚≠ê ' : ''}${ex.name}
                                </div>
                            </div>
                            <div class="exercise-inputs">
                                <div class="exercise-input-group">
                                    <label class="exercise-input-label">Series</label>
                                    <input type="number" class="form-input" value="${ex.series || ''}" 
                                           id="editSess_${blockIdx}_${exIdx}_series" min="1" />
                                </div>
                                <div class="exercise-input-group">
                                    <label class="exercise-input-label">Reps</label>
                                    <input type="text" class="form-input" value="${ex.reps || ''}" 
                                           id="editSess_${blockIdx}_${exIdx}_reps" />
                                </div>
                                <div class="exercise-input-group">
                                    <label class="exercise-input-label">Peso (kg)</label>
                                    <input type="number" class="form-input" value="${ex.weight || ''}" 
                                           id="editSess_${blockIdx}_${exIdx}_weight" step="0.5" />
                                </div>
                                <div class="exercise-input-group">
                                    <label class="exercise-input-label">RPE (1-10)</label>
                                    <input type="number" class="form-input" value="${ex.rpe || ''}" 
                                           id="editSess_${blockIdx}_${exIdx}_rpe" min="1" max="10" step="0.5" />
                                </div>
                            </div>
                            ${ex.isPrincipal ? `
                                <div style="margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--accent-blue);">
                                        <input type="checkbox" ${ex.isPR ? 'checked' : ''} 
                                               id="editSess_${blockIdx}_${exIdx}_isPR" />
                                        üèÜ R√©cord Personal
                                    </label>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        async function saveEditedSession() {
            if (currentEditingSessionIndex === null || !currentStudent) return;
            
            const session = currentStudent.sessions[currentEditingSessionIndex];
            
            session.date = document.getElementById('editSessionDate').value;
            session.bodyWeight = parseFloat(document.getElementById('editSessionBodyWeight').value);
            
            let totalVolume = 0;
            let totalRPE = 0;
            let rpeCount = 0;
            let prsCount = 0;
            
            session.blocks.forEach((block, blockIdx) => {
                block.exercises.forEach((ex, exIdx) => {
                    const series = parseInt(document.getElementById(`editSess_${blockIdx}_${exIdx}_series`).value) || ex.series;
                    const reps = document.getElementById(`editSess_${blockIdx}_${exIdx}_reps`).value || ex.reps;
                    const weight = parseFloat(document.getElementById(`editSess_${blockIdx}_${exIdx}_weight`).value) || ex.weight;
                    const rpe = parseFloat(document.getElementById(`editSess_${blockIdx}_${exIdx}_rpe`).value) || ex.rpe;
                    const isPRCheckbox = document.getElementById(`editSess_${blockIdx}_${exIdx}_isPR`);
                    const isPR = isPRCheckbox ? isPRCheckbox.checked : ex.isPR;
                    
                    ex.series = series;
                    ex.reps = reps;
                    ex.weight = weight;
                    ex.rpe = rpe;
                    ex.isPR = isPR;
                    
                    if (weight && series && reps) {
                        const repsNum = parseFloat(reps) || 0;
                        totalVolume += weight * series * repsNum;
                    }
                    
                    if (rpe) {
                        totalRPE += rpe;
                        rpeCount++;
                    }
                    
                    if (isPR) prsCount++;
                });
            });
            
            session.volume = Math.round(totalVolume);
            session.avgRPE = rpeCount > 0 ? parseFloat((totalRPE / rpeCount).toFixed(1)) : 0;
            session.prs = prsCount;
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            updateStudentMetrics(currentStudent);
            
            await saveData();
            closeModal('editSession');
            renderDashboard();
            
            showNotification(`‚úÖ Sesi√≥n actualizada`, 'success');
            
            currentEditingSessionIndex = null;
        }

 async function deleteEditedSession() {
            if (currentEditingSessionIndex === null || !currentStudent) return;
            
            const session = currentStudent.sessions[currentEditingSessionIndex];
            
            if (!confirm(`¬øEliminar sesi√≥n del ${new Date(session.date).toLocaleDateString('es-AR')}?`)) return;
            
            currentStudent.sessions.splice(currentEditingSessionIndex, 1);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) students[studentIndex] = currentStudent;
            
            updateStudentMetrics(currentStudent);
            
            await saveData();
            closeModal('editSession');
            renderDashboard();
            renderStudents();
            
            showNotification('üóëÔ∏è Sesi√≥n eliminada', 'success');
            
            currentEditingSessionIndex = null;
        }
        
        // ============================================
        // üßπ LIMPIEZA COMPLETA DE DUPLICADOS Y BASURA
        // ============================================
        async function cleanAllDuplicatesAndGarbage() {
            console.log('üßπ Iniciando limpieza completa...');
            
            if (!db) {
                console.log('‚ö†Ô∏è Firebase no disponible, limpiando solo local');
                cleanLocalOnly();
                return;
            }
            
            showLoading(true);
            
            try {
                const snapshot = await window.firebaseGetDocs(studentsCollection);
                const allDocs = [];
                
                snapshot.forEach(doc => {
                    allDocs.push({
                        docId: doc.id,
                        data: doc.data()
                    });
                });
                
                console.log('üì¶ Documentos encontrados en Firebase:', allDocs.length);
                
                const validStudents = new Map();
                const seenNames = new Map();
                const garbageDocIds = [];
                
                allDocs.forEach(item => {
                    const student = item.data;
                    
                    // BASURA: Solo rechazar si es realmente basura
            if (!student || !student.id || !student.name) {
                console.log('üóëÔ∏è Basura: Sin ID o nombre');
                garbageDocIds.push(item.docId);
                return;
            }
            
            const nameTrimmed = student.name.trim();
            
            // Rechazar solo si:
            // - Nombre vac√≠o
            // - Contiene texto de error de importaci√≥n
            // - Ya est√° marcado como eliminado
            if (nameTrimmed === '' ||
                nameTrimmed.toLowerCase().startsWith('no se modificaron') ||
                nameTrimmed.toLowerCase() === 'undefined' ||
                nameTrimmed.toLowerCase() === 'null' ||
                student._deleted === true) {
                
                console.log('üóëÔ∏è Basura detectada:', student.name);
                garbageDocIds.push(item.docId);
                return;
            }
                    
                    const nameLower = student.name.toLowerCase().trim();
                    
                    if (seenNames.has(nameLower)) {
                        const existing = seenNames.get(nameLower);
                        const existingSessionsCount = (existing.data.sessions || []).length;
                        const currentSessionsCount = (student.sessions || []).length;
                        
                        if (currentSessionsCount > existingSessionsCount) {
                            console.log('üîÅ Duplicado detectado:', student.name, `- MANTENER este (${currentSessionsCount} sesiones) vs anterior (${existingSessionsCount} sesiones)`);
                            garbageDocIds.push(existing.docId);
                            validStudents.delete(existing.data.id);
                            
                            validStudents.set(student.id, student);
                            seenNames.set(nameLower, { data: student, docId: item.docId });
                        } else {
                            console.log('üîÅ Duplicado detectado:', student.name, `- ELIMINAR este (${currentSessionsCount} sesiones) vs anterior (${existingSessionsCount} sesiones)`);
                            garbageDocIds.push(item.docId);
                        }
                    } else {
                        validStudents.set(student.id, student);
                        seenNames.set(nameLower, { data: student, docId: item.docId });
                    }
                });
                
                console.log('‚úÖ Estudiantes v√°lidos √∫nicos:', validStudents.size);
                console.log('üóëÔ∏è Total a eliminar:', garbageDocIds.length);
                
                if (garbageDocIds.length > 0) {
                    for (const docId of garbageDocIds) {
                        try {
                            const docRef = window.firebaseDoc(db, 'students', docId);
                            await window.firebaseSetDoc(docRef, { _deleted: true, deletedAt: new Date().toISOString() }, { merge: true });
                            console.log('üóëÔ∏è Marcado para eliminar:', docId);
                        } catch (error) {
                            console.error('‚ùå Error eliminando:', docId, error);
                        }
                    }
                }
                
                students = Array.from(validStudents.values());
                localStorage.setItem('gymTracker_students', JSON.stringify(students));
                renderStudents();
                
                showLoading(false);
                showNotification(`‚úÖ Limpieza: ${validStudents.size} √∫nicos, ${garbageDocIds.length} eliminados`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error en limpieza:', error);
                showLoading(false);
                cleanLocalOnly();
            }
        }

        function cleanLocalOnly() {
            console.log('üßπ Limpieza solo localStorage...');
            
            const seen = new Map();
            const cleaned = [];
            
            students.forEach(s => {
                if (!s || !s.id || !s.name || s.name.trim() === '' ||
                    s.name.includes('no se modificaron') ||
                    s.name.toLowerCase().includes('undefined')) {
                    console.log('üóëÔ∏è Basura local:', s.name || 'Sin nombre');
                    return;
                }
                
                if (!seen.has(s.id)) {
                    seen.set(s.id, true);
                    cleaned.push(s);
                } else {
                    console.log('üîÅ Duplicado local:', s.name);
                }
            });
            
            students = cleaned;
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            renderStudents();
            
            showNotification(`üßπ Limpieza local: ${cleaned.length} atletas v√°lidos`, 'info');
        }
    </script>
</body>
</html>
