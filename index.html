<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker - Sistema de Alto Rendimiento</title>
    <style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
       :root {
    /* Dark Theme - Colores principales */
    --bg-primary: #0A1628;
    --bg-secondary: #152238;
    --bg-tertiary: #1E2F45;
    --bg-card: #1A2332;
    
    /* Borders & Dividers */
    --border-color: #2D3E54;
    --border-light: #374151;
    
    /* Text Colors */
    --text-primary: #FFFFFF;
    --text-secondary: #94A3B8;
    --text-muted: #64748B;
    --text-ghost: #475569;
    
    /* Accent Colors */
    --accent-blue: #3B82F6;
    --accent-blue-dark: #2563EB;
    --accent-blue-hover: #1D4ED8;
    --accent-cyan: #06B6D4;
    --accent-green: #10B981;
    --accent-yellow: #FBBF24;
    --accent-red: #EF4444;
    --accent-purple: #8B5CF6;
    
    /* Sidebar */
    --sidebar-bg: #0F172A;
    --sidebar-hover: rgba(59, 130, 246, 0.1);
    --sidebar-active: rgba(59, 130, 246, 0.15);
    
    /* Success/Warning/Danger */
    --success: #10B981;
    --warning: #F59E0B;
    --danger: #EF4444;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
}
   body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    min-height: 100vh;
}
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* HEADER */
       .header {
    background: var(--bg-card);
    padding: 20px 40px;
    box-shadow: 0 1px 0 var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
}
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
       .logo-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    color: var(--text-primary);
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 800;
}
        
        .logo-text p {
    font-size: 11px;
    color: var(--accent-cyan);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-top: 4px;
}
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .sync-btn {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-gray);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sync-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-gray);
            padding: 4px;
            border-radius: 10px;
        }
        
.nav-tab {
    padding: 12px 24px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-tab.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: white;
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
}

.nav-tab:hover:not(.active) {
    background: var(--bg-tertiary);
    border-color: var(--accent-blue);
    color: var(--text-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.nav-tab:hover:not(.active) {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}
        
        /* CONTENT */
        .content {
            padding: 32px 40px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* CARDS */
        .card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
}
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
       .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 24px;
    color: var(--text-primary);
    text-transform: capitalize;
    letter-spacing: 0px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
}
        
        /* BUTTONS */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--dark-blue);
        }
        
        .btn-secondary {
            background: var(--bg-gray);
            color: var(--text-gray);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 11px;
        }
        
        /* TRAINING DAY CARD */
        .training-day-card {
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .training-day-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        .training-day-card h3 {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--text-dark);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .training-day-card p {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 12px;
        }
        
        .training-day-badge {
            display: inline-block;
            background: var(--bg-gray);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
        }
        
        .delete-day-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .training-day-card:hover .delete-day-btn {
            opacity: 1;
        }
        
        /* STUDENTS GRID */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .student-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.student-card:hover {
    border-color: var(--accent-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}
        
            .student-name {
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .student-info {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }
        
        .student-goal {
            font-size: 12px;
            color: var(--primary-blue);
            font-weight: 700;
            margin-top: 12px;
        }
        
        /* BLOCKS */
        .block {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .block-title {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--text-dark);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .block-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .block-type-movilidad .block-icon { background: #FEF3C7; }
        .block-type-core .block-icon { background: #FED7AA; }
        .block-type-fuerza-inferior .block-icon { background: #DBEAFE; }
        .block-type-fuerza-superior .block-icon { background: #F3E8FF; }
        
        .exercise {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .exercise-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .exercise-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .exercise-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .exercise-input-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .exercise-input {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }
        
        .exercise-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        /* FORMS */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .form-input {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: var(--bg-secondary);
}
        
        /* MODAL */
        .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    backdrop-filter: blur(4px);
}
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
        
        .modal-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            color: var(--text-dark);
            text-transform: uppercase;
            margin-bottom: 24px;
        }
        
        /* LOADING */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-white);
            padding: 24px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 700;
            color: var(--primary-blue);
        }
        
        .loading.active {
            display: block;
        }
        
        /* CONFIG BANNER */
        .config-banner {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #FCD34D;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .config-banner.configured {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-color: #6EE7B7;
        }
        
        .config-icon {
            font-size: 32px;
        }
        
        .config-text h3 {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .config-text p {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        /* METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        
        /* MONTH COMPARISON */
        .month-comparison {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .month-box {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        
        .month-box.current {
            background: var(--primary-blue);
            color: white;
        }
        
        .month-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .month-value {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
        }
        
        /* ATTENDANCE */
        .attendance-section {
            margin-bottom: 32px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .attendance-title {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            text-transform: uppercase;
        }
        
        .goal-progress-bar {
            width: 100%;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
            transition: width 0.3s;
        }
        
        /* PROGRESS TABLE */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .progress-table th {
    text-align: left;
    padding: 12px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border-color);
}
        
       .progress-table td {
    padding: 16px 12px;
    border-bottom: 1px solid var(--border-color);
    font-size: 13px;
    color: var(--text-secondary);
}
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        /* ================================================
           RESPONSIVE DESIGN - MOBILE
           ================================================ */
        
        @media (max-width: 768px) {
            /* Layout m√≥vil */
            .app-container {
                padding: 0;
            }
            
            .header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .logo-section {
                flex: 1 1 100%;
                justify-content: center;
            }
            
            .nav-buttons {
                flex: 1 1 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .nav-buttons button {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            /* Contenido principal */
            .main-content {
                padding: 16px;
            }
            
            /* Cards de estudiantes */
            .students-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            
            .student-card {
                padding: 16px;
            }
            
            .student-name {
                font-size: 18px;
            }
            
            /* M√©tricas */
            .metrics-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px;
            }
            
            .metric-card {
                padding: 16px;
            }
            
            .metric-value {
                font-size: 28px;
            }
            
            /* Training days */
            .training-days-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Formularios */
            .form-input, .form-select {
                font-size: 16px; /* Evita zoom en iOS */
            }
            
            /* Modales */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Botones m√°s grandes para tocar */
            button, .btn {
                min-height: 44px; /* iOS guideline */
                font-size: 14px;
            }
            
            /* Tablas responsive */
            .progress-table {
                font-size: 12px;
            }
            
            .progress-table th,
            .progress-table td {
                padding: 8px 4px;
            }
            
            /* Ocultar elementos innecesarios en mobile */
            .month-comparison {
                display: none;
            }
            
            /* Dashboard m√°s compacto */
            .card {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            /* Attendance section */
            .attendance-section {
                padding: 12px;
            }
            
            /* Config banner mobile */
            .config-banner {
                font-size: 12px;
                padding: 8px;
            }
            
            /* Buscador m√≥vil */
            #searchStudent {
                width: 100%;
                max-width: 100% !important;
            }
            
            /* Training day card */
            .training-day-card {
                min-height: auto;
                padding: 16px;
            }
            
            /* Blocks */
            .block {
                margin-bottom: 16px;
            }
            
            .block-header {
                padding: 12px;
                flex-wrap: wrap;
            }
            
            /* Exercise table responsive */
            .exercise-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Inputs en ejercicios m√°s grandes */
            .exercise-table input {
                min-width: 60px;
                font-size: 16px;
            }
        }
        
        /* T√°ctil - √°reas m√°s grandes */
        @media (hover: none) and (pointer: coarse) {
            button, .btn {
                min-height: 48px;
                padding: 12px 20px;
            }
            
            .student-card {
                min-height: 100px;
            }
        }
        /* GAMIFICACI√ìN MEJORADA */
.gamification-card {
    background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue));
    border-radius: 16px;
    padding: 32px;
    color: white;
    margin-bottom: 24px;
    border: none;
}

.level-display {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.level-badge-large {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 800;
    backdrop-filter: blur(10px);
}

.xp-info {
    flex: 1;
    margin-left: 24px;
}

.xp-value {
    font-size: 32px;
    font-weight: 800;
}

.xp-label {
    font-size: 14px;
    opacity: 0.9;
}

.xp-progress-bar {
    background: rgba(255, 255, 255, 0.2);
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
    margin-top: 12px;
}

.xp-progress-fill {
    background: var(--accent-cyan);
    height: 100%;
    transition: width 0.3s;
}

/* BADGES GRID */
.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.badge-item {
    background: var(--bg-tertiary);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.badge-icon-large {
    font-size: 48px;
    margin-bottom: 12px;
}

.badge-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon" id="appLogo"></div>
                <div class="logo-text">
                    <h1>TRACKER</h1>
                    <p>Precision Engineered</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="sync-btn" id="syncBtn" onclick="syncFromSheets()" style="display: none;">
                    üîÑ Sincronizar
                </button>
                <nav style="display: flex; gap: 12px; align-items: center;">
    <button class="nav-tab active" onclick="switchView('alumnos')" style="background: var(--accent-blue); border: 1px solid var(--accent-blue); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">
        üë• ATLETAS
    </button>
    <button class="nav-tab" onclick="switchView('dashboard')" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">
        üìä M√âTRICAS
    </button>
    <button class="nav-tab" onclick="switchView('plan')" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">
        üìã PLAN
    </button>
    <button class="nav-tab" onclick="switchView('config')" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">
        ‚öôÔ∏è CONFIG
    </button>
</nav>
            </div>
        </div>

        <div class="loading" id="loading">Cargando...</div>

        <!-- VIEW: ALUMNOS -->
        <div id="view-alumnos" class="view active content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Atletas</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="text" id="searchStudent" class="form-input" placeholder="üîç Buscar atleta..." 
                               style="max-width: 300px; margin: 0;" onkeyup="filterStudents()" />
<button class="btn btn-secondary" type="button" id="btnOpenImportCSV">üì• Importar Completo (CSV)</button>
                        <button class="btn btn-primary" onclick="openModal('addStudent')">
                            ‚ûï Nuevo Atleta
                        </button>
                    </div>
                </div>
                <div id="studentsContainer" class="students-grid"></div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìä M√âTRICAS DE <span id="dashboardStudentName" style="color: var(--primary-blue);">-</span>
                    </h2>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê Mes Anterior</button>
                        <span id="currentMonthDisplay" style="font-size: 14px; font-weight: 700; color: var(--text-gray); min-width: 150px; text-align: center;">-</span>
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Mes Siguiente ‚Üí</button>
                    </div>
                </div>

                <div id="dashboardContent">
                    <p style="text-align: center; color: var(--text-gray); padding: 40px;">
                        Seleccion√° un atleta para ver sus m√©tricas
                    </p>
                </div>
            </div>
        </div>

        <!-- VIEW: PLAN -->
        <div id="view-plan" class="view content">
            <div class="card" id="planDaysCard">
                <div class="card-header">
                    <h2 class="card-title">üìã Plan de <span id="currentStudentName">-</span></h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="openModal('importPlan')">
                            üì• Importar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportAllDays()">
                            üì§ Exportar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="switchView('alumnos')">‚Üê Volver</button>
                    </div>
                </div>
                
                <div id="trainingDaysList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- Days will be rendered here -->
                </div>
                
                <button class="btn btn-primary" onclick="openModal('addTrainingDay')">
                    ‚ûï Agregar D√≠a de Entrenamiento
                </button>
            </div>

            <!-- Current Day View -->
            <div class="card" id="currentDayView" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        üèãÔ∏è <span id="currentDayTitle">-</span>
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="closeDayView()">‚Üê Volver a D√≠as</button>
                        <button class="btn btn-primary btn-sm" onclick="saveSession()">üíæ Guardar Sesi√≥n</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 32px; display: grid; grid-template-columns: 1fr 180px; gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">üìÖ Fecha Sesi√≥n</label>
                        <input type="date" id="sessionDate" class="form-input" />
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">‚öñÔ∏è Peso Corporal (kg)</label>
                        <input type="number" id="bodyWeight" class="form-input" placeholder="75" step="0.1" />
                    </div>
                </div>

                <div id="blocksContainer"></div>

                <button class="btn btn-secondary" onclick="openModal('addBlock')" style="margin-top: 24px;">
                    ‚ûï Agregar Bloque
                </button>
            </div>
        </div>

        <!-- VIEW: CONFIG -->
        <div id="view-config" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Configuraci√≥n</h2>
                </div>

                <div id="configBanner" class="config-banner">
                    <div class="config-icon">‚ö†Ô∏è</div>
                    <div class="config-text">
                        <h3>Configuraci√≥n Requerida</h3>
                        <p>Conect√° tu Google Sheet para guardar datos en la nube</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">üîó URL de Google Apps Script</label>
                    <input type="text" id="sheetsUrl" class="form-input" placeholder="https://script.google.com/..." />
                    <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">
                        La URL debe terminar en /exec
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveConfig()">Guardar Configuraci√≥n</button>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar Configuraci√≥n</button>

<!-- üî• NUEVO BOT√ìN -->
<button class="btn btn-secondary" onclick="forceSyncAll()" style="margin-top: 12px;">
    üîÑ Sincronizar Ahora (Forzar)
</button>

                <hr style="margin: 40px 0; border: none; border-top: 2px solid var(--border);">

                <h3 style="font-family: 'Inter'; font-size: 16px; margin-bottom: 20px; text-transform: uppercase;">üé® Personalizaci√≥n</h3>

                <div class="form-group">
                    <label class="form-label">Logo Personalizado</label>
                    <input type="file" id="logoUpload" class="form-input" accept="image/*" onchange="handleLogoUpload(event)" />
                    <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">
                        Recomendado: PNG con fondo transparente, 200x200px
                    </div>
                </div>

                <div id="logoPreview" style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-gray); border-radius: 12px;">
                    <img id="logoPreviewImg" style="max-width: 100px; height: auto; display: block; margin-bottom: 12px;" />
                    <button class="btn btn-secondary btn-sm" onclick="removeLogo()">üóëÔ∏è Eliminar Logo</button>
                </div>
            </div>
        </div>


        <!-- MODALS -->
        
        <!-- Add Student Modal -->
        <div id="modal-addStudent" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Atleta</h3>
                <form onsubmit="addStudent(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="studentName" class="form-input" required />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" id="studentAge" class="form-input" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="studentWeight" class="form-input" required step="0.1" min="1" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <input type="text" id="studentGoal" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clases Mensuales</label>
                        <input type="number" id="studentClasses" class="form-input" required min="1" />
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear Atleta</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudent')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ‚ú® PEG√Å EL NUEVO MODAL AC√Å ‚ú® -->
        <!-- Edit Student Modal -->
        <div id="modal-editStudent" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚úèÔ∏è Editar Atleta</h3>
                <form id="editStudentForm" onsubmit="updateStudent(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="editStudentName" class="form-input" required />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" id="editStudentAge" class="form-input" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="editStudentWeight" class="form-input" required step="0.1" min="1" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <input type="text" id="editStudentGoal" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clases Mensuales</label>
                        <input type="number" id="editStudentClasses" class="form-input" required min="1" />
                        <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">
                            üí° Pod√©s cambiar este n√∫mero cada mes seg√∫n la cantidad de clases que va a hacer
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Guardar Cambios</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editStudent')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Add Training Day Modal -->
        <div id="modal-addTrainingDay" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo D√≠a de Entrenamiento</h3>
                <form onsubmit="addTrainingDay(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del D√≠a</label>
                        <input type="text" id="dayName" class="form-input" placeholder="ej: D√≠a A - Tren Superior" required />
                        <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">
                            Ejemplos: "D√≠a A", "D√≠a 1 - Tren Superior", "Lunes - Push"
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear D√≠a</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addTrainingDay')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Block Modal -->
        <div id="modal-addBlock" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Bloque</h3>
                <form onsubmit="addBlock(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Bloque</label>
                        <input type="text" id="blockName" class="form-input" placeholder="ej: Calentamiento" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Bloque</label>
                        <select id="blockType" class="form-input" required>
                            <option value="movilidad">Movilidad</option>
                            <option value="core">Core</option>
                            <option value="fuerza-inferior">Fuerza - Tren Inferior</option>
                            <option value="fuerza-superior">Fuerza - Tren Superior</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Bloque</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBlock')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Exercise Modal -->
        <div id="modal-addExercise" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Ejercicio</h3>
                <form onsubmit="addExercise(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Ejercicio</label>
                        <input type="text" id="exerciseName" class="form-input" placeholder="Press de banca" required list="exercisesList" />
                        <datalist id="exercisesList"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Series</label>
                            <input type="number" id="exerciseSeries" class="form-input" placeholder="3" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Repeticiones</label>
                            <input type="text" id="exerciseReps" class="form-input" placeholder="10" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="exerciseIsPrincipal" />
                            <span style="font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Marcar como principal (tracking de PR)</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Ejercicio</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addExercise')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Import Complete Modal -->
        <div id="modal-importComplete" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h3 class="modal-title">üì• Importaci√≥n Completa - Alumnos + D√≠as + Planes</h3>
                
                <div style="background: var(--bg-gray); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">üìã Formato Requerido</h4>
                    <p style="font-size: 13px; color: var(--text-gray); margin-bottom: 12px; line-height: 1.6;">
                        Tu archivo CSV debe tener estas columnas:
                    </p>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 10px; overflow-x: auto;">
                        <strong>Alumno,Edad,Peso,Objetivo,Clases,Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                    <p style="font-size: 12px; color: var(--text-gray); margin-top: 12px;">
                        <strong>Ejemplo:</strong><br>
                        <span style="font-family: monospace; font-size: 10px;">
                        Juan,25,75,Masa,12,D√≠a A,Movilidad,movilidad,Rotaciones,2,10,NO<br>
                        Juan,25,75,Masa,12,D√≠a A,Core,core,Plancha,3,30,NO<br>
                        Juan,25,75,Masa,12,D√≠a B,Fuerza,fuerza-inferior,Sentadilla,4,6,SI
                        </span>
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importCompleteFile" class="form-input" accept=".csv" onchange="handleCompleteImport(event)" />
                </div>

                <div id="completeImportPreview" style="display: none; margin-top: 20px;">
                    <h4 style="font-family: 'Inter'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">Vista Previa</h4>
                    <div style="max-height: 300px; overflow-y: auto; background: var(--bg-gray); padding: 16px; border-radius: 8px;">
                        <div id="completeImportPreviewBody" style="font-size: 13px;"></div>
                    </div>
                    <p id="completeImportCount" style="font-size: 13px; font-weight: 700; color: var(--primary-blue); margin-top: 12px;"></p>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processCompleteImport()" id="btnImportComplete" disabled>
                        ‚úì Importar Todo
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importComplete')">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Import Plan Modal -->
        <div id="modal-importPlan" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <h3 class="modal-title">üì• Importar D√≠as + Planes</h3>
                
                <div style="background: var(--bg-gray); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="background: white; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px; overflow-x: auto;">
                        <strong>Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importPlanFile" class="form-input" accept=".csv" onchange="handlePlanImport(event)" />
                </div>

                <div id="planImportPreview" style="display: none; margin-top: 20px;">
                    <div id="planImportPreviewBody"></div>
                    <p id="planImportCount" style="font-size: 13px; font-weight: 700; color: var(--primary-blue); margin-top: 12px;"></p>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processPlanImport()" id="btnImportPlan" disabled>
                        ‚úì Importar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importPlan')">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // GLOBAL STATE
        let students = [];
        let exerciseDatabase = JSON.parse(localStorage.getItem('gymTracker_exercises')) || [];
        let currentStudent = null;
        let currentDay = null; // Current training day being viewed/edited
        let currentBlockForExercise = null;
        let lastSyncTimestamp = null;
        let isSyncing = false;
        let sheetsUrl = localStorage.getItem('gymTracker_sheetsUrl') || '';
        let currentMonth = new Date();
        let customLogo = localStorage.getItem('gymTracker_customLogo') || null;

        // INITIALIZE
        function initialize() {
            loadLogo();
            
            const savedUrl = localStorage.getItem('gymTracker_sheetsUrl');
            if (savedUrl) {
                sheetsUrl = savedUrl;
                document.getElementById('sheetsUrl').value = savedUrl;
                updateConfigBanner(true);
                // AUTO-SYNC: Cargar autom√°ticamente
                loadFromSheetsAuto();
            } else {
                updateConfigBanner(false);
                const localData = localStorage.getItem('gymTracker_students');
                if (localData) {
                    students = JSON.parse(localData);
                    // Migrate old data to new structure if needed
                    students = students.map(s => {
                        if (!s.trainingDays && s.blocks) {
                            // Old format - convert to new
                            return {
                                ...s,
                                trainingDays: [{
                                    id: Date.now(),
                                    name: "Plan Principal",
                                    blocks: s.blocks
                                }],
                                blocks: undefined
                            };
                        }
                        return s;
                    });
                    renderStudents();
                }
            }
            
            updateExercisesList();
            updateMonthDisplay();
            
            // Set today's date
            document.getElementById('sessionDate').valueAsDate = new Date();
        }
    
initialize();

// FIX: Bot√≥n de importar
setTimeout(function() {
    const btn = document.getElementById('btnOpenImportCSV');
    if (btn) {
        btn.addEventListener('click', function() {
            document.getElementById('modal-importComplete').classList.add('active');
        });
    }
}, 100);
        // LOGO MANAGEMENT
        function loadLogo() {
            const logoContainer = document.getElementById('appLogo');
            
            if (customLogo) {
                logoContainer.innerHTML = `<img src="${customLogo}" alt="Logo" style="width: 64px; height: 64px; object-fit: contain;" />`;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPreviewImg').src = customLogo;
            } else {
                logoContainer.innerHTML = `
                    <div style="width: 64px; height: 64px; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'Inter'; font-size: 32px; color: white; letter-spacing: -2px;">T</div>
                `;
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor seleccion√° una imagen v√°lida');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                customLogo = e.target.result;
                localStorage.setItem('gymTracker_customLogo', customLogo);
                loadLogo();
                alert('‚úÖ Logo actualizado!');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (confirm('¬øEliminar logo personalizado?')) {
                customLogo = null;
                localStorage.removeItem('gymTracker_customLogo');
                document.getElementById('logoPreview').style.display = 'none';
                document.getElementById('logoUpload').value = '';
                loadLogo();
                alert('‚úÖ Logo eliminado');
            }
        }

        // MONTH NAVIGATION
        function updateMonthDisplay() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('currentMonthDisplay').textContent = 
                `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            updateMonthDisplay();
            if (currentStudent) {
                renderDashboard();
            }
        }

        // CONFIG
        function saveConfig() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) {
                alert('Por favor ingres√° la URL de Google Apps Script');
                return;
            }
            
            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                alert('La URL debe ser de Google Apps Script y terminar en /exec');
                return;
            }
            
            sheetsUrl = url;
            localStorage.setItem('gymTracker_sheetsUrl', url);
            updateConfigBanner(true);
            document.getElementById('syncBtn').style.display = 'block';
            
            loadFromSheets().then(() => {
                alert('‚úÖ Configuraci√≥n guardada!');
            });
        }

        function updateConfigBanner(configured) {
            const banner = document.getElementById('configBanner');
            if (configured) {
                banner.className = 'config-banner configured';
                banner.innerHTML = `
                    <div class="config-icon">‚úÖ</div>
                    <div class="config-text">
                        <h3>Conectado a Google Sheets</h3>
                        <p>Los datos se guardan autom√°ticamente en la nube</p>
                    </div>
                `;
                document.getElementById('syncBtn').style.display = 'block';
            } else {
                banner.className = 'config-banner';
                banner.innerHTML = `
                    <div class="config-icon">‚ö†Ô∏è</div>
                    <div class="config-text">
                        <h3>Configuraci√≥n Requerida</h3>
                        <p>Conect√° tu Google Sheet para guardar datos en la nube</p>
                    </div>
                `;
                document.getElementById('syncBtn').style.display = 'none';
            }
        }
        
        async function syncFromSheets() {
            if (!sheetsUrl) {
                alert('No hay URL de Sheets configurada');
                return;
            }
            
            if (confirm('¬øCargar datos desde Google Sheets? Esto sobrescribir√° los datos locales.')) {
                await loadFromSheets();
                alert('‚úÖ Datos sincronizados');
            }
        }

       async function loadFromSheets() {
    if (!sheetsUrl) return;

    showLoading(true);
    
    try {
        const response = await fetch(sheetsUrl + '?action=loadStudents', {
            method: 'GET',
            redirect: 'follow'
        });
        
        if (!response.ok) throw new Error('Error en respuesta');
        
        const data = await response.json();
        
        if (data.students && Array.isArray(data.students)) {
            // üî• CR√çTICO: Asegurar que se cargan TODAS las m√©tricas
            students = data.students.map(student => ({
                ...student,
                totalXP: student.totalXP || 0,
                level: student.level || 1,
                badges: student.badges || [],
                goals: student.goals || [],
                sessions: student.sessions || [],
                trainingDays: student.trainingDays || []
            }));
            
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            renderStudents();
            console.log('‚úÖ Datos cargados desde Sheets:', students.length, 'atletas con m√©tricas');
            
            // Mostrar resumen de lo que se carg√≥
            students.forEach(s => {
                console.log(`üìä ${s.name}: XP=${s.totalXP}, Nivel=${s.level}, Badges=${(s.badges || []).length}, Sesiones=${(s.sessions || []).length}`);
            });
        } else {
            students = [];
            renderStudents();
        }
    } catch (error) {
        console.error('‚ùå Error cargando desde Sheets:', error);
        
        // Fallback a localStorage
        const localData = localStorage.getItem('gymTracker_students');
        if (localData) {
            students = JSON.parse(localData);
            renderStudents();
            console.log('üìÇ Cargado desde localStorage como backup');
        } else {
            alert('No se pudo conectar con Google Sheets y no hay datos locales');
        }
    }
    
    showLoading(false);
}

     async function saveToSheets() {
    // Guardar en localStorage SIEMPRE (backup)
    localStorage.setItem('gymTracker_students', JSON.stringify(students));
    
    if (!sheetsUrl) {
        console.log('üíæ Guardado solo en localStorage (no hay URL de Sheets)');
        return;
    }

    showLoading(true);
    
    try {
        // üî• CR√çTICO: Asegurar que TODAS las m√©tricas se incluyen
        const dataToSave = students.map(student => ({
            ...student,
            // M√©tricas de gamificaci√≥n
            totalXP: student.totalXP || 0,
            level: student.level || 1,
            badges: student.badges || [],
            goals: student.goals || [],
            // Otros datos
            sessions: student.sessions || [],
            trainingDays: student.trainingDays || []
        }));

        console.log('üíæ Guardando en Sheets:', dataToSave.length, 'estudiantes con m√©tricas completas');
        
        await fetch(sheetsUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'saveStudents',
                students: dataToSave
            })
        });
        
        console.log('‚úÖ Guardado en Sheets + localStorage');
    } catch (error) {
        console.error('‚ö†Ô∏è Error guardando en Sheets:', error);
        alert('‚ö†Ô∏è Error al sincronizar con Sheets. Los datos est√°n guardados localmente.');
    }
    
    showLoading(false);
}

        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading active' : 'loading';
        }

        // NAVIGATION
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`view-${viewName}`).classList.add('active');
            event.target.classList.add('active');

            if (viewName === 'dashboard' && currentStudent) {
                renderDashboard();
            }
        }

        // MODAL
        function openModal(modalName) {
            document.getElementById(`modal-${modalName}`).classList.add('active');
        }

        function closeModal(modalName) {
            document.getElementById(`modal-${modalName}`).classList.remove('active');
        }



        // FILTER STUDENTS
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const cards = document.querySelectorAll('.student-card');
            
            cards.forEach(card => {
                const studentName = card.querySelector('.student-name').textContent.toLowerCase();
                if (studentName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
// DELETE STUDENT
function deleteStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    if (!confirm('¬øEliminar a ' + student.name + ' y todas sus sesiones?')) return;
    
    students = students.filter(s => s.id !== studentId);
    
    if (currentStudent && currentStudent.id === studentId) {
        currentStudent = null;
        currentDay = null;
    }
    
    saveToSheets();
    renderStudents();
    
    alert('‚úÖ ' + student.name + ' eliminado');
}
    // EDIT STUDENT
function editStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    // Llenar el modal con los datos actuales
    document.getElementById('editStudentName').value = student.name;
    document.getElementById('editStudentAge').value = student.age;
    document.getElementById('editStudentWeight').value = student.weight;
    document.getElementById('editStudentGoal').value = student.goal;
    document.getElementById('editStudentClasses').value = student.monthlyClasses;
    
    // Guardar el ID del estudiante que se est√° editando
    document.getElementById('editStudentForm').dataset.studentId = studentId;
    
    openModal('editStudent');
}

function updateStudent(e) {
    e.preventDefault();
    
    const studentId = parseInt(document.getElementById('editStudentForm').dataset.studentId);
    const studentIndex = students.findIndex(s => s.id === studentId);
    
    if (studentIndex === -1) {
        alert('Error: Estudiante no encontrado');
        return;
    }
    
    // Actualizar los datos
    students[studentIndex].name = document.getElementById('editStudentName').value;
    students[studentIndex].age = parseInt(document.getElementById('editStudentAge').value);
    students[studentIndex].weight = parseFloat(document.getElementById('editStudentWeight').value);
    students[studentIndex].goal = document.getElementById('editStudentGoal').value;
    students[studentIndex].monthlyClasses = parseInt(document.getElementById('editStudentClasses').value);
    
    // Si es el estudiante actual, actualizar tambi√©n
    if (currentStudent && currentStudent.id === studentId) {
        currentStudent = students[studentIndex];
        document.getElementById('currentStudentName').textContent = currentStudent.name;
        document.getElementById('bodyWeight').value = currentStudent.weight;
    }
    
    saveToSheets();
    renderStudents();
    closeModal('editStudent');
    
    alert('‚úÖ Datos de ' + students[studentIndex].name + ' actualizados correctamente');
}
        // STUDENTS
        function addStudent(e) {
            e.preventDefault();
            
            const student = {
                id: Date.now(),
                name: document.getElementById('studentName').value,
                age: parseInt(document.getElementById('studentAge').value),
                weight: parseFloat(document.getElementById('studentWeight').value),
                goal: document.getElementById('studentGoal').value,
                monthlyClasses: parseInt(document.getElementById('studentClasses').value),
                trainingDays: [], // Array of training days
                sessions: [],
                attendance: {},
                createdAt: new Date().toISOString()
            };

            students.push(student);
            saveToSheets();
            renderStudents();
            closeModal('addStudent');
            e.target.reset();
        }

        function renderStudents() {
            const container = document.getElementById('studentsContainer');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">No hay atletas. Agreg√° uno nuevo o import√° desde CSV.</p>';
                return;
            }

            container.innerHTML = students.map(student => {
                const daysCount = student.trainingDays ? student.trainingDays.length : 0;
                const sessionsCount = student.sessions ? student.sessions.length : 0;
                
                return `
                    <div class="student-card" onclick="selectStudent(${student.id})" style="position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editStudent(${student.id})" style="padding: 6px 10px; background: var(--primary-blue); color: white;">‚úèÔ∏è</button>
    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); deleteStudent(${student.id})" style="padding: 6px 10px; background: var(--danger); color: white;">üóëÔ∏è</button>
</div>
                        <div class="student-name">${student.name}</div>
                        <div class="student-info">üìÖ ${student.age} a√±os ‚Ä¢ ‚öñÔ∏è ${student.weight}kg</div>
                        <div class="student-info">üéØ ${student.monthlyClasses} clases/mes</div>
                        <div class="student-info">üèãÔ∏è ${daysCount} d√≠a${daysCount !== 1 ? 's' : ''} de entrenamiento</div>
                        <div class="student-info">üìä ${sessionsCount} sesiones guardadas</div>
                        <div class="student-goal">${student.goal}</div>
                    </div>
                `;
            }).join('');
        }

        function selectStudent(studentId) {
            currentStudent = students.find(s => s.id === studentId);
            currentDay = null;
            
            document.getElementById('currentStudentName').textContent = currentStudent.name;
            document.getElementById('bodyWeight').value = currentStudent.weight;
            
            switchView('plan');
            renderTrainingDays();
        }


        // DUPLICATE TRAINING DAY
        function duplicateTrainingDay(dayId) {
            const originalDay = currentStudent.trainingDays.find(function(d) { return d.id === dayId; });
            if (!originalDay) return;
            
            const newDayName = prompt('Nombre del nuevo d√≠a:', originalDay.name + ' (copia)');
            if (!newDayName) return;
            
            // Clonar d√≠a completo
            const newDay = {
                id: Date.now(),
                name: newDayName,
                blocks: JSON.parse(JSON.stringify(originalDay.blocks)) // Deep clone
            };
            
            currentStudent.trainingDays.push(newDay);
            
            const studentIndex = students.findIndex(function(s) { return s.id === currentStudent.id; });
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
            
            saveToSheets();
            renderTrainingDays();
            
            alert('‚úÖ D√≠a "' + newDayName + '" creado con ' + newDay.blocks.length + ' bloques copiados!');
        }

        // EDIT TRAINING DAY
        function editTrainingDay(dayId) {
            const day = currentStudent.trainingDays.find(function(d) { return d.id === dayId; });
            if (!day) return;
            
            const newName = prompt('Nuevo nombre del d√≠a:', day.name);
            if (!newName || newName === day.name) return;
            
            day.name = newName;
            
            const dayIndex = currentStudent.trainingDays.findIndex(function(d) { return d.id === dayId; });
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = day;
            }
            
            const studentIndex = students.findIndex(function(s) { return s.id === currentStudent.id; });
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
            
            saveToSheets();
            renderTrainingDays();
            
            alert('‚úÖ D√≠a renombrado a "' + newName + '"');
        }

        // EDIT BLOCK
        function editBlock(blockIndex) {
            if (!currentDay || !currentDay.blocks[blockIndex]) return;
            
            const block = currentDay.blocks[blockIndex];
            
            const newName = prompt('Nuevo nombre del bloque:', block.name);
            if (!newName) return;
            
            block.name = newName;
            
            const dayIndex = currentStudent.trainingDays.findIndex(function(d) { return d.id === currentDay.id; });
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = currentDay;
            }
            
            const studentIndex = students.findIndex(function(s) { return s.id === currentStudent.id; });
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
            
            saveToSheets();
            loadTrainingDay();
            
            alert('‚úÖ Bloque renombrado a "' + newName + '"');
        }

        // EDIT EXERCISE
        let editingExercise = null;

        function editExercise(blockIndex, exIndex) {
    if (!currentDay || !currentDay.blocks[blockIndex]) return;
    
    const exercise = currentDay.blocks[blockIndex].exercises[exIndex];
    
    // ‚≠ê IMPORTANTE: Establecer el bloque actual
    currentBlockForExercise = blockIndex;
    editingExercise = { blockIndex: blockIndex, exIndex: exIndex };
    
    // Llenar modal con datos actuales
    document.getElementById('exerciseName').value = exercise.name;
    document.getElementById('exerciseSeries').value = exercise.series;
    document.getElementById('exerciseReps').value = exercise.reps;
    document.getElementById('exerciseIsPrincipal').checked = exercise.isPrincipal;
    
    // Cambiar el t√≠tulo del modal
    document.querySelector('#modal-addExercise .modal-title').textContent = '‚úèÔ∏è Editar Ejercicio';
    
    openModal('addExercise');
}

        // TRAINING DAYS
        function addTrainingDay(e) {
            e.preventDefault();
            
            if (!currentStudent) {
                alert('Primero seleccion√° un atleta');
                return;
            }

            const day = {
                id: Date.now(),
                name: document.getElementById('dayName').value,
                blocks: []
            };

            if (!currentStudent.trainingDays) {
                currentStudent.trainingDays = [];
            }

            currentStudent.trainingDays.push(day);
            
            // Update student in array
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }

            saveToSheets();
            renderTrainingDays();
            closeModal('addTrainingDay');
            e.target.reset();
        }

        function renderTrainingDays() {
            const container = document.getElementById('trainingDaysList');
            
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px; grid-column: 1/-1;">No hay d√≠as de entrenamiento. Agreg√° uno nuevo o import√° un plan.</p>';
                document.getElementById('planDaysCard').style.display = 'block';
                document.getElementById('currentDayView').style.display = 'none';
                return;
            }

            container.innerHTML = currentStudent.trainingDays.map(day => {
                const blocksCount = day.blocks ? day.blocks.length : 0;
                const exercisesCount = day.blocks ? day.blocks.reduce((sum, b) => sum + (b.exercises ? b.exercises.length : 0), 0) : 0;
                
                return `
                    <div class="training-day-card" onclick="selectTrainingDay(${day.id})" style="position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editTrainingDay(${day.id})" style="padding: 6px 10px; font-size: 11px;">‚úèÔ∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); duplicateTrainingDay(${day.id})" style="padding: 6px 10px; font-size: 11px; background: var(--success); color: white;">üìã</button>
                            <button class="delete-day-btn" onclick="event.stopPropagation(); deleteTrainingDay(${day.id})">üóëÔ∏è</button>
                        </div>
                        <h3>${day.name}</h3>
                        <p>${blocksCount} bloque${blocksCount !== 1 ? 's' : ''} ‚Ä¢ ${exercisesCount} ejercicios</p>
                        <span class="training-day-badge">Click para entrenar</span>
                    </div>
                `;
            }).join('');

            document.getElementById('planDaysCard').style.display = 'block';
            document.getElementById('currentDayView').style.display = 'none';
        }

        function selectTrainingDay(dayId) {
            currentDay = currentStudent.trainingDays.find(d => d.id === dayId);
            if (!currentDay) return;

            document.getElementById('currentDayTitle').textContent = currentDay.name;
            document.getElementById('planDaysCard').style.display = 'none';
            document.getElementById('currentDayView').style.display = 'block';
            
            loadTrainingDay();
        }

        function closeDayView() {
            currentDay = null;
            renderTrainingDays();
        }

        function deleteTrainingDay(dayId) {
            if (!confirm('¬øEliminar este d√≠a de entrenamiento?')) return;

            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === dayId);
            if (dayIndex !== -1) {
                currentStudent.trainingDays.splice(dayIndex, 1);
                
                const studentIndex = students.findIndex(s => s.id === currentStudent.id);
                if (studentIndex !== -1) {
                    students[studentIndex] = currentStudent;
                }

                saveToSheets();
                renderTrainingDays();
            }
        }

        function loadTrainingDay() {
            if (!currentDay) return;

            const container = document.getElementById('blocksContainer');
            
            if (!currentDay.blocks || currentDay.blocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">No hay bloques. Agreg√° uno nuevo.</p>';
                return;
            }

            container.innerHTML = currentDay.blocks.map((block, blockIndex) => {
                const iconMap = {
                    'movilidad': 'üì±',
                    'core': 'üü°',
                    'fuerza-inferior': 'üîµ',
                    'fuerza-superior': 'üü£'
                };

                const exercises = block.exercises.map((ex, exIndex) => `
                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-name">
                                ${ex.isPrincipal ? '‚≠ê ' : ''}${ex.name}
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="editExercise(${blockIndex}, ${exIndex})" style="padding: 4px 8px;">‚úèÔ∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteExercise(${blockIndex}, ${exIndex})" style="padding: 4px 8px;">üóëÔ∏è</button>
                        </div>
                        <div class="exercise-inputs">
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Series</label>
                                <input type="number" class="exercise-input" value="${ex.series || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'series', this.value)" min="1" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Reps</label>
                                <input type="text" class="exercise-input" value="${ex.reps || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'reps', this.value)" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">Peso (kg)</label>
                                <input type="number" class="exercise-input" value="${ex.weight || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'weight', this.value)" step="0.5" />
                            </div>
                            <div class="exercise-input-group">
                                <label class="exercise-input-label">RPE (1-10)</label>
                                <input type="number" class="exercise-input" value="${ex.rpe || ''}" 
                                       onchange="updateExercise(${blockIndex}, ${exIndex}, 'rpe', this.value)" min="1" max="10" step="0.5" />
                            </div>
                        </div>
                        ${ex.isPrincipal ? `
                            <div style="margin-top: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--primary-blue);">
                                    <input type="checkbox" ${ex.isPR ? 'checked' : ''} 
                                           onchange="updateExercise(${blockIndex}, ${exIndex}, 'isPR', this.checked)" />
                                    üèÜ R√©cord Personal
                                </label>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                return `
                    <div class="block block-type-${block.type}">
                        <div class="block-header">
                            <div class="block-title">
                                <div class="block-icon">${iconMap[block.type] || 'üìã'}</div>
                                ${block.name}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="currentBlockForExercise = ${blockIndex}; editingExercise = null; document.querySelector('#modal-addExercise .modal-title').textContent = '‚ûï Nuevo Ejercicio'; openModal('addExercise')">
                                    ‚ûï Ejercicio
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="editBlock(${blockIndex})">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteBlock(${blockIndex})">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        ${exercises}
                    </div>
                `;
            }).join('');
        }

        // BLOCKS
        function addBlock(e) {
            e.preventDefault();
            
            if (!currentDay) {
                alert('Primero seleccion√° un d√≠a de entrenamiento');
                return;
            }

            const block = {
                name: document.getElementById('blockName').value,
                type: document.getElementById('blockType').value,
                exercises: []
            };

            if (!currentDay.blocks) {
                currentDay.blocks = [];
            }

            currentDay.blocks.push(block);
            
            // Update day in student
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = currentDay;
            }

            // Update student in array
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }

            saveToSheets();
            loadTrainingDay();
            closeModal('addBlock');
            e.target.reset();
        }

        function deleteBlock(blockIndex) {
            if (!confirm('¬øEliminar este bloque y todos sus ejercicios?')) return;

            currentDay.blocks.splice(blockIndex, 1);
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = currentDay;
            }

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }

            saveToSheets();
            loadTrainingDay();
        }

        // EXERCISES
       function addExercise(e) {
    e.preventDefault();
    
    if (currentBlockForExercise === null) {
        alert('Error: no hay bloque seleccionado');
        return;
    }

    const exercise = {
        name: document.getElementById('exerciseName').value,
        series: parseInt(document.getElementById('exerciseSeries').value),
        reps: document.getElementById('exerciseReps').value,
        isPrincipal: document.getElementById('exerciseIsPrincipal').checked,
        weight: null,
        rpe: null,
        isPR: false
    };

    // ‚≠ê Si estamos editando, actualizar ejercicio existente
    if (editingExercise !== null) {
        currentDay.blocks[editingExercise.blockIndex].exercises[editingExercise.exIndex] = exercise;
        editingExercise = null;
        
        // Restaurar t√≠tulo del modal
        document.querySelector('#modal-addExercise .modal-title').textContent = '‚ûï Nuevo Ejercicio';
    } else {
        // Si es nuevo, agregarlo
        // Add to exercise database
        if (!exerciseDatabase.includes(exercise.name)) {
            exerciseDatabase.push(exercise.name);
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
        }

        currentDay.blocks[currentBlockForExercise].exercises.push(exercise);
    }
    
    const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
    if (dayIndex !== -1) {
        currentStudent.trainingDays[dayIndex] = currentDay;
    }

    const studentIndex = students.findIndex(s => s.id === currentStudent.id);
    if (studentIndex !== -1) {
        students[studentIndex] = currentStudent;
    }

    saveToSheets();
    loadTrainingDay();
    closeModal('addExercise');
    e.target.reset();
    currentBlockForExercise = null;
}

        function updateExercise(blockIndex, exIndex, field, value) {
            if (field === 'isPR') {
                currentDay.blocks[blockIndex].exercises[exIndex][field] = value;
            } else {
                const numValue = parseFloat(value);
                currentDay.blocks[blockIndex].exercises[exIndex][field] = isNaN(numValue) ? value : numValue;
            }

            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = currentDay;
            }

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
        }

        function deleteExercise(blockIndex, exIndex) {
            if (!confirm('¬øEliminar este ejercicio?')) return;

            currentDay.blocks[blockIndex].exercises.splice(exIndex, 1);
            
            const dayIndex = currentStudent.trainingDays.findIndex(d => d.id === currentDay.id);
            if (dayIndex !== -1) {
                currentStudent.trainingDays[dayIndex] = currentDay;
            }

            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }

            saveToSheets();
            loadTrainingDay();
        }

        function updateExercisesList() {
            const datalist = document.getElementById('exercisesList');
            datalist.innerHTML = exerciseDatabase.map(ex => `<option value="${ex}">`).join('');
        }

        // SAVE SESSION
        function updateStudentMetrics(s) {
    if (!s || !s.sessions) return;
    
    if (!s.totalXP) s.totalXP = 0;
    if (!s.level) s.level = 1;
    if (!s.badges) s.badges = [];
    if (!s.goals) s.goals = [];
    
    // CALCULAR XP
    s.totalXP = s.sessions.reduce(function(sum, sess) {
        return sum + Math.floor((sess.volume || 0) / 100);
    }, 0);
    s.level = Math.min(Math.floor(s.totalXP / 100), 100);
    
    checkBadges(s);
    if (s.goals) updateGoals(s);
    // üî• NUEVO: Actualizar el estudiante en el array
    const studentIndex = students.findIndex(st => st.id === s.id);
    if (studentIndex !== -1) {
        students[studentIndex] = s;
    }
    
    console.log('üìä M√©tricas actualizadas para', s.name, '- XP:', s.totalXP, 'Nivel:', s.level, 'Badges:', s.badges.length);
}


function checkBadges(s) {
    if (!s.badges) s.badges = [];
    var vol = s.sessions.reduce(function(sum, sess) { return sum + (sess.volume || 0); }, 0);
    var prs = s.sessions.reduce(function(sum, sess) { return sum + (sess.prs || 0); }, 0);
    var str = calculateStreak(s.sessions || []);
    
    if (str >= 7 && s.badges.indexOf('streak_7') === -1) s.badges.push('streak_7');
    if (vol >= 100000 && s.badges.indexOf('vol_100k') === -1) s.badges.push('vol_100k');
    if (prs >= 10 && s.badges.indexOf('pr_10') === -1) s.badges.push('pr_10');
    if (s.level >= 10 && s.badges.indexOf('lvl_10') === -1) s.badges.push('lvl_10');
    if (s.level >= 50 && s.badges.indexOf('lvl_50') === -1) s.badges.push('lvl_50');
    if (s.level >= 100 && s.badges.indexOf('lvl_100') === -1) s.badges.push('lvl_100');
}

function updateGoals(s) {
    if (!s.goals) s.goals = [];
    const now = new Date();
    
    s.goals.forEach(function(g) {
        if (g.status === 'completed' || g.status === 'failed') return;
        if (now > new Date(g.deadline)) { g.status = 'failed'; return; }
        
        let curr = 0;
        
        if (g.type === 'volume') {
            const ms = new Date(now.getFullYear(), now.getMonth(), 1);
            curr = Math.floor(s.sessions.filter(function(sess) {
                return new Date(sess.date) >= ms;
            }).reduce(function(sum, sess) { return sum + (sess.volume || 0); }, 0) / 1000);
            
        } else if (g.type === 'strength') {
            s.sessions.forEach(function(sess) {
                if (sess.blocks) sess.blocks.forEach(function(b) {
                    if (b.exercises) b.exercises.forEach(function(e) {
                        if (e.name === g.exerciseName && e.weight > curr) curr = e.weight;
                    });
                });
            });
            
        } else if (g.type === 'attendance') {
            const ms = new Date(now.getFullYear(), now.getMonth(), 1);
            curr = s.sessions.filter(function(sess) { return new Date(sess.date) >= ms; }).length;
            
        } else if (g.type === 'prs') {
            const start = new Date(g.startDate || g.deadline);
            curr = s.sessions.filter(function(sess) { return new Date(sess.date) >= start; })
                .reduce(function(sum, sess) { return sum + (sess.prs || 0); }, 0);
        }
        
        g.currentValue = curr;
        g.progress = Math.min((curr / g.targetValue) * 100, 100);
        
        if (g.progress >= 100 && g.status !== 'completed') {
            g.status = 'completed';
            setTimeout(function() {
                alert('üèÜ ¬°OBJETIVO CUMPLIDO!\n\n' + s.name + ' complet√≥:\n' + g.description + '\n\nüéÅ Recompensa: ' + (g.reward || 'Sin recompensa') + '\n\nüí° RECORDATORIO: Entreg√° la recompensa al alumno');
            }, 1500);
        } else if (g.progress >= 75 && !g.alert75) {
            g.alert75 = true;
            setTimeout(function() { alert('üéâ ' + s.name + ' al 75%: ' + g.description); }, 500);
        } else if (g.progress >= 50 && !g.alert50) {
            g.alert50 = true;
        }
    });
}
        function saveGoal() {
    if (!currentStudent) return;
    if (!currentStudent.goals) currentStudent.goals = [];
    
    const active = currentStudent.goals.filter(function(g) { return g.status === 'in_progress'; });
    if (active.length >= 5) { alert('‚ö†Ô∏è M√°ximo 5 objetivos activos'); return; }
    
    const type = document.getElementById('goalType').value;
    const desc = document.getElementById('goalDesc').value;
    const target = parseFloat(document.getElementById('goalTarget').value);
    const deadline = document.getElementById('goalDeadline').value;
    const reward = document.getElementById('goalReward').value;
    
    if (!desc || !target || !deadline) {
        alert('‚ö†Ô∏è Complet√° descripci√≥n, valor objetivo y fecha l√≠mite');
        return;
    }
    
    const g = {
        id: Date.now(),
        type: type,
        description: desc,
        targetValue: target,
        currentValue: 0,
        deadline: deadline,
        startDate: new Date().toISOString(),
        reward: reward,
        status: 'in_progress',
        progress: 0,
        unit: type === 'volume' ? 'ton' : type === 'strength' ? 'kg' : type === 'attendance' ? 'clases' : 'PRs',
        alert50: false,
        alert75: false
    };
    
    if (type === 'strength') {
        g.exerciseName = document.getElementById('goalExercise').value;
        if (!g.exerciseName) { alert('‚ö†Ô∏è Especific√° el ejercicio'); return; }
    }
    
    currentStudent.goals.push(g);
    updateGoals(currentStudent);
    
    const studentIndex = students.findIndex(function(s) { return s.id === currentStudent.id; });
    if (studentIndex !== -1) students[studentIndex] = currentStudent;
    
    saveToSheets();
    closeModal('newGoal');
    renderDashboard();
    alert('‚úÖ Objetivo creado!');
}

function deleteGoal(goalId) {
    if (!confirm('¬øEliminar objetivo?')) return;
    currentStudent.goals = currentStudent.goals.filter(function(g) { return g.id !== goalId; });
    
    const studentIndex = students.findIndex(function(s) { return s.id === currentStudent.id; });
    if (studentIndex !== -1) students[studentIndex] = currentStudent;
    
    saveToSheets();
    renderDashboard();
}
       async function saveSession() {
            if (!currentStudent || !currentDay) {
                alert('Seleccion√° un atleta y un d√≠a de entrenamiento');
                return;
            }

            const date = document.getElementById('sessionDate').value;
            const bodyWeight = parseFloat(document.getElementById('bodyWeight').value);
            
            if (!date) {
                alert('Por favor ingres√° la fecha de la sesi√≥n');
                return;
            }

            let totalVolume = 0;
            let totalRPE = 0;
            let rpeCount = 0;
            let prsCount = 0;

            const sessionBlocks = JSON.parse(JSON.stringify(currentDay.blocks));
            
            sessionBlocks.forEach(block => {
                block.exercises.forEach(ex => {
                    if (ex.weight && ex.series && ex.reps) {
                        const reps = parseFloat(ex.reps) || 0;
                        totalVolume += ex.weight * ex.series * reps;
                    }
                    if (ex.rpe) {
                        totalRPE += parseFloat(ex.rpe);
                        rpeCount++;
                    }
                    if (ex.isPR) {
                        prsCount++;
                    }
                });
            });

            const avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : 0;

            const session = {
                date: date,
                dayId: currentDay.id,
                dayName: currentDay.name,
                bodyWeight: bodyWeight,
                blocks: sessionBlocks,
                volume: Math.round(totalVolume),
                avgRPE: parseFloat(avgRPE),
                prs: prsCount,
                timestamp: new Date().toISOString()
            };

            if (!currentStudent.sessions) {
                currentStudent.sessions = [];
            }
            currentStudent.sessions.push(session);
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
           // Actualizar m√©tricas de gamificaci√≥n
            updateStudentMetrics(currentStudent);
            
            // üî• CR√çTICO: Guardar en Sheets DESPU√âS de actualizar m√©tricas
            await saveToSheets();
            
            alert(`‚úÖ Sesi√≥n de "${currentDay.name}" guardada!\n\nüìä Volumen: ${session.volume}kg\n‚≠ê RPE: ${avgRPE}\nüèÜ PRs: ${prsCount}`);
            
            // Clear PRs
            currentDay.blocks.forEach(block => {
                block.exercises.forEach(ex => ex.isPR = false);
            });
            loadTrainingDay();
            
            renderStudents();
        }

        // IMPORT/EXPORT
        let importedCompleteData = [];

        function handleCompleteImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCompleteData(text);
            };
            reader.readAsText(file);
        }


        // FUNCI√ìN PARA PARSEAR CSV CORRECTAMENTE (maneja comillas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCompleteData(text) {
            importedCompleteData = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            const startIndex = lines[0].toLowerCase().includes('alumno') ? 1 : 0;
            
            const studentsMap = {};
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = parseCSVLine(line);
                
                if (parts.length >= 12) {
                    const studentName = parts[0];
                    const age = parseInt(parts[1]) || 25;
                    const weight = parseFloat(parts[2]) || 70;
                    const goal = parts[3];
                    const monthlyClasses = parseInt(parts[4]) || 12;
                    const dayName = parts[5];
                    const blockName = parts[6];
                    const blockType = parts[7];
                    const exerciseName = parts[8];
                    const series = parseInt(parts[9]) || 3;
                    const reps = parts[10];
                    const isPrincipal = parts[11].toUpperCase() === 'SI';
                    
                    if (!studentsMap[studentName]) {
                        studentsMap[studentName] = {
                            name: studentName,
                            age: age,
                            weight: weight,
                            goal: goal,
                            monthlyClasses: monthlyClasses,
                            days: {}
                        };
                    }
                    
                    const student = studentsMap[studentName];
                    
                    if (!student.days[dayName]) {
                        student.days[dayName] = {
                            name: dayName,
                            blocks: {}
                        };
                    }
                    
                    const day = student.days[dayName];
                    
                    if (!day.blocks[blockName]) {
                        day.blocks[blockName] = {
                            name: blockName,
                            type: blockType,
                            exercises: []
                        };
                    }
                    
                    day.blocks[blockName].exercises.push({
                        name: exerciseName,
                        series: series,
                        reps: reps,
                        isPrincipal: isPrincipal,
                        weight: null,
                        rpe: null,
                        isPR: false
                    });
                }
            }
            
            importedCompleteData = Object.values(studentsMap).map(student => ({
                ...student,
                trainingDays: Object.values(student.days).map((day, idx) => ({
                    id: Date.now() + idx,
                    name: day.name,
                    blocks: Object.values(day.blocks)
                })),
                days: undefined
            }));
            
            if (importedCompleteData.length > 0) {
                showCompleteImportPreview();
                document.getElementById('btnImportComplete').disabled = false;
            } else {
                alert('‚ùå No se pudieron leer datos. Verific√° el formato.');
            }
        }

        function showCompleteImportPreview() {
            document.getElementById('completeImportPreview').style.display = 'block';
            
            let totalStudents = importedCompleteData.length;
            let totalDays = 0;
            let totalBlocks = 0;
            let totalExercises = 0;
            
            importedCompleteData.forEach(student => {
                totalDays += student.trainingDays.length;
                student.trainingDays.forEach(day => {
                    totalBlocks += day.blocks.length;
                    day.blocks.forEach(block => {
                        totalExercises += block.exercises.length;
                    });
                });
            });
            
            document.getElementById('completeImportCount').textContent = 
                `${totalStudents} alumno${totalStudents > 1 ? 's' : ''}, ${totalDays} d√≠as, ${totalBlocks} bloques, ${totalExercises} ejercicios`;
            
            const container = document.getElementById('completeImportPreviewBody');
            let html = '';
            
            importedCompleteData.forEach(student => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                        <h4 style="font-family: 'Inter'; font-size: 16px; margin-bottom: 8px;">${student.name}</h4>
                        <p style="font-size: 12px; color: var(--text-gray); margin-bottom: 12px;">
                            ${student.age} a√±os ¬∑ ${student.weight}kg ¬∑ ${student.monthlyClasses} clases/mes<br>
                            üéØ ${student.goal}
                        </p>
                        <div style="font-size: 12px;">
                            <strong>${student.trainingDays.length} d√≠a${student.trainingDays.length > 1 ? 's' : ''}:</strong>
                            ${student.trainingDays.map(d => `
                                <div style="margin-top: 8px; padding: 8px; background: var(--bg-gray); border-radius: 4px;">
                                    <strong>${d.name}</strong> - ${d.blocks.length} bloque${d.blocks.length > 1 ? 's' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function processCompleteImport() {
            if (importedCompleteData.length === 0) {
                alert('No hay datos para importar');
                return;
            }
            
            let imported = 0;
            importedCompleteData.forEach(data => {
                const student = {
                    id: Date.now() + imported,
                    name: data.name,
                    age: data.age,
                    weight: data.weight,
                    goal: data.goal,
                    monthlyClasses: data.monthlyClasses,
                    trainingDays: data.trainingDays,
                    sessions: [],
                    attendance: {},
                    createdAt: new Date().toISOString(),
                    totalXP: 0,
                    level: 1,
                    badges: [],
                    goals: []
                };
                
                student.trainingDays.forEach(day => {
                    day.blocks.forEach(block => {
                        block.exercises.forEach(ex => {
                            if (!exerciseDatabase.includes(ex.name)) {
                                exerciseDatabase.push(ex.name);
                            }
                        });
                    });
                });
                
                students.push(student);
                imported++;
            });
            
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            
            saveToSheets();
            renderStudents();
            closeModal('importComplete');
            
            importedCompleteData = [];
            document.getElementById('importCompleteFile').value = '';
            document.getElementById('completeImportPreview').style.display = 'none';
            document.getElementById('btnImportComplete').disabled = true;
            
            alert(`‚úÖ ${imported} alumno${imported > 1 ? 's' : ''} con sus planes importados!`);
        }

        // Import Plan (for current student)
        let importedPlanData = [];

        function handlePlanImport(event) {
            if (!currentStudent) {
                alert('Primero seleccion√° un atleta');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parsePlanData(text);
            };
            reader.readAsText(file);
        }

        function parsePlanData(text) {
            importedPlanData = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            const startIndex = lines[0].toLowerCase().includes('dia') ? 1 : 0;
            
            const daysMap = {};
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = parseCSVLine(line);
                
                if (parts.length >= 7) {
                    const dayName = parts[0];
                    const blockName = parts[1];
                    const blockType = parts[2];
                    const exerciseName = parts[3];
                    const series = parseInt(parts[4]) || 3;
                    const reps = parts[5];
                    const isPrincipal = parts[6].toUpperCase() === 'SI';
                    
                    if (!daysMap[dayName]) {
                        daysMap[dayName] = {
                            name: dayName,
                            blocks: {}
                        };
                    }
                    
                    const day = daysMap[dayName];
                    
                    if (!day.blocks[blockName]) {
                        day.blocks[blockName] = {
                            name: blockName,
                            type: blockType,
                            exercises: []
                        };
                    }
                    
                    day.blocks[blockName].exercises.push({
                        name: exerciseName,
                        series: series,
                        reps: reps,
                        isPrincipal: isPrincipal,
                        weight: null,
                        rpe: null,
                        isPR: false
                    });
                }
            }
            
            importedPlanData = Object.values(daysMap).map((day, idx) => ({
                id: Date.now() + idx,
                name: day.name,
                blocks: Object.values(day.blocks)
            }));
            
            if (importedPlanData.length > 0) {
                showPlanImportPreview();
                document.getElementById('btnImportPlan').disabled = false;
            } else {
                alert('‚ùå No se pudieron leer datos. Verific√° el formato.');
            }
        }

        function showPlanImportPreview() {
            document.getElementById('planImportPreview').style.display = 'block';
            
            let totalBlocks = 0;
            let totalExercises = 0;
            
            importedPlanData.forEach(day => {
                totalBlocks += day.blocks.length;
                day.blocks.forEach(block => {
                    totalExercises += block.exercises.length;
                });
            });
            
            document.getElementById('planImportCount').textContent = 
                `${importedPlanData.length} d√≠a${importedPlanData.length > 1 ? 's' : ''}, ${totalBlocks} bloques, ${totalExercises} ejercicios`;
            
            const container = document.getElementById('planImportPreviewBody');
            let html = '';
            
            importedPlanData.forEach(day => {
                html += `
                    <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-gray); border-radius: 8px;">
                        <h4 style="font-family: 'Inter'; font-size: 14px; margin-bottom: 8px;">${day.name}</h4>
                        <div style="font-size: 12px;">
                            ${day.blocks.map(b => `
                                <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>${b.name}</strong> - ${b.exercises.length} ejercicio${b.exercises.length > 1 ? 's' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function processPlanImport() {
            if (!currentStudent) {
                alert('No hay alumno seleccionado');
                return;
            }
            
            if (importedPlanData.length === 0) {
                alert('No hay datos para importar');
                return;
            }
            
            const confirmMsg = currentStudent.trainingDays && currentStudent.trainingDays.length > 0 
                ? '¬øAgregar estos d√≠as al plan actual?' 
                : '¬øImportar estos d√≠as?';
            
            if (!confirm(confirmMsg)) return;
            
            if (!currentStudent.trainingDays) {
                currentStudent.trainingDays = [];
            }

            importedPlanData.forEach(day => {
                currentStudent.trainingDays.push(day);
                
                day.blocks.forEach(block => {
                    block.exercises.forEach(ex => {
                        if (!exerciseDatabase.includes(ex.name)) {
                            exerciseDatabase.push(ex.name);
                        }
                    });
                });
            });
            
            const studentIndex = students.findIndex(s => s.id === currentStudent.id);
            if (studentIndex !== -1) {
                students[studentIndex] = currentStudent;
            }
            
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            
            saveToSheets();
            renderTrainingDays();
            closeModal('importPlan');
            
            importedPlanData = [];
            document.getElementById('importPlanFile').value = '';
            document.getElementById('planImportPreview').style.display = 'none';
            document.getElementById('btnImportPlan').disabled = true;
            
            alert(`‚úÖ ${currentStudent.trainingDays.length} d√≠a${currentStudent.trainingDays.length > 1 ? 's' : ''} importado${currentStudent.trainingDays.length > 1 ? 's' : ''}!`);
        }

        // Export
        function exportAllDays() {
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) {
                alert('No hay d√≠as para exportar');
                return;
            }

            let csvContent = "Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal\n";
            
            currentStudent.trainingDays.forEach(day => {
                day.blocks.forEach(block => {
                    block.exercises.forEach(ex => {
                        const row = [
                            day.name,
                            block.name,
                            block.type,
                            ex.name,
                            ex.series || '',
                            ex.reps || '',
                            ex.isPrincipal ? 'SI' : 'NO'
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `plan_${currentStudent.name.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // FUNCIONES AUXILIARES PARA M√âTRICAS
        function calculateStreak(sessions) {
            if (!sessions || sessions.length === 0) return 0;
            
            const sortedSessions = sessions.slice().sort(function(a, b) { 
                return new Date(b.date) - new Date(a.date); 
            });
            let streak = 0;
            let lastDate = new Date();
            
            for (let i = 0; i < sortedSessions.length; i++) {
                const sessionDate = new Date(sortedSessions[i].date);
                const diffDays = Math.floor((lastDate - sessionDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 3) {
                    streak++;
                    lastDate = sessionDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function getMostTrainedDay(dayStats) {
            if (!dayStats || Object.keys(dayStats).length === 0) return '-';
            
            let maxDay = '';
            let maxCount = 0;
            
            for (let day in dayStats) {
                if (dayStats[day] > maxCount) {
                    maxCount = dayStats[day];
                    maxDay = day;
                }
            }
            
            return maxDay || '-';
        }

        function generateWeeklySummary(sessions, student) {
            if (!sessions || sessions.length === 0) {
                return '<p style="opacity: 0.8;">No hay sesiones registradas para generar insights.</p>';
            }

            const today = new Date();
            const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            const weekSessions = sessions.filter(function(s) { 
                return new Date(s.date) >= weekAgo; 
            });

            if (weekSessions.length === 0) {
                return '<p style="opacity: 0.8;">No hay sesiones en los √∫ltimos 7 d√≠as.</p>';
            }

            const weekVolume = weekSessions.reduce(function(sum, s) { 
                return sum + (s.volume || 0); 
            }, 0);
            const weekPRs = weekSessions.reduce(function(sum, s) { 
                return sum + (s.prs || 0); 
            }, 0);
            const avgRPE = weekSessions.length > 0 ? 
                (weekSessions.reduce(function(sum, s) { 
                    return sum + (s.avgRPE || 0); 
                }, 0) / weekSessions.length).toFixed(1) : 0;

            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            const prevWeekSessions = sessions.filter(function(s) {
                const d = new Date(s.date);
                return d >= twoWeeksAgo && d < weekAgo;
            });
            const prevWeekVolume = prevWeekSessions.reduce(function(sum, s) { 
                return sum + (s.volume || 0); 
            }, 0);

            let summary = '<div style="line-height: 2;">';
            
            // Frecuencia
            summary += '<div>‚úì <strong>' + weekSessions.length + ' sesiones</strong> completadas esta semana';
            if (weekSessions.length >= 3) {
                summary += ' - <strong style="color: #10B981;">Excelente consistencia</strong>, manten√© este ritmo</div>';
            } else if (weekSessions.length === 2) {
                summary += ' - Buen trabajo, intent√° agregar una sesi√≥n m√°s</div>';
            } else {
                summary += ' - Intent√° entrenar m√°s seguido</div>';
            }

            // Volumen
            if (prevWeekVolume > 0) {
                const volumeChange = ((weekVolume - prevWeekVolume) / prevWeekVolume * 100).toFixed(0);
                if (weekVolume > prevWeekVolume) {
                    summary += '<div>üìà <strong>+' + volumeChange + '%</strong> de volumen vs semana anterior (' + (weekVolume/1000).toFixed(1) + ' ton)</div>';
                } else if (weekVolume < prevWeekVolume) {
                    summary += '<div>üìâ <strong>' + volumeChange + '%</strong> de volumen - consider√° m√°s recuperaci√≥n</div>';
                }
            } else {
                summary += '<div>üì¶ <strong>' + (weekVolume/1000).toFixed(1) + ' toneladas</strong> movidas esta semana</div>';
            }

            // Records
            if (weekPRs > 0) {
                summary += '<div>üèÜ <strong>' + weekPRs + ' nuevo' + (weekPRs > 1 ? 's' : '') + ' r√©cord' + (weekPRs > 1 ? 's' : '') + '</strong> - ¬°Excelente progreso!</div>';
            }

            // PRs destacados
            const exercisesWithPRs = [];
            weekSessions.forEach(function(session) {
                if (session.blocks) {
                    session.blocks.forEach(function(block) {
                        if (block.exercises) {
                            block.exercises.forEach(function(ex) {
                                if (ex.isPR && ex.weight) {
                                    exercisesWithPRs.push({
                                        name: ex.name,
                                        weight: ex.weight
                                    });
                                }
                            });
                        }
                    });
                }
            });

            if (exercisesWithPRs.length > 0) {
                const top2 = exercisesWithPRs.slice(0, 2);
                top2.forEach(function(ex) {
                    summary += '<div>üí™ <strong>' + ex.name + '</strong>: nuevo PR con ' + ex.weight + 'kg</div>';
                });
            }

            // Intensidad
            if (avgRPE >= 8.5) {
                summary += '<div>üî• Intensidad alta (RPE ' + avgRPE + ') - consider√° descanso activo</div>';
            } else if (avgRPE >= 7 && avgRPE < 8.5) {
                summary += '<div>‚úì Intensidad √≥ptima (RPE ' + avgRPE + ') - segu√≠ as√≠</div>';
            } else if (avgRPE < 7 && avgRPE > 0) {
                summary += '<div>üí° Intensidad moderada (RPE ' + avgRPE + ') - pod√©s aumentar gradualmente</div>';
            }

            // D√≠as entrenados
            const daysCount = {};
            weekSessions.forEach(function(s) {
                if (s.dayName) {
                    daysCount[s.dayName] = (daysCount[s.dayName] || 0) + 1;
                }
            });
            if (Object.keys(daysCount).length > 0) {
                const daysList = Object.keys(daysCount).map(function(day) {
                    return day + ' (' + daysCount[day] + 'x)';
                }).join(', ');
                summary += '<div>üìã D√≠as entrenados: <strong>' + daysList + '</strong></div>';
            }

            summary += '</div>';
            return summary;
        }


        // ================================================
        // AUTO-SYNC: Sincronizaci√≥n autom√°tica
        // ================================================
        async function loadFromSheetsAuto() {
            if (!sheetsUrl) {
                loadFromLocalStorageFallback();
                return;
            }
            
            try {
                const response = await fetch(sheetsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'loadStudents' })
                });
                
                const data = await response.json();
                
                if (data.students && data.students.length > 0) {
                    students = data.students;
                    localStorage.setItem('gymTracker_students', JSON.stringify(students));
                    renderStudents();
                    lastSyncTimestamp = Date.now();
                    localStorage.setItem('lastSync', lastSyncTimestamp);
                    console.log('‚úÖ Auto-sync: Datos cargados');
                } else {
                    loadFromLocalStorageFallback();
                }
            } catch (error) {
                console.warn('Auto-sync: Error, usando localStorage');
                loadFromLocalStorageFallback();
            }
        }
        
        function loadFromLocalStorageFallback() {
            const localData = localStorage.getItem('gymTracker_students');
            if (localData) {
                students = JSON.parse(localData);
                students = students.map(function(s) {
                    if (!s.trainingDays && s.blocks) {
                        return Object.assign({}, s, {
                            trainingDays: [{
                                id: Date.now(),
                                name: "Plan Principal",
                                blocks: s.blocks
                            }],
                            blocks: undefined
                        });
                    }
                    return s;
                });
                renderStudents();
            }
        }
        
        // FUNCIONES AUXILIARES PARA M√âTRICAS
        function calcMetrics(student) {
            if (!student || !student.sessions || student.sessions.length === 0) {
                return {
                    totalSets: 0, effectiveSets: 0, effectivePercent: 0,
                    monthlyTonnage: '0.0', daysSincePR: -1, prFrequency: '0.0',
                    totalVolume: 0, totalPRs: 0, streak: 0
                };
            }
            
            var totalSets = 0, effectiveSets = 0;
            student.sessions.forEach(function(sess) {
                if (sess.blocks) {
                    sess.blocks.forEach(function(b) {
                        if (b.exercises) {
                            b.exercises.forEach(function(e) {
                                totalSets += (e.series || 0);
                                if ((e.rpe || 0) >= 7) effectiveSets += (e.series || 0);
                            });
                        }
                    });
                }
            });
            
            var now = new Date();
            var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            var monthVol = student.sessions.filter(function(sess) {
                return new Date(sess.date) >= monthStart;
            }).reduce(function(sum, sess) {
                return sum + (sess.volume || 0);
            }, 0);
            
            var lastPR = null;
            student.sessions.forEach(function(sess) {
                if ((sess.prs || 0) > 0) {
                    if (!lastPR || new Date(sess.date) > new Date(lastPR)) {
                        lastPR = sess.date;
                    }
                }
            });
            var daysSincePR = lastPR ? Math.floor((now - new Date(lastPR)) / 86400000) : -1;
            
            var totalPRs = student.sessions.reduce(function(sum, sess) {
                return sum + (sess.prs || 0);
            }, 0);
            var firstDate = student.sessions.length > 0 ? new Date(student.sessions[0].date) : now;
            var months = Math.max(0.5, (now - firstDate) / 2592000000);
            var totalVol = student.sessions.reduce(function(sum, sess) {
                return sum + (sess.volume || 0);
            }, 0);
            
            return {
                totalSets: totalSets,
                effectiveSets: effectiveSets,
                effectivePercent: totalSets > 0 ? Math.round((effectiveSets / totalSets) * 100) : 0,
                monthlyTonnage: (monthVol / 1000).toFixed(1),
                daysSincePR: daysSincePR,
                prFrequency: (totalPRs / months).toFixed(1),
                totalVolume: totalVol,
                totalPRs: totalPRs,
                streak: calculateStreak(student.sessions || [])
            };
        }
        
        function getBadgeInfo(id) {
            var badges = {
                'streak_7': { name: '7 d√≠as', icon: 'üî•' },
                'vol_100k': { name: '100 ton', icon: 'üí™' },
                'pr_10': { name: '10 PRs', icon: 'üèÜ' },
                'lvl_10': { name: 'Nivel 10', icon: '‚≠ê' },
                'lvl_50': { name: 'Nivel 50', icon: '‚≠ê‚≠ê‚≠ê' },
                'lvl_100': { name: 'MAX', icon: 'üëë' }
            };
            return badges[id] || { name: id, icon: 'üéñÔ∏è' };
        }

        // DASHBOARD
        function renderDashboard() {
            if (!currentStudent) {
                document.getElementById('dashboardContent').innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">Seleccion√° un atleta para ver sus m√©tricas</p>';
                return;
            }

            document.getElementById('dashboardStudentName').textContent = currentStudent.name;

            const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            const monthSessions = currentStudent.sessions ? currentStudent.sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= monthStart && sessionDate <= monthEnd;
            }) : [];

            const attendedClasses = monthSessions.length;
            const attendancePercentage = currentStudent.monthlyClasses > 0 ? 
                Math.round((attendedClasses / currentStudent.monthlyClasses) * 100) : 0;

            if (monthSessions.length === 0) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="attendance-section">
                        <div class="attendance-header">
                            <div class="attendance-title">üìÖ Progreso de Asistencia</div>
                            <div class="classes-info">${attendedClasses} / ${currentStudent.monthlyClasses} clases</div>
                        </div>
                        <div style="background: var(--bg-gray); border-radius: 12px; padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 13px; font-weight: 700; color: var(--text-gray); text-transform: uppercase;">Sesiones Completadas</span>
                                <span style="font-family: 'Inter'; font-size: 24px; color: var(--primary-blue);">${attendancePercentage}%</span>
                            </div>
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${Math.min(attendancePercentage, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 24px;">
                        <p style="text-align: center; color: var(--text-gray); padding: 40px;">No hay sesiones este mes</p>
                    </div>
                `;
                return;
            }

            // Calculate metrics
            const currentMonthVolume = monthSessions.reduce((sum, s) => sum + (s.volume || 0), 0);
            const totalPRs = monthSessions.reduce((sum, s) => sum + (s.prs || 0), 0);
            const avgRPE = monthSessions.length > 0 ? 
                (monthSessions.reduce((sum, s) => sum + (s.avgRPE || 0), 0) / monthSessions.length).toFixed(1) : 0;

            // Previous month
            const prevMonthDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            const prevMonthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0);
            const prevMonthSessions = currentStudent.sessions ? currentStudent.sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= prevMonthDate && sessionDate <= prevMonthEnd;
            }) : [];
            const prevMonthVolume = prevMonthSessions.reduce((sum, s) => sum + (s.volume || 0), 0);

            // Count sessions by day
            const dayStats = {};
            monthSessions.forEach(s => {
                if (s.dayName) {
                    dayStats[s.dayName] = (dayStats[s.dayName] || 0) + 1;
                }
            });

            // Calcular m√©tricas primero
            var metrics = calcMetrics(currentStudent);
            
            let html = `
                <!-- GAMIFICACI√ìN -->
                <div class="card" style="background:linear-gradient(135deg,#1e3a8a,#1e40af);color:white;padding:24px;margin-bottom:24px;">
                    <h3 style="color:white;margin-bottom:16px;">üéÆ Progreso del Atleta</h3>
                    <div style="display:flex;justify-content:space-between;margin-bottom:16px;">
                        <div><div style="font-size:14px;opacity:0.9;">Nivel</div><div style="font-size:48px;font-weight:bold;">${currentStudent.level || 1}</div></div>
                        <div style="text-align:right;"><div style="font-size:14px;opacity:0.9;">XP Total</div><div style="font-size:28px;font-weight:bold;">${(currentStudent.totalXP || 0).toLocaleString()}</div></div>
                    </div>
                    <div style="background:rgba(255,255,255,0.2);height:12px;border-radius:6px;overflow:hidden;margin-bottom:8px;">
                        <div style="background:#86efac;height:100%;width:${((currentStudent.totalXP || 0) % 100)}%;"></div>
                    </div>
                    <div style="font-size:14px;opacity:0.9;">${100 - ((currentStudent.totalXP || 0) % 100)} XP hasta nivel ${(currentStudent.level || 1) < 100 ? (currentStudent.level || 1) + 1 : 'MAX'}</div>
                </div>
                
                <!-- BADGES -->
                <div class="card" style="margin-bottom:24px;">
                    <h3>üèÜ Insignias (${(currentStudent.badges || []).length})</h3>
                    <div style="display:flex;flex-wrap:wrap;gap:16px;margin-top:16px;">
                        ${(currentStudent.badges || []).length > 0 ? (currentStudent.badges || []).map(function(b) {
                            var info = getBadgeInfo(b);
                            return '<div style="background:#f8f9fa;padding:16px;border-radius:12px;text-align:center;min-width:100px;border:2px solid #e0e0e0;"><div style="font-size:40px;margin-bottom:8px;">' + info.icon + '</div><div style="font-size:12px;font-weight:600;color:#1e3a8a;">' + info.name + '</div></div>';
                        }).join('') : '<p style="color:#999;padding:20px;text-align:center;">Sin insignias a√∫n</p>'}
                    </div>
                </div>
                
                <!-- INDICADORES -->
                <div class="card" style="margin-bottom:24px;">
                <!-- OBJETIVOS SMART -->
<div class="card" style="margin-bottom:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;">üéØ Objetivos SMART</h3>
        <button onclick="openModal('newGoal')" class="btn btn-primary btn-sm">‚ûï Nuevo Objetivo</button>
    </div>
    
    ${(() => {
        const active = (currentStudent.goals || []).filter(function(g) { return g.status === 'in_progress'; });
        if (active.length === 0) {
            return '<p style="color:#999;padding:20px;text-align:center;">No hay objetivos activos. ¬°Cre√° uno!</p>';
        }
        return active.map(function(g) {
            const days = Math.ceil((new Date(g.deadline) - new Date()) / 86400000);
            const progressColor = g.progress >= 75 ? '#22c55e' : g.progress >= 50 ? '#f59e0b' : '#3b82f6';
            return `
                <div style="border:2px solid #e0e0e0;padding:20px;border-radius:12px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                        <div style="flex:1;">
                            <div style="font-size:18px;font-weight:bold;color:#1e3a8a;">${g.description}</div>
                            <div style="font-size:13px;color:#666;">
                                ${g.type === 'volume' ? 'üìà Volumen' : g.type === 'strength' ? 'üí™ Fuerza (' + g.exerciseName + ')' : g.type === 'attendance' ? 'üìÖ Asistencia' : 'üèÜ PRs'}
                            </div>
                        </div>
                        <button onclick="deleteGoal(${g.id})" style="background:#ef4444;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">üóëÔ∏è</button>
                    </div>
                    <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                            <span style="font-size:28px;font-weight:bold;color:#1e3a8a;">${g.currentValue}</span>
                            <span style="font-size:16px;color:#666;">/ ${g.targetValue} ${g.unit}</span>
                        </div>
                        <div style="background:#e0e0e0;height:12px;border-radius:6px;overflow:hidden;">
                            <div style="background:${progressColor};height:100%;width:${g.progress}%;"></div>
                        </div>
                        <div style="font-size:13px;color:#666;margin-top:8px;text-align:right;">${Math.round(g.progress)}%</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;">
                        <div>üìÖ ${days > 0 ? days + ' d√≠as' : '‚ùå Venci√≥'}</div>
                        ${g.reward ? '<div style="color:#22c55e;font-weight:700;">üéÅ ' + g.reward + '</div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    })()}
</div>
                    <h3>üìä Indicadores Clave</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:16px;">
                        <div style="background:linear-gradient(135deg,#86efac,#22c55e);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Volumen Total</div>
                            <div style="font-size:28px;font-weight:bold;">${(metrics.totalVolume / 1000).toFixed(1)} ton</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#1e3a8a,#1e40af);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Series Efectivas</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.effectiveSets}/${metrics.totalSets}</div>
                            <div style="font-size:13px;margin-top:4px;">${metrics.effectivePercent}% RPE‚â•7</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#78716c,#57534e);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Tonelaje Mensual</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.monthlyTonnage} ton</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Records Totales</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.totalPRs} üèÜ</div>
                        </div>
                        <div style="background:linear-gradient(135deg,${metrics.daysSincePR < 0 ? '#999,#777' : metrics.daysSincePR < 30 ? '#22c55e,#16a34a' : '#f59e0b,#d97706'});padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">√öltimo PR</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.daysSincePR < 0 ? 'Sin PRs' : metrics.daysSincePR + ' d√≠as'}</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Frecuencia PRs</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.prFrequency}</div>
                            <div style="font-size:13px;margin-top:4px;">PRs/mes</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#ec4899,#db2777);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Racha</div>
                            <div style="font-size:28px;font-weight:bold;">${metrics.streak} üî•</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#06b6d4,#0891b2);padding:20px;border-radius:12px;color:white;">
                            <div style="font-size:12px;opacity:0.9;margin-bottom:8px;">Puntos XP</div>
                            <div style="font-size:28px;font-weight:bold;">${currentStudent.totalXP || 0}</div>
                        </div>
                    </div>
                </div>
                
                <div class="attendance-section">
                    <div class="attendance-header">
                        <div class="attendance-title">üìÖ Progreso de Asistencia</div>
                        <div class="classes-info">${attendedClasses} / ${currentStudent.monthlyClasses} clases</div>
                    </div>
                    <div style="background: var(--bg-gray); border-radius: 12px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 13px; font-weight: 700; color: var(--text-gray); text-transform: uppercase;">Sesiones Completadas</span>
                            <span style="font-family: 'Inter'; font-size: 24px; color: var(--primary-blue);">${attendancePercentage}%</span>
                        </div>
                        <div class="goal-progress-bar">
                            <div class="goal-progress-fill" style="width: ${Math.min(attendancePercentage, 100)}%"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-gray); margin-top: 12px;">
                            ${Object.entries(dayStats).map(([day, count]) => `${day}: ${count} sesi√≥n${count > 1 ? 'es' : ''}`).join(' ‚Ä¢ ')}
                        </div>
                    </div>
                </div>

                <!-- RESUMEN SEMANAL PARA EL PROFESOR -->
                <div class="card" style="background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%); color: white; margin-bottom: 24px;">
                    <h3 style="font-family: 'Inter'; font-size: 18px; margin-bottom: 20px; text-transform: uppercase;">
                        üí¨ Resumen Semanal - Para el Alumno
                    </h3>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; line-height: 1.8; font-size: 14px;">
                        ${generateWeeklySummary(monthSessions, currentStudent)}
                    </div>
                </div>

                <div class="month-comparison">
                    <div class="month-box">
                        <div class="month-label">Mes Anterior</div>
                        <div class="month-value">${(prevMonthVolume / 1000).toFixed(1)} ton</div>
                    </div>
                    <div class="month-box current">
                        <div class="month-label">Mes Actual</div>
                        <div class="month-value">${(currentMonthVolume / 1000).toFixed(1)} ton</div>
                    </div>
                    <div class="month-box">
                        <div class="month-label">Pr√≥ximo Mes</div>
                        <div class="month-value">Objetivo</div>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Volumen Total</div>
                        <div class="metric-value">${currentMonthVolume.toLocaleString()}</div>
                        <div class="metric-detail">kg este mes</div>
                        ${prevMonthVolume > 0 ? `
                            <div class="metric-change ${currentMonthVolume >= prevMonthVolume ? 'positive' : 'negative'}">
                                ${currentMonthVolume >= prevMonthVolume ? '+' : ''}${((currentMonthVolume - prevMonthVolume) / prevMonthVolume * 100).toFixed(1)}% vs mes anterior
                            </div>
                        ` : ''}
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Records Rotos</div>
                        <div class="metric-value">${totalPRs}</div>
                        <div class="metric-detail">PRs este mes</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">RPE Promedio</div>
                        <div class="metric-value">${avgRPE}</div>
                        <div class="metric-detail">${avgRPE < 7 ? 'Suave' : avgRPE < 8.5 ? '√ìptimo' : 'Intenso'}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Consistencia</div>
                        <div class="metric-value">${attendancePercentage}%</div>
                        <div class="metric-detail">${attendancePercentage >= 90 ? 'Excelente' : attendancePercentage >= 75 ? 'Bueno' : 'Mejorable'}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">üí™ Volumen/Sesi√≥n</div>
                        <div class="metric-value">${monthSessions.length > 0 ? Math.round(currentMonthVolume / monthSessions.length) : 0}</div>
                        <div class="metric-detail">kg promedio</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">üî• Racha</div>
                        <div class="metric-value">${calculateStreak(currentStudent.sessions)}</div>
                        <div class="metric-detail">d√≠as seguidos</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">üìä D√≠a Favorito</div>
                        <div class="metric-value">${getMostTrainedDay(dayStats)}</div>
                        <div class="metric-detail">m√°s entrenado</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">‚è±Ô∏è √öltima Sesi√≥n</div>
                        <div class="metric-value">${monthSessions.length > 0 ? new Date(monthSessions[monthSessions.length - 1].date).toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit'}) : '-'}</div>
                        <div class="metric-detail">${monthSessions.length > 0 ? monthSessions[monthSessions.length - 1].dayName : 'Sin datos'}</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-family: 'Inter'; font-size: 18px; margin-bottom: 20px; text-transform: uppercase;">üìã Historial de Sesiones</h3>
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>D√≠a</th>
                                <th>Volumen</th>
                                <th>RPE</th>
                                <th>PRs</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthSessions.reverse().map((s, idx) => {
                                const dateObj = new Date(s.date + 'T12:00:00');
                                const formattedDate = dateObj.toLocaleDateString('es-AR', { 
                                    day: '2-digit', 
                                    month: '2-digit'
                                });
                                
                                return `
                                    <tr>
                                        <td>${formattedDate}</td>
                                        <td><strong>${s.dayName || 'Plan'}</strong></td>
                                        <td>${s.volume.toLocaleString()} kg</td>
                                        <td>${s.avgRPE}</td>
                                        <td>${s.prs > 0 ? 'üèÜ ' + s.prs : '-'}</td>
                                        <td>
    <button class="btn btn-secondary btn-sm" onclick="editSession(${idx})" style="padding: 4px 8px;">‚úèÔ∏è Editar</button>
</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('dashboardContent').innerHTML = html;
        }
// ============================================
// EDITAR SESIONES GUARDADAS
// ============================================

let currentEditingSessionIndex = null;

function editSession(sessionIndex) {
    if (!currentStudent || !currentStudent.sessions) return;
    
    // Las sesiones est√°n reverse() en el dashboard, as√≠ que necesitamos el √≠ndice correcto
    const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
    
    const monthSessions = currentStudent.sessions.filter(s => {
        const sessionDate = new Date(s.date);
        return sessionDate >= monthStart && sessionDate <= monthEnd;
    });
    
    // Como reverse() no modifica el array original, necesitamos el √≠ndice invertido
    const reversedIndex = monthSessions.length - 1 - sessionIndex;
    const session = monthSessions[reversedIndex];
    
    if (!session) {
        alert('Sesi√≥n no encontrada');
        return;
    }
    
    // Encontrar el √≠ndice real en el array completo de sesiones
    currentEditingSessionIndex = currentStudent.sessions.findIndex(s => 
        s.date === session.date && s.dayName === session.dayName && s.timestamp === session.timestamp
    );
    
    if (currentEditingSessionIndex === -1) {
        alert('Error: no se pudo encontrar la sesi√≥n');
        return;
    }
    
    // Llenar el modal
    document.getElementById('editSessionDate').value = session.date;
    document.getElementById('editSessionDay').value = session.dayName || '-';
    document.getElementById('editSessionBodyWeight').value = session.bodyWeight || currentStudent.weight;
    
    // Renderizar bloques y ejercicios
    renderEditSessionBlocks(session);
    
    openModal('editSession');
}

function renderEditSessionBlocks(session) {
    const container = document.getElementById('editSessionBlocks');
    
    if (!session.blocks || session.blocks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">Esta sesi√≥n no tiene ejercicios registrados</p>';
        return;
    }
    
    const iconMap = {
        'movilidad': 'üì±',
        'core': 'üü°',
        'fuerza-inferior': 'üîµ',
        'fuerza-superior': 'üü£'
    };
    
    container.innerHTML = session.blocks.map((block, blockIdx) => `
        <div class="block block-type-${block.type}" style="margin-bottom: 16px;">
            <div class="block-header">
                <div class="block-title">
                    <div class="block-icon">${iconMap[block.type] || 'üìã'}</div>
                    ${block.name}
                </div>
            </div>
            ${block.exercises.map((ex, exIdx) => `
                <div class="exercise">
                    <div class="exercise-header">
                        <div class="exercise-name">
                            ${ex.isPrincipal ? '‚≠ê ' : ''}${ex.name}
                        </div>
                    </div>
                    <div class="exercise-inputs">
                        <div class="exercise-input-group">
                            <label class="exercise-input-label">Series</label>
                            <input type="number" class="form-input" value="${ex.series || ''}" 
                                   id="editSess_${blockIdx}_${exIdx}_series" min="1" />
                        </div>
                        <div class="exercise-input-group">
                            <label class="exercise-input-label">Reps</label>
                            <input type="text" class="form-input" value="${ex.reps || ''}" 
                                   id="editSess_${blockIdx}_${exIdx}_reps" />
                        </div>
                        <div class="exercise-input-group">
                            <label class="exercise-input-label">Peso (kg)</label>
                            <input type="number" class="form-input" value="${ex.weight || ''}" 
                                   id="editSess_${blockIdx}_${exIdx}_weight" step="0.5" />
                        </div>
                        <div class="exercise-input-group">
                            <label class="exercise-input-label">RPE (1-10)</label>
                            <input type="number" class="form-input" value="${ex.rpe || ''}" 
                                   id="editSess_${blockIdx}_${exIdx}_rpe" min="1" max="10" step="0.5" />
                        </div>
                    </div>
                    ${ex.isPrincipal ? `
                        <div style="margin-top: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--primary-blue);">
                                <input type="checkbox" ${ex.isPR ? 'checked' : ''} 
                                       id="editSess_${blockIdx}_${exIdx}_isPR" />
                                üèÜ R√©cord Personal
                            </label>
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
    `).join('');
}

function saveEditedSession() {
    if (currentEditingSessionIndex === null || !currentStudent) return;
    
    const session = currentStudent.sessions[currentEditingSessionIndex];
    
    // Actualizar fecha y peso corporal
    session.date = document.getElementById('editSessionDate').value;
    session.bodyWeight = parseFloat(document.getElementById('editSessionBodyWeight').value);
    
    // Recalcular m√©tricas
    let totalVolume = 0;
    let totalRPE = 0;
    let rpeCount = 0;
    let prsCount = 0;
    
    session.blocks.forEach((block, blockIdx) => {
        block.exercises.forEach((ex, exIdx) => {
            // Obtener valores actualizados del DOM
            const series = parseInt(document.getElementById(`editSess_${blockIdx}_${exIdx}_series`).value) || ex.series;
            const reps = document.getElementById(`editSess_${blockIdx}_${exIdx}_reps`).value || ex.reps;
            const weight = parseFloat(document.getElementById(`editSess_${blockIdx}_${exIdx}_weight`).value) || ex.weight;
            const rpe = parseFloat(document.getElementById(`editSess_${blockIdx}_${exIdx}_rpe`).value) || ex.rpe;
            const isPRCheckbox = document.getElementById(`editSess_${blockIdx}_${exIdx}_isPR`);
            const isPR = isPRCheckbox ? isPRCheckbox.checked : ex.isPR;
            
            // Actualizar ejercicio
            ex.series = series;
            ex.reps = reps;
            ex.weight = weight;
            ex.rpe = rpe;
            ex.isPR = isPR;
            
            // Recalcular volumen
            if (weight && series && reps) {
                const repsNum = parseFloat(reps) || 0;
                totalVolume += weight * series * repsNum;
            }
            
            if (rpe) {
                totalRPE += rpe;
                rpeCount++;
            }
            
            if (isPR) prsCount++;
        });
    });
    
    // Actualizar m√©tricas de la sesi√≥n
    session.volume = Math.round(totalVolume);
    session.avgRPE = rpeCount > 0 ? parseFloat((totalRPE / rpeCount).toFixed(1)) : 0;
    session.prs = prsCount;
    
    // Guardar
    const studentIndex = students.findIndex(s => s.id === currentStudent.id);
    if (studentIndex !== -1) {
        students[studentIndex] = currentStudent;
    }
    
    // Actualizar m√©tricas de gamificaci√≥n
    updateStudentMetrics(currentStudent);
    
    saveToSheets();
    closeModal('editSession');
    renderDashboard();
    
    alert(`‚úÖ Sesi√≥n actualizada!\n\nüìä Volumen: ${session.volume}kg\n‚≠ê RPE: ${session.avgRPE}\nüèÜ PRs: ${prsCount}`);
    
    currentEditingSessionIndex = null;
}

function deleteEditedSession() {
    if (currentEditingSessionIndex === null || !currentStudent) return;
    
    const session = currentStudent.sessions[currentEditingSessionIndex];
    
    if (!confirm(`¬øEliminar la sesi√≥n del ${new Date(session.date).toLocaleDateString('es-AR')}?`)) return;
    
    // Eliminar sesi√≥n
    currentStudent.sessions.splice(currentEditingSessionIndex, 1);
    
    // Guardar
    const studentIndex = students.findIndex(s => s.id === currentStudent.id);
    if (studentIndex !== -1) {
        students[studentIndex] = currentStudent;
    }
    
    // Actualizar m√©tricas
    updateStudentMetrics(currentStudent);
    
    saveToSheets();
    closeModal('editSession');
    renderDashboard();
    renderStudents();
    
    alert('‚úÖ Sesi√≥n eliminada');
    
    currentEditingSessionIndex = null;
}
        async function forceSyncAll() {
    if (!sheetsUrl) {
        alert('‚ö†Ô∏è Primero configur√° la URL de Google Sheets');
        return;
    }
    
    if (!confirm('¬øForzar sincronizaci√≥n completa?\n\nEsto sobrescribir√° los datos en Google Sheets con los datos locales actuales.')) {
        return;
    }
    
    console.log('üîÑ Iniciando sincronizaci√≥n forzada...');
    showLoading(true);
    
    // Recalcular m√©tricas de TODOS los estudiantes
    students.forEach(student => {
        updateStudentMetrics(student);
    });
    
    // Guardar TODO
    await saveToSheets();
    
    showLoading(false);
alert('‚úÖ Sincronizaci√≥n completa exitosa!\n\nTodos los datos y m√©tricas fueron guardados en Google Sheets.');
}
    </script>
<!-- Modal Nuevo Objetivo SMART -->
<div id="modal-newGoal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <h3 class="modal-title">üéØ Nuevo Objetivo SMART</h3>
        
        <div class="form-group">
            <label class="form-label">Tipo de Objetivo</label>
            <select id="goalType" class="form-input" onchange="document.getElementById('exerciseField').style.display = this.value === 'strength' ? 'block' : 'none';">
                <option value="volume">üìà Aumentar Volumen Mensual (toneladas)</option>
                <option value="strength">üí™ Aumentar Fuerza en Ejercicio (kg)</option>
                <option value="attendance">üìÖ Mejorar Asistencia (clases/mes)</option>
                <option value="prs">üèÜ Romper Records Personales</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Descripci√≥n del Objetivo *</label>
            <input type="text" id="goalDesc" class="form-input" placeholder="Ej: Aumentar de 60 a 70 toneladas mensuales" />
        </div>
        
        <div id="exerciseField" class="form-group" style="display: none;">
            <label class="form-label">Ejercicio Espec√≠fico</label>
            <input type="text" id="goalExercise" class="form-input" placeholder="Ej: Sentadilla" list="exercisesList" />
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
                <label class="form-label">Valor Objetivo *</label>
                <input type="number" id="goalTarget" class="form-input" placeholder="70" step="0.1" />
            </div>
            <div class="form-group">
                <label class="form-label">Fecha L√≠mite *</label>
                <input type="date" id="goalDeadline" class="form-input" />
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Recompensa (opcional)</label>
            <input type="text" id="goalReward" class="form-input" placeholder="Ej: Batido gratis, Descuento 10%, Remera" />
        </div>
        
        <div style="background: #f0f9ff; border: 2px solid #86efac; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <strong style="color: #1e3a8a;">üí° Tips SMART:</strong><br>
            <ul style="margin-top: 8px; font-size: 13px; color: #666;">
                <li><strong>Espec√≠fico:</strong> Defin√≠ claramente qu√©</li>
                <li><strong>Medible:</strong> N√∫meros concretos</li>
                <li><strong>Alcanzable:</strong> Realista</li>
                <li><strong>Relevante:</strong> Alineado al objetivo</li>
                <li><strong>Tiempo:</strong> Fecha l√≠mite</li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 12px;">
            <button onclick="saveGoal()" class="btn btn-primary" style="flex: 1;">‚úÖ Crear Objetivo</button>
            <button onclick="closeModal('newGoal')" class="btn btn-secondary">Cancelar</button>
        </div>
    </div>
</div>
    <!-- Modal Editar Sesi√≥n -->
<div id="modal-editSession" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <h3 class="modal-title">‚úèÔ∏è Editar Sesi√≥n</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-gray); border-radius: 8px;">
            <div>
                <label class="form-label">üìÖ Fecha</label>
                <input type="date" id="editSessionDate" class="form-input" />
            </div>
            <div>
                <label class="form-label">üèãÔ∏è D√≠a</label>
                <input type="text" id="editSessionDay" class="form-input" readonly />
            </div>
            <div>
                <label class="form-label">‚öñÔ∏è Peso Corporal (kg)</label>
                <input type="number" id="editSessionBodyWeight" class="form-input" step="0.1" />
            </div>
        </div>

        <div id="editSessionBlocks" style="max-height: 400px; overflow-y: auto;"></div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-primary" style="flex: 1;" onclick="saveEditedSession()">üíæ Guardar Cambios</button>
            <button class="btn btn-secondary" onclick="closeModal('editSession')">Cancelar</button>
            <button class="btn btn-secondary" onclick="deleteEditedSession()" style="background: var(--danger); color: white;">üóëÔ∏è Eliminar Sesi√≥n</button>
        </div>
    </div>
</div>
</body>
</html>
