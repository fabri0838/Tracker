<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker - Sistema de Alto Rendimiento</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Montserrat:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-blue: #2563EB;
            --dark-blue: #1E40AF;
            --light-blue: #3B82F6;
            --bg-white: #FFFFFF;
            --bg-gray: #F8FAFC;
            --text-dark: #0F172A;
            --text-gray: #64748B;
            --text-light: #94A3B8;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --border: #E2E8F0;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gray);
            color: var(--text-dark);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* HEADER */
        .header {
            background: var(--bg-white);
            padding: 24px 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 36px;
            color: var(--text-dark);
            letter-spacing: 4px;
            text-transform: uppercase;
            font-weight: 900;
        }
        
        .logo-text p {
            font-size: 11px;
            color: var(--primary-blue);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .sync-btn {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-gray);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sync-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-gray);
            padding: 4px;
            border-radius: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-gray);
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-tab.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: white;
        }
        
        /* CONTENT */
        .content {
            padding: 32px 40px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* CARDS */
        .card {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .card-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 24px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* BUTTONS */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--dark-blue);
        }
        
        .btn-secondary {
            background: var(--bg-gray);
            color: var(--text-gray);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 11px;
        }
        
        /* TRAINING DAY CARD */
        .training-day-card {
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .training-day-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        .training-day-card h3 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 16px;
            color: var(--text-dark);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .training-day-card p {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 12px;
        }
        
        .training-day-badge {
            display: inline-block;
            background: var(--bg-gray);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
        }
        
        .delete-day-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .training-day-card:hover .delete-day-btn {
            opacity: 1;
        }
        
        /* STUDENTS GRID */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .student-card {
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .student-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        .student-name {
            font-family: 'Archivo Black', sans-serif;
            font-size: 18px;
            color: var(--text-dark);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .student-info {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }
        
        .student-goal {
            font-size: 12px;
            color: var(--primary-blue);
            font-weight: 700;
            margin-top: 12px;
        }
        
        /* BLOCKS */
        .block {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .block-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 16px;
            color: var(--text-dark);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .block-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .block-type-movilidad .block-icon { background: #FEF3C7; }
        .block-type-core .block-icon { background: #FED7AA; }
        .block-type-fuerza-inferior .block-icon { background: #DBEAFE; }
        .block-type-fuerza-superior .block-icon { background: #F3E8FF; }
        
        .exercise {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .exercise-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .exercise-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .exercise-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .exercise-input-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .exercise-input {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        .exercise-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        /* FORMS */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 20px;
            color: var(--text-dark);
            text-transform: uppercase;
            margin-bottom: 24px;
        }
        
        /* LOADING */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-white);
            padding: 24px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 700;
            color: var(--primary-blue);
        }
        
        .loading.active {
            display: block;
        }
        
        /* CONFIG BANNER */
        .config-banner {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #FCD34D;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .config-banner.configured {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-color: #6EE7B7;
        }
        
        .config-icon {
            font-size: 32px;
        }
        
        .config-text h3 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .config-text p {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        /* METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--bg-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-family: 'Archivo Black', sans-serif;
            font-size: 32px;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        
        /* MONTH COMPARISON */
        .month-comparison {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .month-box {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        
        .month-box.current {
            background: var(--primary-blue);
            color: white;
        }
        
        .month-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .month-value {
            font-family: 'Archivo Black', sans-serif;
            font-size: 28px;
        }
        
        /* ATTENDANCE */
        .attendance-section {
            margin-bottom: 32px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .attendance-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 16px;
            text-transform: uppercase;
        }
        
        .goal-progress-bar {
            width: 100%;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
            transition: width 0.3s;
        }
        
        /* PROGRESS TABLE */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .progress-table th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }
        
        .progress-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        /* ================================================
           RESPONSIVE DESIGN - MOBILE
           ================================================ */
        
        @media (max-width: 768px) {
            .app-container { padding: 0; }
            .header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
            .logo-section { flex: 1 1 100%; justify-content: center; }
            .nav-tabs { gap: 4px; }
            .nav-tab { padding: 8px 10px; font-size: 11px; letter-spacing: 0.5px; }
            .content { padding: 16px; }
            .students-grid { grid-template-columns: 1fr !important; gap: 12px; }
            .student-card { padding: 16px; }
            .metrics-grid { grid-template-columns: 1fr 1fr !important; gap: 12px; }
            .metric-card { padding: 16px; }
            .metric-value { font-size: 28px; }
            .form-input, .form-select { font-size: 16px; }
            .modal-content { width: 95%; max-width: 95%; margin: 20px auto; max-height: 90vh; overflow-y: auto; }
            button, .btn { min-height: 44px; font-size: 14px; }
            .progress-table { font-size: 12px; }
            .progress-table th, .progress-table td { padding: 8px 4px; }
            .month-comparison { display: none; }
            .card { padding: 16px; margin-bottom: 16px; }
            .config-banner { font-size: 12px; padding: 8px; }
            #searchStudent { width: 100%; max-width: 100% !important; }
            .training-day-card { min-height: auto; padding: 16px; }
            .block { margin-bottom: 16px; }
            .block-header { padding: 12px; flex-wrap: wrap; }
            .exercise-inputs { grid-template-columns: 1fr 1fr; }
            .exercise-table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .exercise-table input { min-width: 60px; font-size: 16px; }
        }
        
        @media (hover: none) and (pointer: coarse) {
            button, .btn { min-height: 48px; padding: 12px 20px; }
            .student-card { min-height: 100px; }
        }

        /* UPLOAD BANNER */
        .upload-banner {
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            border: 2px solid #93C5FD;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .upload-banner .upload-icon { font-size: 28px; }
        .upload-banner .upload-text h3 { font-family: 'Archivo Black', sans-serif; font-size: 15px; margin-bottom: 4px; color: var(--text-dark); }
        .upload-banner .upload-text p { font-size: 13px; color: var(--text-gray); }
        .upload-banner .btn-upload {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .upload-banner .btn-upload:hover { background: var(--dark-blue); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon" id="appLogo"></div>
                <div class="logo-text">
                    <h1>TRACKER</h1>
                    <p>Precision Engineered</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="sync-btn" id="syncBtn" onclick="syncFromSheets()" style="display: none;">
                    üîÑ Sincronizar
                </button>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('alumnos', this)">üë• ATLETAS</button>
                    <button class="nav-tab" onclick="switchView('dashboard', this)">üìä M√âTRICAS</button>
                    <button class="nav-tab" onclick="switchView('plan', this)">üìã PLAN</button>
                    <button class="nav-tab" onclick="switchView('config', this)">‚öôÔ∏è CONFIG</button>
                </nav>
            </div>
        </div>

        <div class="loading" id="loading">Cargando...</div>

        <!-- VIEW: ALUMNOS -->
        <div id="view-alumnos" class="view active content">
            <!-- Banner de upload aparece solo cuando Sheets est√° vac√≠a pero localStorage tiene datos -->
            <div id="uploadBanner" style="display: none;" class="upload-banner">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">
                    <h3>Datos no sincronizados</h3>
                    <p>Ten√©s datos locales que no est√°n en la nube. Subite una vez para que otros dispositivos los vean.</p>
                </div>
                <button class="btn-upload" onclick="forceUploadToSheets()">‚¨ÜÔ∏è Subir Ahora</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Atletas</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="text" id="searchStudent" class="form-input" placeholder="üîç Buscar atleta..." 
                               style="max-width: 300px; margin: 0;" onkeyup="filterStudents()" />
                        <button class="btn btn-secondary" onclick="openModal('importComplete')">
                            üì• Importar Completo (CSV)
                        </button>
                        <button class="btn btn-primary" onclick="openModal('addStudent')">
                            ‚ûï Nuevo Atleta
                        </button>
                    </div>
                </div>
                <div id="studentsContainer" class="students-grid"></div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìä M√âTRICAS DE <span id="dashboardStudentName" style="color: var(--primary-blue);">-</span>
                    </h2>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê Mes Anterior</button>
                        <span id="currentMonthDisplay" style="font-size: 14px; font-weight: 700; color: var(--text-gray); min-width: 150px; text-align: center;">-</span>
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Mes Siguiente ‚Üí</button>
                    </div>
                </div>
                <div id="dashboardContent">
                    <p style="text-align: center; color: var(--text-gray); padding: 40px;">
                        Seleccion√° un atleta para ver sus m√©tricas
                    </p>
                </div>
            </div>
        </div>

        <!-- VIEW: PLAN -->
        <div id="view-plan" class="view content">
            <div class="card" id="planDaysCard">
                <div class="card-header">
                    <h2 class="card-title">üìã Plan de <span id="currentStudentName">-</span></h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="openModal('importPlan')">üì• Importar</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportAllDays()">üì§ Exportar</button>
                        <button class="btn btn-secondary btn-sm" onclick="switchView('alumnos', document.querySelector('.nav-tab'))">‚Üê Volver</button>
                    </div>
                </div>
                <div id="trainingDaysList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;"></div>
                <button class="btn btn-primary" onclick="openModal('addTrainingDay')">‚ûï Agregar D√≠a de Entrenamiento</button>
            </div>

            <div class="card" id="currentDayView" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">üèãÔ∏è <span id="currentDayTitle">-</span></h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="closeDayView()">‚Üê Volver a D√≠as</button>
                        <button class="btn btn-primary btn-sm" onclick="saveSession()">üíæ Guardar Sesi√≥n</button>
                    </div>
                </div>
                <div style="margin-bottom: 32px; display: grid; grid-template-columns: 1fr 180px; gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">üìÖ Fecha Sesi√≥n</label>
                        <input type="date" id="sessionDate" class="form-input" />
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">‚öñÔ∏è Peso Corporal (kg)</label>
                        <input type="number" id="bodyWeight" class="form-input" placeholder="75" step="0.1" />
                    </div>
                </div>
                <div id="blocksContainer"></div>
                <button class="btn btn-secondary" onclick="openModal('addBlock')" style="margin-top: 24px;">‚ûï Agregar Bloque</button>
            </div>
        </div>

        <!-- VIEW: CONFIG -->
        <div id="view-config" class="view content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Configuraci√≥n</h2>
                </div>
                <div id="configBanner" class="config-banner">
                    <div class="config-icon">‚ö†Ô∏è</div>
                    <div class="config-text">
                        <h3>Configuraci√≥n Requerida</h3>
                        <p>Conect√° tu Google Sheet para guardar datos en la nube</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">üîó URL de Google Apps Script</label>
                    <input type="text" id="sheetsUrl" class="form-input" placeholder="https://script.google.com/..." />
                    <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">La URL debe terminar en /exec</div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar Configuraci√≥n</button>
                <hr style="margin: 40px 0; border: none; border-top: 2px solid var(--border);">
                <h3 style="font-family: 'Archivo Black'; font-size: 16px; margin-bottom: 20px; text-transform: uppercase;">üé® Personalizaci√≥n</h3>
                <div class="form-group">
                    <label class="form-label">Logo Personalizado</label>
                    <input type="file" id="logoUpload" class="form-input" accept="image/*" onchange="handleLogoUpload(event)" />
                    <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">Recomendado: PNG con fondo transparente, 200x200px</div>
                </div>
                <div id="logoPreview" style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-gray); border-radius: 12px;">
                    <img id="logoPreviewImg" style="max-width: 100px; height: auto; display: block; margin-bottom: 12px;" />
                    <button class="btn btn-secondary btn-sm" onclick="removeLogo()">üóëÔ∏è Eliminar Logo</button>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="modal-addStudent" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Atleta</h3>
                <form onsubmit="addStudent(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="studentName" class="form-input" required />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" id="studentAge" class="form-input" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="studentWeight" class="form-input" required step="0.1" min="1" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <input type="text" id="studentGoal" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clases Mensuales</label>
                        <input type="number" id="studentClasses" class="form-input" required min="1" />
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear Atleta</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudent')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addTrainingDay" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo D√≠a de Entrenamiento</h3>
                <form onsubmit="addTrainingDay(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del D√≠a</label>
                        <input type="text" id="dayName" class="form-input" placeholder="ej: D√≠a A - Tren Superior" required />
                        <div style="font-size: 12px; color: var(--text-gray); margin-top: 8px;">Ejemplos: "D√≠a A", "D√≠a 1 - Tren Superior", "Lunes - Push"</div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crear D√≠a</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addTrainingDay')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addBlock" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuevo Bloque</h3>
                <form onsubmit="addBlock(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Bloque</label>
                        <input type="text" id="blockName" class="form-input" placeholder="ej: Calentamiento" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Bloque</label>
                        <select id="blockType" class="form-input" required>
                            <option value="movilidad">Movilidad</option>
                            <option value="core">Core</option>
                            <option value="fuerza-inferior">Fuerza - Tren Inferior</option>
                            <option value="fuerza-superior">Fuerza - Tren Superior</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Bloque</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBlock')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-addExercise" class="modal">
            <div class="modal-content">
                <h3 class="modal-title" id="exerciseModalTitle">‚ûï Nuevo Ejercicio</h3>
                <form onsubmit="addExercise(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Ejercicio</label>
                        <input type="text" id="exerciseName" class="form-input" placeholder="Press de banca" required list="exercisesList" />
                        <datalist id="exercisesList"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Series</label>
                            <input type="number" id="exerciseSeries" class="form-input" placeholder="3" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Repeticiones</label>
                            <input type="text" id="exerciseReps" class="form-input" placeholder="10" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="exerciseIsPrincipal" />
                            <span style="font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Marcar como principal (tracking de PR)</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Agregar Ejercicio</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addExercise')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-importComplete" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h3 class="modal-title">üì• Importaci√≥n Completa - Alumnos + D√≠as + Planes</h3>
                <div style="background: var(--bg-gray); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h4 style="font-family: 'Archivo Black'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">üìã Formato Requerido</h4>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 10px; overflow-x: auto;">
                        <strong>Alumno,Edad,Peso,Objetivo,Clases,Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importCompleteFile" class="form-input" accept=".csv" onchange="handleCompleteImport(event)" />
                </div>
                <div id="completeImportPreview" style="display: none; margin-top: 20px;">
                    <h4 style="font-family: 'Archivo Black'; font-size: 14px; text-transform: uppercase; margin-bottom: 12px;">Vista Previa</h4>
                    <div style="max-height: 300px; overflow-y: auto; background: var(--bg-gray); padding: 16px; border-radius: 8px;">
                        <div id="completeImportPreviewBody" style="font-size: 13px;"></div>
                    </div>
                    <p id="completeImportCount" style="font-size: 13px; font-weight: 700; color: var(--primary-blue); margin-top: 12px;"></p>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processCompleteImport()" id="btnImportComplete" disabled>‚úì Importar Todo</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importComplete')">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modal-importPlan" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <h3 class="modal-title">üì• Importar D√≠as + Planes</h3>
                <div style="background: var(--bg-gray); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="background: white; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px; overflow-x: auto;">
                        <strong>Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Seleccionar Archivo CSV</label>
                    <input type="file" id="importPlanFile" class="form-input" accept=".csv" onchange="handlePlanImport(event)" />
                </div>
                <div id="planImportPreview" style="display: none; margin-top: 20px;">
                    <div id="planImportPreviewBody"></div>
                    <p id="planImportCount" style="font-size: 13px; font-weight: 700; color: var(--primary-blue); margin-top: 12px;"></p>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="button" class="btn btn-primary" style="flex: 1;" onclick="processPlanImport()" id="btnImportPlan" disabled>‚úì Importar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importPlan')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================================
        // GLOBAL STATE
        // ================================================
        let students = [];
        let exerciseDatabase = JSON.parse(localStorage.getItem('gymTracker_exercises')) || [];
        let currentStudent = null;
        let currentDay = null;
        let currentBlockForExercise = null;
        let editingExercise = null;
        let lastSyncTimestamp = null;
        let sheetsUrl = localStorage.getItem('gymTracker_sheetsUrl') || '';
        let currentMonth = new Date();
        let customLogo = localStorage.getItem('gymTracker_customLogo') || null;

        // ================================================
        // INITIALIZE
        // ================================================
        function initialize() {
            loadLogo();
            
            const savedUrl = localStorage.getItem('gymTracker_sheetsUrl');
            if (savedUrl) {
                sheetsUrl = savedUrl;
                document.getElementById('sheetsUrl').value = savedUrl;
                updateConfigBanner(true);
                loadFromSheetsAuto(); // Intenta cargar desde Sheets
            } else {
                updateConfigBanner(false);
                loadFromLocalStorageFallback();
            }
            
            updateExercisesList();
            updateMonthDisplay();
            document.getElementById('sessionDate').valueAsDate = new Date();
        }
        
        initialize();

        // ================================================
        // LOGO
        // ================================================
        function loadLogo() {
            const logoContainer = document.getElementById('appLogo');
            if (customLogo) {
                logoContainer.innerHTML = '<img src="' + customLogo + '" alt="Logo" style="width: 64px; height: 64px; object-fit: contain;" />';
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPreviewImg').src = customLogo;
            } else {
                logoContainer.innerHTML = '<div style="width: 64px; height: 64px; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: Archivo Black; font-size: 32px; color: white; letter-spacing: -2px;">T</div>';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) { alert('Seleccion√° una imagen v√°lida'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                customLogo = e.target.result;
                localStorage.setItem('gymTracker_customLogo', customLogo);
                loadLogo();
                alert('‚úÖ Logo actualizado!');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (!confirm('¬øEliminar logo personalizado?')) return;
            customLogo = null;
            localStorage.removeItem('gymTracker_customLogo');
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('logoUpload').value = '';
            loadLogo();
        }

        // ================================================
        // MONTH NAVIGATION
        // ================================================
        function updateMonthDisplay() {
            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('currentMonthDisplay').textContent = months[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            updateMonthDisplay();
            if (currentStudent) renderDashboard();
        }

        // ================================================
        // CONFIG
        // ================================================
        function saveConfig() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) { alert('Ingres√° la URL de Google Apps Script'); return; }
            if (!url.includes('script.google.com') || !url.includes('/exec')) { alert('La URL debe ser de Google Apps Script y terminar en /exec'); return; }
            
            sheetsUrl = url;
            localStorage.setItem('gymTracker_sheetsUrl', url);
            updateConfigBanner(true);
            
            // Al guardar config, intentar cargar. Si Sheets est√° vac√≠a y hay datos locales, ofrecer subir.
            loadFromSheets().then(() => {
                alert('‚úÖ Configuraci√≥n guardada!');
            });
        }

        function updateConfigBanner(configured) {
            const banner = document.getElementById('configBanner');
            if (configured) {
                banner.className = 'config-banner configured';
                banner.innerHTML = '<div class="config-icon">‚úÖ</div><div class="config-text"><h3>Conectado a Google Sheets</h3><p>Los datos se guardan autom√°ticamente en la nube</p></div>';
                document.getElementById('syncBtn').style.display = 'block';
            } else {
                banner.className = 'config-banner';
                banner.innerHTML = '<div class="config-icon">‚ö†Ô∏è</div><div class="config-text"><h3>Configuraci√≥n Requerida</h3><p>Conect√° tu Google Sheet para guardar datos en la nube</p></div>';
                document.getElementById('syncBtn').style.display = 'none';
            }
        }
        
        async function syncFromSheets() {
            if (!sheetsUrl) { alert('No hay URL configurada'); return; }
            if (confirm('¬øCargar datos desde Google Sheets? Esto sobrescribir√° los datos locales.')) {
                await loadFromSheets();
                alert('‚úÖ Datos sincronizados');
            }
        }

        // ================================================
        // SYNC: LOAD / SAVE
        // ================================================
        async function loadFromSheets() {
            if (!sheetsUrl) return;
            showLoading(true);
            try {
                const response = await fetch(sheetsUrl + '?action=loadStudents', { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                
                if (data.students && data.students.length > 0) {
                    students = data.students;
                    localStorage.setItem('gymTracker_students', JSON.stringify(students));
                    renderStudents();
                    hideUploadBanner();
                    console.log('‚úÖ Datos cargados:', students.length, 'atletas');
                } else {
                    // Sheets est√° vac√≠a ‚Äî verificar si hay datos locales para subir
                    console.log('‚ö†Ô∏è Sheets vac√≠a');
                    loadFromLocalStorageFallback();
                    checkAndShowUploadBanner();
                }
            } catch (error) {
                console.error('‚ùå Error cargando:', error);
                loadFromLocalStorageFallback();
                checkAndShowUploadBanner();
            }
            showLoading(false);
        }

        async function saveToSheets() {
            localStorage.setItem('gymTracker_students', JSON.stringify(students));
            if (!sheetsUrl) { console.log('üíæ Guardado en localStorage'); return; }

            try {
                await fetch(sheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveStudents', students: students })
                });
                console.log('‚úÖ Guardado en Sheets + localStorage');
                hideUploadBanner(); // Ya se subi√≥, ocultar banner
            } catch (error) {
                console.error('‚ö†Ô∏è Error guardando:', error);
            }
        }

        // ================================================
        // AUTO-SYNC y FALLBACK
        // ================================================
        async function loadFromSheetsAuto() {
            if (!sheetsUrl) { loadFromLocalStorageFallback(); return; }
            
            try {
                const response = await fetch(sheetsUrl + '?action=loadStudents', { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                
                if (data.students && data.students.length > 0) {
                    students = data.students;
                    localStorage.setItem('gymTracker_students', JSON.stringify(students));
                    renderStudents();
                    hideUploadBanner();
                    console.log('‚úÖ Auto-sync: ' + students.length + ' atletas');
                } else {
                    // Sheets vac√≠a ‚Äî usar localStorage y mostrar banner si hay datos
                    console.log('‚ö†Ô∏è Sheets no tiene datos, usando localStorage');
                    loadFromLocalStorageFallback();
                    checkAndShowUploadBanner();
                }
            } catch (error) {
                console.warn('Auto-sync error:', error.message);
                loadFromLocalStorageFallback();
                checkAndShowUploadBanner();
            }
        }
        
        function loadFromLocalStorageFallback() {
            const localData = localStorage.getItem('gymTracker_students');
            if (localData) {
                students = JSON.parse(localData);
                students = students.map(function(s) {
                    if (!s.trainingDays && s.blocks) {
                        return Object.assign({}, s, {
                            trainingDays: [{ id: Date.now(), name: "Plan Principal", blocks: s.blocks }],
                            blocks: undefined
                        });
                    }
                    return s;
                });
                renderStudents();
                console.log('üìã Datos cargados desde localStorage: ' + students.length + ' atletas');
            }
        }

        // ================================================
        // UPLOAD BANNER ‚Äî aparece cuando Sheets est√° vac√≠a pero localStorage tiene datos
        // ================================================
        function checkAndShowUploadBanner() {
            if (sheetsUrl && students && students.length > 0) {
                document.getElementById('uploadBanner').style.display = 'flex';
            }
        }

        function hideUploadBanner() {
            document.getElementById('uploadBanner').style.display = 'none';
        }

        // Bot√≥n "Subir Ahora" ‚Äî force POST con los datos actuales
        async function forceUploadToSheets() {
            if (!sheetsUrl || students.length === 0) return;
            showLoading(true);
            try {
                await fetch(sheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveStudents', students: students })
                });
                hideUploadBanner();
                alert('‚úÖ ' + students.length + ' atletas subidos a Google Sheets. Ahora cualquier dispositivo los va a ver.');
                console.log('‚úÖ Force upload completado');
            } catch (error) {
                alert('‚ùå Error al subir. Verific√° tu conexi√≥n.');
                console.error(error);
            }
            showLoading(false);
        }

        // ================================================
        // UI HELPERS
        // ================================================
        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading active' : 'loading';
        }

        function switchView(viewName, btn) {
            document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
            document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('view-' + viewName).classList.add('active');
            if (btn) btn.classList.add('active');
            if (viewName === 'dashboard' && currentStudent) renderDashboard();
        }

        function openModal(modalName) { document.getElementById('modal-' + modalName).classList.add('active'); }
        function closeModal(modalName) { document.getElementById('modal-' + modalName).classList.remove('active'); }

        // ================================================
        // STUDENTS
        // ================================================
        function filterStudents() {
            const term = document.getElementById('searchStudent').value.toLowerCase();
            document.querySelectorAll('.student-card').forEach(function(card) {
                card.style.display = card.querySelector('.student-name').textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }

        function deleteStudent(studentId) {
            const student = students.find(function(s) { return s.id === studentId; });
            if (!student || !confirm('¬øEliminar a ' + student.name + ' y todas sus sesiones?')) return;
            students = students.filter(function(s) { return s.id !== studentId; });
            if (currentStudent && currentStudent.id === studentId) { currentStudent = null; currentDay = null; }
            saveToSheets();
            renderStudents();
        }

        function addStudent(e) {
            e.preventDefault();
            const student = {
                id: Date.now(),
                name: document.getElementById('studentName').value,
                age: parseInt(document.getElementById('studentAge').value),
                weight: parseFloat(document.getElementById('studentWeight').value),
                goal: document.getElementById('studentGoal').value,
                monthlyClasses: parseInt(document.getElementById('studentClasses').value),
                trainingDays: [],
                sessions: [],
                attendance: {},
                createdAt: new Date().toISOString()
            };
            students.push(student);
            saveToSheets();
            renderStudents();
            closeModal('addStudent');
            e.target.reset();
        }

        function renderStudents() {
            const container = document.getElementById('studentsContainer');
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">No hay atletas. Agreg√° uno nuevo o import√° desde CSV.</p>';
                return;
            }
            container.innerHTML = students.map(function(student) {
                const daysCount = student.trainingDays ? student.trainingDays.length : 0;
                const sessionsCount = student.sessions ? student.sessions.length : 0;
                return '<div class="student-card" onclick="selectStudent(' + student.id + ')" style="position: relative;">' +
                    '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); deleteStudent(' + student.id + ')" style="position: absolute; top: 12px; right: 12px; padding: 6px 10px; background: var(--danger); color: white;">üóëÔ∏è</button>' +
                    '<div class="student-name">' + student.name + '</div>' +
                    '<div class="student-info">üìÖ ' + student.age + ' a√±os ‚Ä¢ ‚öñÔ∏è ' + student.weight + 'kg</div>' +
                    '<div class="student-info">üéØ ' + student.monthlyClasses + ' clases/mes</div>' +
                    '<div class="student-info">üèãÔ∏è ' + daysCount + ' d√≠a' + (daysCount !== 1 ? 's' : '') + ' de entrenamiento</div>' +
                    '<div class="student-info">üìä ' + sessionsCount + ' sesiones guardadas</div>' +
                    '<div class="student-goal">' + student.goal + '</div>' +
                    '</div>';
            }).join('');
        }

        function selectStudent(studentId) {
            currentStudent = students.find(function(s) { return s.id === studentId; });
            currentDay = null;
            document.getElementById('currentStudentName').textContent = currentStudent.name;
            document.getElementById('bodyWeight').value = currentStudent.weight;
            switchView('plan', document.querySelectorAll('.nav-tab')[2]);
            renderTrainingDays();
        }

        // ================================================
        // SYNC STUDENT DATA (centralizada)
        // ================================================
        function syncStudentData() {
            if (!currentStudent || !currentDay) return;
            const dIdx = currentStudent.trainingDays.findIndex(function(d) { return d.id === currentDay.id; });
            if (dIdx !== -1) currentStudent.trainingDays[dIdx] = currentDay;
            const sIdx = students.findIndex(function(s) { return s.id === currentStudent.id; });
            if (sIdx !== -1) students[sIdx] = currentStudent;
        }

        // ================================================
        // TRAINING DAYS
        // ================================================
        function addTrainingDay(e) {
            e.preventDefault();
            if (!currentStudent) { alert('Seleccion√° un atleta'); return; }
            const day = { id: Date.now(), name: document.getElementById('dayName').value, blocks: [] };
            if (!currentStudent.trainingDays) currentStudent.trainingDays = [];
            currentStudent.trainingDays.push(day);
            syncStudentData();
            saveToSheets();
            renderTrainingDays();
            closeModal('addTrainingDay');
            e.target.reset();
        }

        function renderTrainingDays() {
            const container = document.getElementById('trainingDaysList');
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px; grid-column: 1/-1;">No hay d√≠as de entrenamiento.</p>';
                document.getElementById('planDaysCard').style.display = 'block';
                document.getElementById('currentDayView').style.display = 'none';
                return;
            }
            container.innerHTML = currentStudent.trainingDays.map(function(day) {
                const blocksCount = day.blocks ? day.blocks.length : 0;
                const exercisesCount = day.blocks ? day.blocks.reduce(function(sum, b) { return sum + (b.exercises ? b.exercises.length : 0); }, 0) : 0;
                return '<div class="training-day-card" onclick="selectTrainingDay(' + day.id + ')" style="position: relative;">' +
                    '<div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">' +
                    '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editTrainingDay(' + day.id + ')" style="padding: 6px 10px;">‚úèÔ∏è</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); duplicateTrainingDay(' + day.id + ')" style="padding: 6px 10px; background: var(--success); color: white;">üìã</button>' +
                    '<button class="delete-day-btn" onclick="event.stopPropagation(); deleteTrainingDay(' + day.id + ')">üóëÔ∏è</button></div>' +
                    '<h3>' + day.name + '</h3>' +
                    '<p>' + blocksCount + ' bloque' + (blocksCount !== 1 ? 's' : '') + ' ‚Ä¢ ' + exercisesCount + ' ejercicios</p>' +
                    '<span class="training-day-badge">Click para entrenar</span></div>';
            }).join('');
            document.getElementById('planDaysCard').style.display = 'block';
            document.getElementById('currentDayView').style.display = 'none';
        }

        function selectTrainingDay(dayId) {
            currentDay = currentStudent.trainingDays.find(function(d) { return d.id === dayId; });
            if (!currentDay) return;
            document.getElementById('currentDayTitle').textContent = currentDay.name;
            document.getElementById('planDaysCard').style.display = 'none';
            document.getElementById('currentDayView').style.display = 'block';
            loadTrainingDay();
        }

        function closeDayView() { currentDay = null; renderTrainingDays(); }

        function deleteTrainingDay(dayId) {
            if (!confirm('¬øEliminar este d√≠a?')) return;
            currentStudent.trainingDays = currentStudent.trainingDays.filter(function(d) { return d.id !== dayId; });
            syncStudentData();
            saveToSheets();
            renderTrainingDays();
        }

        function editTrainingDay(dayId) {
            const day = currentStudent.trainingDays.find(function(d) { return d.id === dayId; });
            if (!day) return;
            const newName = prompt('Nuevo nombre:', day.name);
            if (!newName || newName === day.name) return;
            day.name = newName;
            syncStudentData();
            saveToSheets();
            renderTrainingDays();
        }

        function duplicateTrainingDay(dayId) {
            const original = currentStudent.trainingDays.find(function(d) { return d.id === dayId; });
            if (!original) return;
            const newName = prompt('Nombre del nuevo d√≠a:', original.name + ' (copia)');
            if (!newName) return;
            currentStudent.trainingDays.push({ id: Date.now(), name: newName, blocks: JSON.parse(JSON.stringify(original.blocks)) });
            syncStudentData();
            saveToSheets();
            renderTrainingDays();
        }

        // ================================================
        // BLOCKS & EXERCISES
        // ================================================
        function loadTrainingDay() {
            if (!currentDay) return;
            const container = document.getElementById('blocksContainer');
            if (!currentDay.blocks || currentDay.blocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">No hay bloques.</p>';
                return;
            }
            const iconMap = { 'movilidad': 'üì±', 'core': 'üü°', 'fuerza-inferior': 'üîµ', 'fuerza-superior': 'üü£' };
            container.innerHTML = currentDay.blocks.map(function(block, blockIndex) {
                const exercises = block.exercises.map(function(ex, exIndex) {
                    return '<div class="exercise">' +
                        '<div class="exercise-header">' +
                        '<div class="exercise-name">' + (ex.isPrincipal ? '‚≠ê ' : '') + ex.name + '</div>' +
                        '<div style="display:flex;gap:4px;">' +
                        '<button class="btn btn-secondary btn-sm" onclick="editExercise(' + blockIndex + ',' + exIndex + ')" style="padding:4px 8px;">‚úèÔ∏è</button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="deleteExercise(' + blockIndex + ',' + exIndex + ')" style="padding:4px 8px;">üóëÔ∏è</button></div></div>' +
                        '<div class="exercise-inputs">' +
                        '<div class="exercise-input-group"><label class="exercise-input-label">Series</label><input type="number" class="exercise-input" value="' + (ex.series || '') + '" onchange="updateExercise(' + blockIndex + ',' + exIndex + ',\'series\',this.value)" min="1" /></div>' +
                        '<div class="exercise-input-group"><label class="exercise-input-label">Reps</label><input type="text" class="exercise-input" value="' + (ex.reps || '') + '" onchange="updateExercise(' + blockIndex + ',' + exIndex + ',\'reps\',this.value)" /></div>' +
                        '<div class="exercise-input-group"><label class="exercise-input-label">Peso (kg)</label><input type="number" class="exercise-input" value="' + (ex.weight || '') + '" onchange="updateExercise(' + blockIndex + ',' + exIndex + ',\'weight\',this.value)" step="0.5" /></div>' +
                        '<div class="exercise-input-group"><label class="exercise-input-label">RPE</label><input type="number" class="exercise-input" value="' + (ex.rpe || '') + '" onchange="updateExercise(' + blockIndex + ',' + exIndex + ',\'rpe\',this.value)" min="1" max="10" step="0.5" /></div></div>' +
                        (ex.isPrincipal ? '<div style="margin-top:12px;"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;font-weight:700;color:var(--primary-blue);"><input type="checkbox" ' + (ex.isPR ? 'checked' : '') + ' onchange="updateExercise(' + blockIndex + ',' + exIndex + ',\'isPR\',this.checked)" /> üèÜ R√©cord Personal</label></div>' : '') +
                        '</div>';
                }).join('');

                return '<div class="block block-type-' + block.type + '">' +
                    '<div class="block-header">' +
                    '<div class="block-title"><div class="block-icon">' + (iconMap[block.type] || 'üìã') + '</div>' + block.name + '</div>' +
                    '<div style="display:flex;gap:8px;">' +
                    '<button class="btn btn-secondary btn-sm" onclick="currentBlockForExercise=' + blockIndex + '; editingExercise=null; document.getElementById(\'exerciseModalTitle\').textContent=\'‚ûï Nuevo Ejercicio\'; openModal(\'addExercise\')">‚ûï Ejercicio</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="editBlock(' + blockIndex + ')">‚úèÔ∏è</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="deleteBlock(' + blockIndex + ')">üóëÔ∏è</button></div></div>' +
                    exercises + '</div>';
            }).join('');
        }

        function addBlock(e) {
            e.preventDefault();
            if (!currentDay) { alert('Seleccion√° un d√≠a'); return; }
            if (!currentDay.blocks) currentDay.blocks = [];
            currentDay.blocks.push({ name: document.getElementById('blockName').value, type: document.getElementById('blockType').value, exercises: [] });
            syncStudentData();
            saveToSheets();
            loadTrainingDay();
            closeModal('addBlock');
            e.target.reset();
        }

        function deleteBlock(blockIndex) {
            if (!confirm('¬øEliminar bloque?')) return;
            currentDay.blocks.splice(blockIndex, 1);
            syncStudentData();
            saveToSheets();
            loadTrainingDay();
        }

        function editBlock(blockIndex) {
            const newName = prompt('Nuevo nombre:', currentDay.blocks[blockIndex].name);
            if (!newName) return;
            currentDay.blocks[blockIndex].name = newName;
            syncStudentData();
            saveToSheets();
            loadTrainingDay();
        }

        function addExercise(e) {
            e.preventDefault();
            if (currentBlockForExercise === null) { alert('Error: no hay bloque'); return; }

            const exercise = {
                name: document.getElementById('exerciseName').value,
                series: parseInt(document.getElementById('exerciseSeries').value),
                reps: document.getElementById('exerciseReps').value,
                isPrincipal: document.getElementById('exerciseIsPrincipal').checked,
                weight: null, rpe: null, isPR: false
            };

            if (!exerciseDatabase.includes(exercise.name)) {
                exerciseDatabase.push(exercise.name);
                localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
                updateExercisesList();
            }

            if (editingExercise !== null) {
                // Modo edici√≥n
                currentDay.blocks[editingExercise.blockIndex].exercises[editingExercise.exIndex] = exercise;
                editingExercise = null;
            } else {
                currentDay.blocks[currentBlockForExercise].exercises.push(exercise);
            }

            syncStudentData();
            saveToSheets();
            loadTrainingDay();
            closeModal('addExercise');
            e.target.reset();
            document.getElementById('exerciseIsPrincipal').checked = false;
            currentBlockForExercise = null;
        }

        function editExercise(blockIndex, exIndex) {
            const ex = currentDay.blocks[blockIndex].exercises[exIndex];
            editingExercise = { blockIndex: blockIndex, exIndex: exIndex };
            currentBlockForExercise = blockIndex;
            document.getElementById('exerciseName').value = ex.name;
            document.getElementById('exerciseSeries').value = ex.series;
            document.getElementById('exerciseReps').value = ex.reps;
            document.getElementById('exerciseIsPrincipal').checked = ex.isPrincipal;
            document.getElementById('exerciseModalTitle').textContent = '‚úèÔ∏è Editar Ejercicio';
            openModal('addExercise');
        }

        function updateExercise(blockIndex, exIndex, field, value) {
            if (field === 'isPR') {
                currentDay.blocks[blockIndex].exercises[exIndex][field] = value;
            } else {
                const num = parseFloat(value);
                currentDay.blocks[blockIndex].exercises[exIndex][field] = isNaN(num) ? value : num;
            }
            syncStudentData();
        }

        function deleteExercise(blockIndex, exIndex) {
            if (!confirm('¬øEliminar ejercicio?')) return;
            currentDay.blocks[blockIndex].exercises.splice(exIndex, 1);
            syncStudentData();
            saveToSheets();
            loadTrainingDay();
        }

        function updateExercisesList() {
            document.getElementById('exercisesList').innerHTML = exerciseDatabase.map(function(ex) { return '<option value="' + ex + '">'; }).join('');
        }

        // ================================================
        // SAVE SESSION
        // ================================================
        function saveSession() {
            if (!currentStudent || !currentDay) { alert('Seleccion√° atleta y d√≠a'); return; }
            const date = document.getElementById('sessionDate').value;
            if (!date) { alert('Ingres√° la fecha'); return; }
            const bodyWeight = parseFloat(document.getElementById('bodyWeight').value);

            let totalVolume = 0, totalRPE = 0, rpeCount = 0, prsCount = 0;
            const sessionBlocks = JSON.parse(JSON.stringify(currentDay.blocks));
            sessionBlocks.forEach(function(block) {
                block.exercises.forEach(function(ex) {
                    if (ex.weight && ex.series && ex.reps) {
                        totalVolume += ex.weight * ex.series * (parseFloat(ex.reps) || 0);
                    }
                    if (ex.rpe) { totalRPE += parseFloat(ex.rpe); rpeCount++; }
                    if (ex.isPR) prsCount++;
                });
            });

            const session = {
                date: date, dayId: currentDay.id, dayName: currentDay.name, bodyWeight: bodyWeight,
                blocks: sessionBlocks, volume: Math.round(totalVolume),
                avgRPE: rpeCount > 0 ? parseFloat((totalRPE / rpeCount).toFixed(1)) : 0,
                prs: prsCount, timestamp: new Date().toISOString()
            };

            if (!currentStudent.sessions) currentStudent.sessions = [];
            currentStudent.sessions.push(session);
            syncStudentData();
            saveToSheets();
            
            alert('‚úÖ Sesi√≥n guardada!\nüìä Volumen: ' + session.volume + 'kg\n‚≠ê RPE: ' + session.avgRPE + '\nüèÜ PRs: ' + prsCount);
            
            // Reset PRs
            currentDay.blocks.forEach(function(block) { block.exercises.forEach(function(ex) { ex.isPR = false; }); });
            syncStudentData();
            loadTrainingDay();
            renderStudents();
        }

        // ================================================
        // IMPORT / EXPORT
        // ================================================
        let importedCompleteData = [];

        function handleCompleteImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { parseCompleteData(e.target.result); };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') { inQuotes = !inQuotes; }
                else if (line[i] === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else { current += line[i]; }
            }
            result.push(current.trim());
            return result;
        }

        function parseCompleteData(text) {
            importedCompleteData = [];
            const lines = text.split('\n').filter(function(l) { return l.trim(); });
            const startIndex = lines[0].toLowerCase().includes('alumno') ? 1 : 0;
            const studentsMap = {};
            
            for (let i = startIndex; i < lines.length; i++) {
                const parts = parseCSVLine(lines[i].trim());
                if (parts.length < 12) continue;
                const name = parts[0];
                if (!studentsMap[name]) {
                    studentsMap[name] = { name: name, age: parseInt(parts[1]) || 25, weight: parseFloat(parts[2]) || 70, goal: parts[3], monthlyClasses: parseInt(parts[4]) || 12, days: {} };
                }
                const student = studentsMap[name];
                const dayName = parts[5];
                if (!student.days[dayName]) student.days[dayName] = { name: dayName, blocks: {} };
                const blockName = parts[6];
                if (!student.days[dayName].blocks[blockName]) student.days[dayName].blocks[blockName] = { name: blockName, type: parts[7], exercises: [] };
                student.days[dayName].blocks[blockName].exercises.push({
                    name: parts[8], series: parseInt(parts[9]) || 3, reps: parts[10],
                    isPrincipal: parts[11].toUpperCase() === 'SI', weight: null, rpe: null, isPR: false
                });
            }
            
            importedCompleteData = Object.values(studentsMap).map(function(s) {
                return {
                    name: s.name, age: s.age, weight: s.weight, goal: s.goal, monthlyClasses: s.monthlyClasses,
                    trainingDays: Object.values(s.days).map(function(day, idx) {
                        return { id: Date.now() + idx, name: day.name, blocks: Object.values(day.blocks) };
                    })
                };
            });
            
            if (importedCompleteData.length > 0) { showCompleteImportPreview(); document.getElementById('btnImportComplete').disabled = false; }
            else alert('‚ùå No se pudieron leer datos.');
        }

        function showCompleteImportPreview() {
            document.getElementById('completeImportPreview').style.display = 'block';
            let td = 0, tb = 0, te = 0;
            importedCompleteData.forEach(function(s) { td += s.trainingDays.length; s.trainingDays.forEach(function(d) { tb += d.blocks.length; d.blocks.forEach(function(b) { te += b.exercises.length; }); }); });
            document.getElementById('completeImportCount').textContent = importedCompleteData.length + ' alumno(s), ' + td + ' d√≠as, ' + tb + ' bloques, ' + te + ' ejercicios';
            document.getElementById('completeImportPreviewBody').innerHTML = importedCompleteData.map(function(s) {
                return '<div style="margin-bottom:12px;padding:12px;background:white;border-radius:8px;border-left:4px solid var(--primary-blue);"><strong>' + s.name + '</strong> ‚Äî ' + s.trainingDays.length + ' d√≠a(s)</div>';
            }).join('');
        }

        function processCompleteImport() {
            let imported = 0;
            importedCompleteData.forEach(function(data) {
                const student = { id: Date.now() + imported, name: data.name, age: data.age, weight: data.weight, goal: data.goal, monthlyClasses: data.monthlyClasses, trainingDays: data.trainingDays, sessions: [], attendance: {}, createdAt: new Date().toISOString() };
                student.trainingDays.forEach(function(day) { day.blocks.forEach(function(block) { block.exercises.forEach(function(ex) { if (!exerciseDatabase.includes(ex.name)) exerciseDatabase.push(ex.name); }); }); });
                students.push(student);
                imported++;
            });
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            saveToSheets();
            renderStudents();
            closeModal('importComplete');
            importedCompleteData = [];
            document.getElementById('importCompleteFile').value = '';
            document.getElementById('completeImportPreview').style.display = 'none';
            document.getElementById('btnImportComplete').disabled = true;
            alert('‚úÖ ' + imported + ' alumno(s) importado(s)!');
        }

        let importedPlanData = [];

        function handlePlanImport(event) {
            if (!currentStudent) { alert('Seleccion√° un atleta'); return; }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { parsePlanData(e.target.result); };
            reader.readAsText(file);
        }

        function parsePlanData(text) {
            importedPlanData = [];
            const lines = text.split('\n').filter(function(l) { return l.trim(); });
            const startIndex = lines[0].toLowerCase().includes('dia') ? 1 : 0;
            const daysMap = {};
            for (let i = startIndex; i < lines.length; i++) {
                const parts = parseCSVLine(lines[i].trim());
                if (parts.length < 7) continue;
                if (!daysMap[parts[0]]) daysMap[parts[0]] = { name: parts[0], blocks: {} };
                if (!daysMap[parts[0]].blocks[parts[1]]) daysMap[parts[0]].blocks[parts[1]] = { name: parts[1], type: parts[2], exercises: [] };
                daysMap[parts[0]].blocks[parts[1]].exercises.push({ name: parts[3], series: parseInt(parts[4]) || 3, reps: parts[5], isPrincipal: parts[6].toUpperCase() === 'SI', weight: null, rpe: null, isPR: false });
            }
            importedPlanData = Object.values(daysMap).map(function(day, idx) { return { id: Date.now() + idx, name: day.name, blocks: Object.values(day.blocks) }; });
            if (importedPlanData.length > 0) { showPlanImportPreview(); document.getElementById('btnImportPlan').disabled = false; }
            else alert('‚ùå No se pudieron leer datos.');
        }

        function showPlanImportPreview() {
            document.getElementById('planImportPreview').style.display = 'block';
            let tb = 0, te = 0;
            importedPlanData.forEach(function(d) { tb += d.blocks.length; d.blocks.forEach(function(b) { te += b.exercises.length; }); });
            document.getElementById('planImportCount').textContent = importedPlanData.length + ' d√≠a(s), ' + tb + ' bloques, ' + te + ' ejercicios';
            document.getElementById('planImportPreviewBody').innerHTML = importedPlanData.map(function(d) { return '<div style="margin-bottom:8px;padding:10px;background:var(--bg-gray);border-radius:8px;"><strong>' + d.name + '</strong> ‚Äî ' + d.blocks.length + ' bloque(s)</div>'; }).join('');
        }

        function processPlanImport() {
            if (!currentStudent || importedPlanData.length === 0) return;
            if (!confirm('¬øImportar estos d√≠as?')) return;
            if (!currentStudent.trainingDays) currentStudent.trainingDays = [];
            importedPlanData.forEach(function(day) {
                currentStudent.trainingDays.push(day);
                day.blocks.forEach(function(block) { block.exercises.forEach(function(ex) { if (!exerciseDatabase.includes(ex.name)) exerciseDatabase.push(ex.name); }); });
            });
            syncStudentData();
            localStorage.setItem('gymTracker_exercises', JSON.stringify(exerciseDatabase));
            updateExercisesList();
            saveToSheets();
            renderTrainingDays();
            closeModal('importPlan');
            importedPlanData = [];
            document.getElementById('importPlanFile').value = '';
            document.getElementById('planImportPreview').style.display = 'none';
            document.getElementById('btnImportPlan').disabled = true;
            alert('‚úÖ ' + currentStudent.trainingDays.length + ' d√≠a(s) importado(s)!');
        }

        function exportAllDays() {
            if (!currentStudent || !currentStudent.trainingDays || currentStudent.trainingDays.length === 0) { alert('No hay d√≠as para exportar'); return; }
            let csv = "Dia,Bloque,TipoBloque,Ejercicio,Series,Reps,Principal\n";
            currentStudent.trainingDays.forEach(function(day) { day.blocks.forEach(function(block) { block.exercises.forEach(function(ex) { csv += [day.name, block.name, block.type, ex.name, ex.series || '', ex.reps || '', ex.isPrincipal ? 'SI' : 'NO'].join(',') + '\n'; }); }); });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', 'plan_' + currentStudent.name.replace(/\s+/g, '_') + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================================================
        // M√âTRICAS HELPERS
        // ================================================
        function calculateStreak(sessions) {
            if (!sessions || sessions.length === 0) return 0;
            const sorted = sessions.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
            let streak = 0, last = new Date();
            for (let i = 0; i < sorted.length; i++) {
                const d = new Date(sorted[i].date);
                if (Math.floor((last - d) / 86400000) <= 3) { streak++; last = d; } else break;
            }
            return streak;
        }

        function getMostTrainedDay(dayStats) {
            let maxDay = '-', maxCount = 0;
            for (let day in dayStats) { if (dayStats[day] > maxCount) { maxCount = dayStats[day]; maxDay = day; } }
            return maxDay;
        }

        function generateWeeklySummary(sessions) {
            if (!sessions || sessions.length === 0) return '<p style="opacity:0.8;">No hay sesiones registradas.</p>';
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 86400000);
            const weekSessions = sessions.filter(function(s) { return new Date(s.date) >= weekAgo; });
            if (weekSessions.length === 0) return '<p style="opacity:0.8;">No hay sesiones en los √∫ltimos 7 d√≠as.</p>';

            const weekVolume = weekSessions.reduce(function(sum, s) { return sum + (s.volume || 0); }, 0);
            const weekPRs = weekSessions.reduce(function(sum, s) { return sum + (s.prs || 0); }, 0);
            const avgRPE = (weekSessions.reduce(function(sum, s) { return sum + (s.avgRPE || 0); }, 0) / weekSessions.length).toFixed(1);

            const twoWeeksAgo = new Date(today.getTime() - 14 * 86400000);
            const prevVol = sessions.filter(function(s) { const d = new Date(s.date); return d >= twoWeeksAgo && d < weekAgo; }).reduce(function(sum, s) { return sum + (s.volume || 0); }, 0);

            let summary = '<div style="line-height:2;">';
            summary += '<div>‚úì <strong>' + weekSessions.length + ' sesiones</strong> esta semana';
            if (weekSessions.length >= 3) summary += ' ‚Äî <strong style="color:#10B981;">Excelente consistencia</strong>';
            summary += '</div>';
            if (prevVol > 0) { const chg = ((weekVolume - prevVol) / prevVol * 100).toFixed(0); summary += '<div>' + (weekVolume >= prevVol ? 'üìà +' : 'üìâ ') + chg + '% volumen vs semana anterior</div>'; }
            else summary += '<div>üì¶ <strong>' + (weekVolume / 1000).toFixed(1) + ' ton</strong> esta semana</div>';
            if (weekPRs > 0) summary += '<div>üèÜ <strong>' + weekPRs + ' PR(s)</strong></div>';
            if (avgRPE >= 8.5) summary += '<div>üî• Intensidad alta (RPE ' + avgRPE + ')</div>';
            else if (avgRPE >= 7) summary += '<div>‚úì Intensidad √≥ptima (RPE ' + avgRPE + ')</div>';
            else if (avgRPE > 0) summary += '<div>üí° Intensidad moderada (RPE ' + avgRPE + ')</div>';
            summary += '</div>';
            return summary;
        }

        // ================================================
        // DASHBOARD
        // ================================================
        function renderDashboard() {
            if (!currentStudent) { document.getElementById('dashboardContent').innerHTML = '<p style="text-align:center;color:var(--text-gray);padding:40px;">Seleccion√° un atleta</p>'; return; }
            document.getElementById('dashboardStudentName').textContent = currentStudent.name;

            const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const monthSessions = currentStudent.sessions ? currentStudent.sessions.filter(function(s) { const d = new Date(s.date); return d >= monthStart && d <= monthEnd; }) : [];
            const attended = monthSessions.length;
            const pct = currentStudent.monthlyClasses > 0 ? Math.round((attended / currentStudent.monthlyClasses) * 100) : 0;

            if (monthSessions.length === 0) {
                document.getElementById('dashboardContent').innerHTML =
                    '<div class="attendance-section"><div class="attendance-header"><div class="attendance-title">üìÖ Progreso de Asistencia</div><div>' + attended + ' / ' + currentStudent.monthlyClasses + ' clases</div></div>' +
                    '<div style="background:var(--bg-gray);border-radius:12px;padding:24px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><span style="font-size:13px;font-weight:700;color:var(--text-gray);text-transform:uppercase;">Sesiones Completadas</span><span style="font-family:Archivo Black;font-size:24px;color:var(--primary-blue);">' + pct + '%</span></div>' +
                    '<div class="goal-progress-bar"><div class="goal-progress-fill" style="width:' + Math.min(pct, 100) + '%"></div></div></div></div>' +
                    '<div class="card" style="margin-top:24px;"><p style="text-align:center;color:var(--text-gray);padding:40px;">No hay sesiones este mes</p></div>';
                return;
            }

            const vol = monthSessions.reduce(function(s, x) { return s + (x.volume || 0); }, 0);
            const prs = monthSessions.reduce(function(s, x) { return s + (x.prs || 0); }, 0);
            const rpe = (monthSessions.reduce(function(s, x) { return s + (x.avgRPE || 0); }, 0) / monthSessions.length).toFixed(1);

            const prevStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            const prevEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0);
            const prevVol = (currentStudent.sessions || []).filter(function(s) { const d = new Date(s.date); return d >= prevStart && d <= prevEnd; }).reduce(function(s, x) { return s + (x.volume || 0); }, 0);

            const dayStats = {};
            monthSessions.forEach(function(s) { if (s.dayName) dayStats[s.dayName] = (dayStats[s.dayName] || 0) + 1; });

            let html = '<div class="attendance-section"><div class="attendance-header"><div class="attendance-title">üìÖ Progreso de Asistencia</div><div>' + attended + ' / ' + currentStudent.monthlyClasses + ' clases</div></div>' +
                '<div style="background:var(--bg-gray);border-radius:12px;padding:24px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><span style="font-size:13px;font-weight:700;color:var(--text-gray);text-transform:uppercase;">Sesiones Completadas</span><span style="font-family:Archivo Black;font-size:24px;color:var(--primary-blue);">' + pct + '%</span></div>' +
                '<div class="goal-progress-bar"><div class="goal-progress-fill" style="width:' + Math.min(pct, 100) + '%"></div></div>' +
                '<div style="font-size:12px;color:var(--text-gray);margin-top:12px;">' + Object.entries(dayStats).map(function(e) { return e[0] + ': ' + e[1]; }).join(' ‚Ä¢ ') + '</div></div></div>';

            html += '<div class="card" style="background:linear-gradient(135deg,#2563EB,#1E40AF);color:white;margin-bottom:24px;"><h3 style="font-family:Archivo Black;font-size:18px;margin-bottom:20px;text-transform:uppercase;">üí¨ Resumen Semanal</h3><div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:12px;">' + generateWeeklySummary(monthSessions) + '</div></div>';

            html += '<div class="month-comparison"><div class="month-box"><div class="month-label">Mes Anterior</div><div class="month-value">' + (prevVol / 1000).toFixed(1) + ' ton</div></div><div class="month-box current"><div class="month-label">Mes Actual</div><div class="month-value">' + (vol / 1000).toFixed(1) + ' ton</div></div><div class="month-box"><div class="month-label">Pr√≥ximo</div><div class="month-value">Objetivo</div></div></div>';

            html += '<div class="metrics-grid">' +
                '<div class="metric-card"><div class="metric-label">Volumen Total</div><div class="metric-value">' + vol.toLocaleString() + '</div><div class="metric-detail">kg este mes</div>' + (prevVol > 0 ? '<div class="metric-change ' + (vol >= prevVol ? 'positive' : 'negative') + '">' + (vol >= prevVol ? '+' : '') + ((vol - prevVol) / prevVol * 100).toFixed(1) + '% vs anterior</div>' : '') + '</div>' +
                '<div class="metric-card"><div class="metric-label">Records Rotos</div><div class="metric-value">' + prs + '</div><div class="metric-detail">PRs este mes</div></div>' +
                '<div class="metric-card"><div class="metric-label">RPE Promedio</div><div class="metric-value">' + rpe + '</div><div class="metric-detail">' + (rpe < 7 ? 'Suave' : rpe < 8.5 ? '√ìptimo' : 'Intenso') + '</div></div>' +
                '<div class="metric-card"><div class="metric-label">Consistencia</div><div class="metric-value">' + pct + '%</div><div class="metric-detail">' + (pct >= 90 ? 'Excelente' : pct >= 75 ? 'Bueno' : 'Mejorable') + '</div></div>' +
                '<div class="metric-card"><div class="metric-label">üí™ Volumen/Sesi√≥n</div><div class="metric-value">' + (monthSessions.length > 0 ? Math.round(vol / monthSessions.length) : 0) + '</div><div class="metric-detail">kg promedio</div></div>' +
                '<div class="metric-card"><div class="metric-label">üî• Racha</div><div class="metric-value">' + calculateStreak(currentStudent.sessions) + '</div><div class="metric-detail">d√≠as seguidos</div></div>' +
                '<div class="metric-card"><div class="metric-label">üìä D√≠a Favorito</div><div class="metric-value">' + getMostTrainedDay(dayStats) + '</div><div class="metric-detail">m√°s entrenado</div></div>' +
                '<div class="metric-card"><div class="metric-label">‚è±Ô∏è √öltima Sesi√≥n</div><div class="metric-value">' + new Date(monthSessions[monthSessions.length - 1].date + 'T12:00:00').toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit'}) + '</div><div class="metric-detail">' + (monthSessions[monthSessions.length - 1].dayName || '-') + '</div></div>' +
                '</div>';

            html += '<div class="card"><h3 style="font-family:Archivo Black;font-size:18px;margin-bottom:20px;text-transform:uppercase;">üìã Historial de Sesiones</h3>' +
                '<table class="progress-table"><thead><tr><th>Fecha</th><th>D√≠a</th><th>Volumen</th><th>RPE</th><th>PRs</th></tr></thead><tbody>' +
                monthSessions.slice().reverse().map(function(s) {
                    return '<tr><td>' + new Date(s.date + 'T12:00:00').toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit'}) + '</td><td><strong>' + (s.dayName || 'Plan') + '</strong></td><td>' + s.volume.toLocaleString() + ' kg</td><td>' + s.avgRPE + '</td><td>' + (s.prs > 0 ? 'üèÜ ' + s.prs : '-') + '</td></tr>';
                }).join('') + '</tbody></table></div>';

            document.getElementById('dashboardContent').innerHTML = html;
        }
    </script>
</body>
</html>
